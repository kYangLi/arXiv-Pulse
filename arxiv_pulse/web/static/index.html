<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>arXiv Pulse - 学术文献追踪</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="libs/element-plus/index.css">
    <style>
        [v-cloak] { display: none; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a87;
            --primary-dark: #0f1f33;
            --accent: #c9a227;
            --accent-light: #e6c458;
            --bg-main: #faf9f7;
            --bg-card: #ffffff;
            --bg-subtle: #f5f3f0;
            --text-primary: #2c3e50;
            --text-secondary: #5a6c7d;
            --text-muted: #8492a6;
            --border-light: #e8e6e1;
            --border-medium: #d4d0c8;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: var(--bg-main); 
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        h1, h2, h3, h4 { font-family: Georgia, 'Times New Roman', serif; }
        
        /* Setup Container */
        .setup-container { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(180deg, #f8f7f4 0%, #e8e5df 100%);
            padding: 20px;
        }
        .setup-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            padding: 48px; 
            width: 640px; 
            max-width: 100%; 
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
        }
        .setup-card h1 { 
            text-align: center; 
            margin-bottom: 8px; 
            color: var(--primary);
            font-size: 28px;
            font-weight: 700;
        }
        .setup-card .subtitle { 
            text-align: center; 
            color: var(--text-muted); 
            margin-bottom: 36px;
            font-size: 14px;
        }
        .setup-steps { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 36px; 
            gap: 12px; 
        }
        .setup-step { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .setup-step.active { background: var(--primary); color: white; }
        .setup-step.done { background: var(--accent); color: white; }
        .setup-step.pending { background: var(--bg-subtle); color: var(--text-muted); }
        
        .field-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
            max-height: 400px; 
            overflow-y: auto; 
            padding: 12px; 
            border: 1px solid var(--border-light); 
            border-radius: var(--radius-md); 
            background: var(--bg-subtle);
        }
        .field-item { 
            padding: 12px 14px; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            transition: all 0.2s ease; 
            border: 2px solid transparent; 
            background: var(--bg-card);
        }
        .field-item:hover { 
            border-color: var(--border-medium);
            transform: translateY(-1px);
        }
        .field-item.selected { 
            background: #f0f7ff; 
            border-color: var(--primary); 
        }
        .field-item.has-papers { 
            border-color: var(--accent); 
        }
        .field-item.has-papers.selected { 
            border-color: var(--primary); 
            background: #f0f7ff; 
        }
        .field-item .name { 
            font-weight: 600; 
            color: var(--text-primary); 
            margin-bottom: 4px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 14px;
        }
        .field-item .desc { 
            font-size: 12px; 
            color: var(--text-muted); 
            line-height: 1.4;
        }
        .paper-badge { 
            background: var(--accent); 
            color: white; 
            font-size: 10px; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-weight: 500; 
        }
        
        /* App Container */
        .app-container { min-height: 100vh; }
        
        /* Home Page */
        .home-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: linear-gradient(180deg, #f8f7f4 0%, #e8e5df 100%);
        }
        .home-brand {
            text-align: center;
            margin-bottom: 48px;
        }
        .home-brand h1 {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -1px;
        }
        .home-brand p {
            color: var(--text-muted);
            font-size: 16px;
        }
        .home-search-box {
            width: 100%;
            max-width: 680px;
            margin-bottom: 24px;
        }
        .home-search-input {
            position: relative;
        }
        .home-search-input .el-input__wrapper {
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .home-search-input .el-input__wrapper:hover,
        .home-search-input .el-input__wrapper.is-focus {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg), 0 0 0 4px rgba(30, 58, 95, 0.1);
        }
        .home-search-input .el-input__inner {
            font-size: 17px;
            height: 32px;
        }
        .home-search-input .el-input__inner::placeholder {
            font-size: 17px;
        }
        .home-search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }
        .home-stats {
            display: flex;
            gap: 40px;
            margin-top: 32px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .home-stats span {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .home-hints {
            margin-top: 24px;
            color: var(--text-muted);
            font-size: 13px;
            text-align: center;
        }
        .home-nav {
            display: flex;
            gap: 16px;
            margin-top: 40px;
        }
        .home-nav .el-button {
            padding: 12px 24px;
        }
        
        .header { 
            background: var(--primary); 
            color: white; 
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }
        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 40px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header-brand h1 { 
            font-size: 22px; 
            margin-bottom: 2px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .header-brand p { 
            opacity: 0.7; 
            font-size: 13px; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .header-actions { display: flex; gap: 12px; }
        .header-actions .el-button {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: white;
        }
        .header-actions .el-button:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }
        
        .main-content { 
            padding: 32px 40px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* Stats Row */
        .stats-row { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 28px; 
        }
        .stat-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        .stat-card h3 { 
            color: var(--text-muted); 
            font-size: 12px; 
            margin-bottom: 12px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
        }
        .stat-card .value { 
            font-size: 32px; 
            font-weight: 700; 
            color: var(--primary);
            font-family: Georgia, 'Times New Roman', serif;
        }
        
        /* Tabs */
        .tabs-container { margin-bottom: 24px; }
        .el-tabs__item {
            font-size: 15px;
            font-weight: 500;
        }
        .el-tabs__item.is-active {
            color: var(--primary);
        }
        .el-tabs__active-bar {
            background-color: var(--primary);
        }
        
        /* Settings Section */
        .settings-section { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            margin-bottom: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }
        .settings-section h3 { 
            margin-bottom: 20px; 
            color: var(--primary); 
            font-size: 16px;
            border-bottom: 1px solid var(--border-light); 
            padding-bottom: 12px;
            font-weight: 600;
        }
        .settings-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; }
        .settings-row .el-input { flex: 1; min-width: 200px; }
        
        /* Paper Card - Academic Style */
        .paper-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px 28px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }
        .paper-card:hover { 
            box-shadow: var(--shadow-md); 
            border-color: var(--border-medium);
        }
        .paper-card.paper-selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f8faff 0%, var(--bg-card) 100%);
        }
        .paper-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }
        .paper-header .el-checkbox {
            margin-top: 4px;
        }
        .paper-header .paper-title {
            flex: 1;
        }
        .paper-title { 
            color: var(--primary); 
            font-size: 17px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-bottom: 8px; 
            line-height: 1.5;
            font-family: Georgia, 'Times New Roman', serif;
            transition: color 0.2s;
        }
        .paper-title:hover { 
            color: var(--primary-light); 
        }
        .paper-title-cn { 
            color: var(--text-secondary); 
            font-size: 15px; 
            margin-bottom: 12px; 
            line-height: 1.5;
            font-style: italic;
        }
        .paper-meta { 
            color: var(--text-muted); 
            font-size: 13px; 
            margin-bottom: 12px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 16px; 
        }
        .paper-meta-item { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }
        .paper-category { 
            background: var(--bg-subtle); 
            padding: 4px 12px; 
            border-radius: 4px; 
            font-size: 12px; 
            color: var(--text-secondary);
            font-style: italic;
        }
        .paper-relevance { font-size: 14px; }
        .paper-relevance .star { color: var(--accent); }
        .paper-abstract-preview { 
            color: var(--text-secondary); 
            font-size: 14px; 
            line-height: 1.7; 
            margin-bottom: 16px; 
        }
        .paper-actions { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }
        .paper-actions .el-button {
            font-size: 13px;
        }
        
        .paper-detail { 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 1px solid var(--border-light); 
        }
        .ai-summary-section {
            background: linear-gradient(135deg, #f8f7f4 0%, #fff9f0 100%);
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            border-left: 3px solid var(--primary);
        }
        .ai-summary-section h4 {
            color: var(--primary);
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .ai-summary-section .summary-text {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.8;
        }
        .paper-keywords {
            margin-bottom: 20px;
        }
        .paper-keywords h4 {
            color: var(--primary);
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .key-findings { 
            background: #fffbf0; 
            padding: 16px 20px; 
            border-radius: var(--radius-sm); 
            margin-bottom: 20px;
            border-left: 3px solid var(--accent);
        }
        .key-findings h4 { 
            color: var(--accent); 
            font-size: 14px; 
            margin-bottom: 12px; 
            font-weight: 600;
        }
        .key-findings ul { margin: 0; padding-left: 20px; }
        .key-findings li { 
            color: var(--text-secondary); 
            font-size: 13px; 
            line-height: 1.7; 
            margin-bottom: 6px; 
        }
        .paper-figure { 
            margin-bottom: 20px; 
            text-align: center; 
        }
        .paper-figure img { 
            max-width: 100%; 
            max-height: 400px; 
            border-radius: var(--radius-md); 
            cursor: pointer; 
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease;
        }
        .paper-figure img:hover { transform: scale(1.02); }
        .abstract-section { margin-bottom: 20px; }
        .abstract-section h4 { 
            color: var(--primary); 
            font-size: 14px; 
            margin-bottom: 12px; 
            font-weight: 600;
        }
        .abstract-section p { 
            color: var(--text-secondary); 
            font-size: 14px; 
            line-height: 1.8; 
        }
        .abstract-section .translation { 
            background: #f5faf5; 
            padding: 16px 20px; 
            border-radius: var(--radius-sm); 
            margin-top: 16px;
            border-left: 3px solid #67c23a;
        }
        
        /* Search Options */
        .search-options { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            margin-bottom: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }
        .search-options-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; }
        .search-options-row .el-input { flex: 1; min-width: 300px; }
        
        /* Recent Header */
        .recent-header { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 20px 24px; 
            margin-bottom: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 16px; 
        }
        .recent-header .status-info { display: flex; align-items: center; gap: 20px; }
        .recent-header .status-info .label { color: var(--text-muted); font-size: 13px; }
        .recent-header .status-info .value { color: var(--text-primary); font-size: 13px; font-weight: 500; }
        
        /* Sync Status */
        .sync-status-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        .sync-status-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 20px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            text-align: center;
        }
        .sync-status-card .icon { font-size: 28px; margin-bottom: 10px; }
        .sync-status-card .label { color: var(--text-muted); font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .sync-status-card .value { color: var(--text-primary); font-size: 18px; font-weight: 600; }
        .sync-status-card .value.success { color: #67c23a; }
        .sync-status-card .value.warning { color: var(--accent); }
        
        /* Charts */
        .charts-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 24px; 
            margin-bottom: 24px; 
        }
        .chart-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }
        .chart-card h3 { 
            margin-bottom: 20px; 
            color: var(--primary); 
            font-size: 15px;
            font-weight: 600;
        }
        .chart-container { height: 280px; }
        
        /* Sync Options */
        .sync-options { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            margin-bottom: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }
        .sync-options h3 { 
            margin-bottom: 20px; 
            color: var(--primary); 
            font-size: 15px;
            font-weight: 600;
        }
        
        /* Logs */
        .logs-container { 
            background: var(--primary-dark); 
            border-radius: var(--radius-sm); 
            padding: 16px; 
            max-height: 250px; 
            overflow-y: auto; 
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }
        .log-line { 
            color: #a0aec0; 
            margin-bottom: 6px; 
            line-height: 1.5;
        }
        .log-line.success { color: #68d391; }
        .log-line.error { color: #fc8181; }
        
        /* Collections */
        .collections-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .collection-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            cursor: pointer; 
            transition: all 0.3s;
        }
        .collection-card:hover { 
            box-shadow: var(--shadow-md); 
            transform: translateY(-2px);
            border-color: var(--border-medium);
        }
        .collection-card .color-bar { 
            height: 4px; 
            border-radius: 2px; 
            margin-bottom: 16px; 
        }
        .collection-card h4 { 
            color: var(--text-primary); 
            font-size: 16px; 
            margin-bottom: 8px; 
            font-weight: 600;
        }
        .collection-card p { 
            color: var(--text-muted); 
            font-size: 13px; 
            margin-bottom: 12px; 
            line-height: 1.5;
        }
        .collection-card .count { 
            color: var(--text-secondary); 
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Empty State */
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--text-muted); 
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { margin-bottom: 8px; color: var(--text-secondary); font-size: 16px; }
        .empty-state p { font-size: 14px; }
        
        /* Settings Drawer */
        .settings-drawer .el-drawer__header {
            margin-bottom: 0;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
        }
        .settings-drawer .el-drawer__title {
            font-family: Georgia, 'Times New Roman', serif;
            font-weight: 600;
            color: var(--primary);
        }
        .settings-drawer .el-drawer__body {
            padding: 0;
        }
        
        /* Export Bar */
        .export-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
            .collections-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .main-content { padding: 20px; }
            .header-inner { padding: 16px 20px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .sync-status-grid { grid-template-columns: repeat(2, 1fr); }
            .collections-grid { grid-template-columns: 1fr; }
            .field-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="showSetup" class="setup-container">
            <div class="setup-card">
                <h1>arXiv Pulse</h1>
                <p class="subtitle">智能学术文献追踪与分析系统</p>
                
                <div class="setup-steps">
                    <div class="setup-step" :class="setupStep > 1 ? 'done' : (setupStep === 1 ? 'active' : 'pending')">1</div>
                    <div class="setup-step" :class="setupStep > 2 ? 'done' : (setupStep === 2 ? 'active' : 'pending')">2</div>
                    <div class="setup-step" :class="setupStep > 3 ? 'done' : (setupStep === 3 ? 'active' : 'pending')">3</div>
                    <div class="setup-step" :class="setupStep >= 4 ? 'active' : 'pending'">4</div>
                </div>

                <div v-if="setupStep === 1">
                    <h3 style="margin-bottom: 24px; color: var(--primary); font-size: 18px;">API 配置</h3>
                    <el-form label-position="top">
                        <el-form-item label="API Base URL">
                            <el-input v-model="setupConfig.ai_base_url" placeholder="https://api.openai.com/v1" />
                        </el-form-item>
                        <el-form-item label="API Key">
                            <el-input v-model="setupConfig.ai_api_key" type="password" show-password placeholder="输入你的 API Key" />
                        </el-form-item>
                        <el-form-item label="模型名称">
                            <el-select v-model="setupConfig.ai_model" filterable allow-create style="width: 100%;">
                                <el-option label="DeepSeek-V3.2" value="DeepSeek-V3.2" />
                                <el-option label="gpt-4o" value="gpt-4o" />
                                <el-option label="gpt-4-turbo" value="gpt-4-turbo" />
                                <el-option label="gpt-3.5-turbo" value="gpt-3.5-turbo" />
                            </el-select>
                        </el-form-item>
                    </el-form>
                    <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                        <el-button @click="testSetupAI" :loading="testingAI">测试连接</el-button>
                        <el-button type="primary" @click="setupStep = 2">下一步</el-button>
                    </div>
                </div>

                <div v-if="setupStep === 2">
                    <h3 style="margin-bottom: 8px; color: var(--primary); font-size: 18px;">研究领域</h3>
                    <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">选择你感兴趣的研究领域（可多选）</p>
                    <div class="field-grid">
                        <div v-for="(field, key) in researchFields" :key="key" 
                             class="field-item" :class="{ selected: setupConfig.selected_fields.includes(key) }"
                             @click="toggleSetupField(key)">
                            <div class="name">{{ field.name }}</div>
                            <div class="desc">{{ field.description }}</div>
                        </div>
                    </div>
                    <div style="margin-top: 24px; display: flex; justify-content: space-between;">
                        <el-button @click="setupStep = 1">上一步</el-button>
                        <el-button type="primary" @click="setupStep = 3" :disabled="setupConfig.selected_fields.length === 0">
                            下一步
                        </el-button>
                    </div>
                </div>

                <div v-if="setupStep === 3">
                    <h3 style="margin-bottom: 24px; color: var(--primary); font-size: 18px;">同步设置</h3>
                    <el-form label-position="top">
                        <el-form-item label="初始同步回溯年数">
                            <el-select v-model="setupConfig.years_back" style="width: 100%;">
                                <el-option v-for="item in initYearOptions" :key="item.value" :label="item.label" :value="item.value" />
                            </el-select>
                        </el-form-item>
                    </el-form>
                    <p style="color: var(--text-muted); font-size: 13px; margin-top: 12px;">
                        已选择: {{ setupConfig.selected_fields.length }} 个研究领域
                    </p>
                    <div style="margin-top: 24px; display: flex; justify-content: space-between;">
                        <el-button @click="setupStep = 2">上一步</el-button>
                        <el-button type="primary" @click="startInitialSync" :loading="initializing">
                            开始同步
                        </el-button>
                    </div>
                </div>

                <div v-if="setupStep === 4">
                    <h3 style="margin-bottom: 20px; text-align: center; color: var(--primary);">初始化中...</h3>
                    <div style="text-align: center; margin-bottom: 20px; color: var(--text-muted); font-size: 14px;">
                        {{ waitingMessage }}
                    </div>
                    <div v-if="initProgress > 0" style="text-align: center; margin-bottom: 16px; color: var(--text-secondary);">
                        正在处理: {{ initCurrentQuery }} / {{ initTotalQueries }} 个研究领域
                    </div>
                    <el-progress v-if="initProgress > 0" :percentage="initProgress" style="margin-bottom: 24px;" />
                    <div v-if="initLogs.length > 0" class="logs-container" style="max-height: 280px;">
                        <div v-for="(log, index) in initLogs" :key="index" 
                             class="log-line" :class="log.type">
                            > {{ log.message }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else class="app-container">
            <!-- Home Page -->
            <div v-if="currentPage === 'home'" class="home-container">
                <div class="home-brand">
                    <h1>arXiv Pulse</h1>
                    <p>智能学术文献追踪与分析系统</p>
                </div>
                
                <div class="home-search-box">
                    <div class="home-search-input">
                        <el-input 
                            v-model="homeQuery" 
                            placeholder="输入 arXiv ID、网址或关键词搜索..."
                            size="large"
                            @keyup.enter="startHomeSearch"
                            clearable
                        >
                            <template #prefix>
                                <el-icon><Search /></el-icon>
                            </template>
                        </el-input>
                        <el-button 
                            class="home-search-btn" 
                            type="primary" 
                            @click="startHomeSearch" 
                            :loading="homeSearching"
                        >
                            搜索
                        </el-button>
                    </div>
                    
                    <div v-if="homeLogs.length > 0" class="logs-container" style="margin-top: 20px; max-height: 200px;">
                        <div v-for="(log, index) in homeLogs" :key="index" class="log-line" :class="log.type">
                            > {{ log.message }}
                        </div>
                    </div>
                    
                    <div v-if="homeResults.length > 0" style="margin-top: 24px;">
                        <div class="export-bar">
                            <span style="color: var(--text-secondary);">{{ homeResults.length }} 篇论文</span>
                            <el-dropdown @command="exportHome" :disabled="homeSelectedIds.length === 0">
                                <el-button type="primary" plain size="small">
                                    <el-icon><Download /></el-icon> 导出
                                </el-button>
                                <template #dropdown>
                                    <el-dropdown-menu>
                                        <el-dropdown-item command="markdown">Markdown</el-dropdown-item>
                                        <el-dropdown-item command="pdf">PDF</el-dropdown-item>
                                        <el-dropdown-item command="csv">CSV</el-dropdown-item>
                                        <el-dropdown-item command="bibtex">BibTeX</el-dropdown-item>
                                    </el-dropdown-menu>
                                </template>
                            </el-dropdown>
                        </div>
                        <paper-card 
                            v-for="paper in homeResults" 
                            :key="paper.id" 
                            :paper="paper"
                            :collections="collections"
                            :selected="homeSelectedIds.includes(paper.id)"
                            @toggle-select="toggleHomeSelect(paper.id)"
                            @add-to-collection="addToCollection"
                        />
                    </div>
                </div>
                
                <div class="home-stats">
                    <span><el-icon><Document /></el-icon> {{ stats?.papers?.total || 0 }} 篇论文</span>
                    <span><el-icon><Collection /></el-icon> {{ stats?.collections?.total || 0 }} 个论文集</span>
                    <span><el-icon><TrendCharts /></el-icon> {{ stats?.papers?.summarized || 0 }} 篇已总结</span>
                </div>
                
                <div class="home-hints">
                    支持 arXiv ID (如 2602.09790)、URL (如 https://arxiv.org/abs/2602.09790) 或关键词搜索
                </div>
                
                <div class="home-nav">
                    <el-button @click="navigateTo('recent')">
                        <el-icon><Clock /></el-icon> 最近论文
                    </el-button>
                    <el-button @click="navigateTo('sync')">
                        <el-icon><Refresh /></el-icon> 同步管理
                    </el-button>
                    <el-button @click="navigateTo('collections')">
                        <el-icon><Folder /></el-icon> 论文集
                    </el-button>
                    <el-button @click="showSettings = true" circle>
                        <el-icon><Setting /></el-icon>
                    </el-button>
                </div>
            </div>
            
            <!-- Other Pages with Header -->
            <template v-else>
                <header class="header">
                    <div class="header-inner">
                        <div class="header-brand" style="cursor: pointer;" @click="navigateTo('home')">
                            <h1>arXiv Pulse</h1>
                            <p>智能学术文献追踪</p>
                        </div>
                        <div class="header-actions">
                            <el-button @click="showSettings = true" circle>
                                <el-icon><Setting /></el-icon>
                            </el-button>
                        </div>
                    </div>
                </header>

                <main class="main-content">
                    <!-- Navigation Tabs -->
                    <div class="tabs-container">
                        <el-tabs v-model="currentPage" @tab-change="onTabChange">
                            <el-tab-pane label="最近论文" name="recent"></el-tab-pane>
                            <el-tab-pane label="同步管理" name="sync"></el-tab-pane>
                            <el-tab-pane label="论文集" name="collections"></el-tab-pane>
                        </el-tabs>
                    </div>

                <!-- Recent Papers Tab -->
                <div v-if="currentPage === 'recent'">
                    <div class="search-options" style="margin-bottom: 20px;">
                        <div class="search-options-row">
                            <el-select v-model="recentDays" placeholder="时间范围" style="width: 120px;">
                                <el-option v-for="item in daysOptions" :key="item.value" :label="item.label" :value="item.value" />
                            </el-select>
                            <el-select v-model="recentLimit" placeholder="数量限制" style="width: 120px;">
                                <el-option v-for="item in limitOptions" :key="item.value" :label="item.label" :value="item.value" />
                            </el-select>
                            <el-select v-model="recentCategories" multiple collapse-tags placeholder="领域过滤" style="width: 200px;">
                                <el-option v-for="item in categoryOptions" :key="item.value" :label="item.label" :value="item.value" />
                            </el-select>
                            <el-checkbox v-model="recentNeedSync" style="margin: 0 10px;">同步新论文</el-checkbox>
                            <el-select v-if="recentNeedSync" v-model="recentSyncYears" placeholder="回溯年数" style="width: 100px;">
                                <el-option v-for="item in syncYearOptions" :key="item.value" :label="item.label" :value="item.value" />
                            </el-select>
                            <el-button type="primary" @click="updateRecentPapers" :loading="updatingRecent">
                                <el-icon><Refresh /></el-icon> 更新
                            </el-button>
                        </div>
                    </div>

                    <div v-if="recentLogs.length > 0" class="logs-container" style="margin-bottom: 20px;">
                        <div v-for="(log, index) in recentLogs" :key="index" class="log-line">
                            > {{ log }}
                        </div>
                    </div>

                    <div v-if="recentPapers.length > 0">
                        <div class="export-bar">
                            <el-checkbox v-model="recentSelectAll" @change="toggleRecentSelectAll">
                                {{ recentSelectedIds.length }} / {{ recentPapers.length }} 已选择
                            </el-checkbox>
                            <el-dropdown @command="exportRecent" :disabled="recentSelectedIds.length === 0">
                                <el-button type="primary" plain>
                                    <el-icon><Download /></el-icon> 导出
                                    <el-icon class="el-icon--right"><ArrowDown /></el-icon>
                                </el-button>
                                <template #dropdown>
                                    <el-dropdown-menu>
                                        <el-dropdown-item command="markdown">Markdown (.md)</el-dropdown-item>
                                        <el-dropdown-item command="pdf">PDF 文档</el-dropdown-item>
                                        <el-dropdown-item command="csv">CSV 表格</el-dropdown-item>
                                        <el-dropdown-item command="bibtex">BibTeX (.bib)</el-dropdown-item>
                                    </el-dropdown-menu>
                                </template>
                            </el-dropdown>
                        </div>
                        <paper-card 
                            v-for="paper in recentPapers" 
                            :key="paper.id" 
                            :paper="paper"
                            :collections="collections"
                            :selected="recentSelectedIds.includes(paper.id)"
                            @toggle-select="toggleRecentSelect(paper.id)"
                            @add-to-collection="addToCollection"
                        />
                    </div>
                    <div v-else class="empty-state">
                        <div class="icon"><el-icon><Document /></el-icon></div>
                        <h3>暂无论文</h3>
                        <p>点击"更新"获取最新文献</p>
                    </div>
                </div>

                <!-- Sync Tab -->
                <div v-if="currentPage === 'sync'">
                    <div class="sync-status-grid">
                        <div class="sync-status-card">
                            <div class="label">同步状态</div>
                            <div class="value" :class="syncStatusClass">{{ syncStatusText }}</div>
                        </div>
                        <div class="sync-status-card">
                            <div class="label">上次同步</div>
                            <div class="value" :class="syncTimeClass">{{ formatSyncTime }}</div>
                        </div>
                        <div class="sync-status-card">
                            <div class="label">研究领域</div>
                            <div class="value">{{ fieldStats.filter(f => f.is_selected).length }}</div>
                        </div>
                        <div class="sync-status-card">
                            <div class="label">总论文数</div>
                            <div class="value">{{ stats?.papers?.total || 0 }}</div>
                        </div>
                    </div>

                    <div class="sync-options">
                        <h3>同步设置</h3>
                        <el-form label-position="top">
                            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                <el-form-item label="回溯年数">
                                    <el-select v-model="syncYearsBack" style="width: 120px;">
                                        <el-option v-for="item in syncYearsBackOptions" :key="item.value" :label="item.label" :value="item.value" />
                                    </el-select>
                                </el-form-item>
                                <el-form-item label="强制同步">
                                    <el-switch v-model="syncForce" />
                                </el-form-item>
                                <el-form-item label=" ">
                                    <el-button type="primary" @click="startSync" :loading="syncing">
                                        <el-icon><Refresh /></el-icon> 开始同步
                                    </el-button>
                                </el-form-item>
                            </div>
                        </el-form>
                    </div>

                    <div v-if="syncLogs.length > 0" class="logs-container">
                        <div v-for="(log, index) in syncLogs" :key="index" class="log-line" :class="log.type">
                            > {{ log.message }}
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-card">
                            <h3>文献年份分布</h3>
                            <div id="yearChart" class="chart-container"></div>
                        </div>
                        <div class="chart-card">
                            <h3>热门研究领域</h3>
                            <div id="categoryChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>

                <!-- Collections Tab -->
                <div v-if="currentPage === 'collections'">
                    <div style="margin-bottom: 20px;">
                        <el-button type="primary" @click="showCreateCollection = true">
                            <el-icon><Plus /></el-icon> 新建论文集
                        </el-button>
                    </div>

                    <div v-if="collections.length > 0" class="collections-grid">
                        <div v-for="collection in collections" :key="collection.id" 
                             class="collection-card" @click="openCollectionDetail(collection)">
                            <div class="color-bar" :style="{ background: collection.color }"></div>
                            <h4>{{ collection.name }}</h4>
                            <p>{{ collection.description || '暂无描述' }}</p>
                            <div class="count">
                                <el-icon><Document /></el-icon>
                                {{ collection.paper_count || 0 }} 篇论文
                            </div>
                        </div>
                    </div>
                    <div v-else class="empty-state">
                        <div class="icon"><el-icon><Folder /></el-icon></div>
                        <h3>暂无论文集</h3>
                        <p>创建论文集来整理你感兴趣的文献</p>
                    </div>
                </div>
            </main>
            </template>

            <!-- Settings Drawer -->
            <el-drawer v-model="showSettings" title="系统设置" size="480px" class="settings-drawer">
                <div style="padding: 24px;">
                    <div class="settings-section">
                        <h3>API 配置</h3>
                        <el-form label-position="top">
                            <el-form-item label="API Base URL">
                                <el-input v-model="settingsConfig.ai_base_url" />
                            </el-form-item>
                            <el-form-item label="API Key">
                                <el-input v-model="settingsConfig.ai_api_key" type="password" show-password />
                            </el-form-item>
                            <el-form-item label="模型名称">
                                <el-input v-model="settingsConfig.ai_model" />
                            </el-form-item>
                            <el-form-item>
                                <el-button @click="testAIConnection" :loading="testingAI">测试连接</el-button>
                            </el-form-item>
                        </el-form>
                    </div>

                    <div class="settings-section">
                        <h3>研究领域</h3>
                        <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 12px;">
                            已有论文的领域取消后仅停止同步，不会删除已有论文
                        </p>
                        <div class="field-grid" style="max-height: 300px;">
                            <div v-for="field in fieldStats" :key="field.key" 
                                 class="field-item" 
                                 :class="{ 
                                     selected: settingsConfig.selected_fields?.includes(field.key),
                                     'has-papers': field.paper_count > 0
                                 }"
                                 @click="toggleSettingsField(field.key)">
                                <div class="name">
                                    {{ field.name }}
                                    <span v-if="field.paper_count > 0" class="paper-badge">{{ field.paper_count }} 篇</span>
                                </div>
                                <div class="desc">{{ field.description }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>同步设置</h3>
                        <el-form label-position="top">
                            <el-form-item label="回溯年数">
                                <el-select v-model="settingsConfig.years_back" style="width: 100%;">
                                    <el-option v-for="item in initYearOptions" :key="item.value" :label="item.label" :value="item.value" />
                                </el-select>
                            </el-form-item>
                            <el-form-item label="arXiv 最大结果数">
                                <el-input-number v-model="settingsConfig.arxiv_max_results" :min="1000" :max="50000" :step="1000" style="width: 100%;" />
                            </el-form-item>
                        </el-form>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 12px;">
                        <el-button @click="showSettings = false">取消</el-button>
                        <el-button type="primary" @click="saveSettings" :loading="savingSettings">保存设置</el-button>
                    </div>
                </div>
            </el-drawer>

            <!-- Dialogs -->
            <el-dialog v-model="showCreateCollection" title="新建论文集" width="480px">
                <el-form label-position="top">
                    <el-form-item label="名称">
                        <el-input v-model="newCollection.name" placeholder="论文集名称" />
                    </el-form-item>
                    <el-form-item label="描述">
                        <el-input v-model="newCollection.description" type="textarea" rows="3" placeholder="简要描述" />
                    </el-form-item>
                    <el-form-item label="颜色">
                        <el-color-picker v-model="newCollection.color" />
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="showCreateCollection = false">取消</el-button>
                    <el-button type="primary" @click="saveCollection" :loading="savingCollection">创建</el-button>
                </template>
            </el-dialog>

            <el-dialog v-model="showAddToCollection" title="添加到论文集" width="400px">
                <el-select v-model="selectedCollectionId" placeholder="选择论文集" style="width: 100%;">
                    <el-option v-for="c in collections" :key="c.id" :label="c.name" :value="c.id" />
                </el-select>
                <template #footer>
                    <el-button @click="showAddToCollection = false">取消</el-button>
                    <el-button type="primary" @click="confirmAddToCollection" :loading="addingToCollection">添加</el-button>
                </template>
            </el-dialog>

            <el-dialog v-model="viewingCollection" :title="viewingCollection?.name" width="800px">
                <div v-if="loadingCollectionPapers" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading" style="font-size: 32px;"><Loading /></el-icon>
                </div>
                <div v-else-if="collectionPapers.length > 0">
                    <div class="export-bar">
                        <span style="color: var(--text-secondary);">{{ collectionPapers.length }} 篇论文</span>
                        <el-dropdown @command="exportCollection">
                            <el-button type="primary" plain>
                                <el-icon><Download /></el-icon> 导出论文集
                                <el-icon class="el-icon--right"><ArrowDown /></el-icon>
                            </el-button>
                            <template #dropdown>
                                <el-dropdown-menu>
                                    <el-dropdown-item command="markdown">Markdown (.md)</el-dropdown-item>
                                    <el-dropdown-item command="pdf">PDF 文档</el-dropdown-item>
                                    <el-dropdown-item command="csv">CSV 表格</el-dropdown-item>
                                    <el-dropdown-item command="bibtex">BibTeX (.bib)</el-dropdown-item>
                                </el-dropdown-menu>
                            </template>
                        </el-dropdown>
                    </div>
                    <paper-card 
                        v-for="paper in collectionPapers" 
                        :key="paper.id" 
                        :paper="paper"
                        :collections="collections"
                        :in-collection="true"
                        @add-to-collection="addToCollection"
                        @remove-from-collection="removePaperFromCollection"
                    />
                </div>
                <div v-else class="empty-state">
                    <p>该论文集暂无论文</p>
                </div>
            </el-dialog>

            <el-dialog v-model="showDeleteConfirm" title="确认删除" width="400px">
                <p>确定要删除论文集 "{{ deletingCollection?.name }}" 吗？此操作不可恢复。</p>
                <template #footer>
                    <el-button @click="showDeleteConfirm = false">取消</el-button>
                    <el-button type="danger" @click="deleteCollection" :loading="deletingCollectionInProgress">删除</el-button>
                </template>
            </el-dialog>
        </div>
    </div>

    <script src="libs/vue/vue.global.prod.js"></script>
    <script src="libs/element-plus/index.full.js"></script>
    <script src="libs/element-plus/icons.iife.min.js"></script>
    <script src="libs/echarts/echarts.min.js"></script>
    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        const API_BASE = '/api';

        const researchFields = {
            "condensed_matter": { "name": "凝聚态物理", "description": "超导、强关联电子、介观系统等" },
            "dft": { "name": "密度泛函理论 (DFT)", "description": "第一性原理计算、材料设计" },
            "machine_learning": { "name": "机器学习", "description": "ML在物理和材料科学中的应用" },
            "force_fields": { "name": "力场与分子动力学", "description": "力场开发、MD模拟" },
            "first_principles": { "name": "第一性原理计算", "description": "ab initio 方法" },
            "quantum_physics": { "name": "量子物理", "description": "量子信息、量子计算" },
            "computational_physics": { "name": "计算物理", "description": "数值计算方法" },
            "chemical_physics": { "name": "化学物理", "description": "化学过程的物理基础" },
            "molecular_dynamics": { "name": "分子动力学", "description": "MD模拟技术" },
            "computational_materials": { "name": "计算材料科学", "description": "材料计算与模拟" },
            "astro_physics": { "name": "天体物理", "description": "天体物理学、宇宙学" },
            "high_energy_physics": { "name": "高能物理", "description": "粒子物理理论与实验" },
            "nuclear_physics": { "name": "核物理", "description": "核物理理论与实验" },
            "general_relativity": { "name": "广义相对论", "description": "引力理论、宇宙学" },
            "mathematical_physics": { "name": "数学物理", "description": "物理问题的数学方法" },
            "statistics": { "name": "统计学", "description": "统计学理论与应用" },
            "quantitative_biology": { "name": "定量生物学", "description": "生物信息学、系统生物学" },
            "artificial_intelligence": { "name": "人工智能", "description": "AI、神经网络" },
        };

        const app = createApp({
            setup() {
                const showSetup = ref(false);
                const setupStep = ref(1);
                const initializing = ref(false);
                const testingAI = ref(false);
                const initLogs = ref([]);
                const initProgress = ref(0);
                const initCurrentQuery = ref(0);
                const initTotalQueries = ref(0);
                
                const waitingMessages = [
                    '正在从 arXiv 获取论文...',
                    '首次同步可能需要几分钟...',
                    '正在处理论文数据...',
                    'arXiv 服务器响应中...',
                    '马上就好了...',
                    '正在建立索引...'
                ];
                const waitingMessage = ref(waitingMessages[0]);
                let waitingTimer = null;
                
                const setupConfig = ref({
                    ai_api_key: '',
                    ai_model: 'DeepSeek-V3.2',
                    ai_base_url: 'https://llmapi.paratera.com',
                    selected_fields: ['condensed_matter', 'dft', 'machine_learning'],
                    years_back: 5
                });

                const showSettings = ref(false);
                const savingSettings = ref(false);
                const settingsConfig = ref({
                    ai_api_key: '',
                    ai_model: 'DeepSeek-V3.2',
                    ai_base_url: 'https://llmapi.paratera.com',
                    selected_fields: [],
                    years_back: 5,
                    arxiv_max_results: 10000
                });

                const currentPage = ref('home');
                const stats = ref(null);
                const fieldStats = ref([]);
                const recentPapers = ref([]);
                const loadingRecent = ref(false);
                const updatingRecent = ref(false);
                const recentLogs = ref([]);
                const recentDays = ref('7');
                const recentLimit = ref('64');
                const recentNeedSync = ref(true);
                const recentSyncYears = ref('5');
                const recentCategories = ref([]);

                const homeQuery = ref('');
                const homeSearching = ref(false);
                const homeLogs = ref([]);
                const homeResults = ref([]);
                const homeSelectedIds = ref([]);

                const searchQuery = ref('');
                const searchDays = ref('');
                const searching = ref(false);
                const searchResults = ref([]);
                const searchLogs = ref([]);

                const recentSelectedIds = ref([]);
                const recentSelectAll = ref(false);
                const searchSelectedIds = ref([]);
                const searchSelectAll = ref(false);

                const syncStatus = ref(null);
                const syncing = ref(false);
                const syncLogs = ref([]);
                const syncYearsBack = ref('5');
                const syncForce = ref(false);

                const collections = ref([]);
                const showCreateCollection = ref(false);
                const showAddToCollection = ref(false);
                const showDeleteConfirm = ref(false);
                const newCollection = ref({ name: '', description: '', color: '#1e3a5f' });
                const editingCollection = ref(null);
                const deletingCollection = ref(null);
                const savingCollection = ref(false);
                const deletingCollectionInProgress = ref(false);
                const selectedCollectionId = ref(null);
                const selectedPaper = ref(null);
                const addingToCollection = ref(false);
                const viewingCollection = ref(null);
                const collectionPapers = ref([]);
                const loadingCollectionPapers = ref(false);

                let yearChart = null;
                let categoryChart = null;

                const daysOptions = [
                    { value: '1', label: '1 天' },
                    { value: '3', label: '3 天' },
                    { value: '7', label: '7 天' },
                    { value: '14', label: '14 天' },
                    { value: '30', label: '30 天' }
                ];

                const limitOptions = [
                    { value: '20', label: '20' },
                    { value: '50', label: '50' },
                    { value: '64', label: '64' },
                    { value: '100', label: '100' },
                    { value: '200', label: '200' }
                ];

                const syncYearOptions = [
                    { value: '1', label: '1 年' },
                    { value: '2', label: '2 年' },
                    { value: '3', label: '3 年' },
                    { value: '5', label: '5 年' },
                    { value: '10', label: '10 年' }
                ];

                const initYearOptions = [
                    { value: 1, label: '1 年' },
                    { value: 2, label: '2 年' },
                    { value: 3, label: '3 年' },
                    { value: 5, label: '5 年（推荐）' },
                    { value: 10, label: '10 年' }
                ];

                const syncYearsBackOptions = [
                    { value: '1', label: '1 年' },
                    { value: '2', label: '2 年' },
                    { value: '5', label: '5 年' },
                    { value: '10', label: '10 年' },
                    { value: '20', label: '20 年' }
                ];

                const searchDaysOptions = [
                    { value: '', label: '不限' },
                    { value: '30', label: '最近 30 天' },
                    { value: '90', label: '最近 90 天' },
                    { value: '180', label: '最近 180 天' },
                    { value: '365', label: '最近 1 年' }
                ];

                const categoryOptions = computed(() => {
                    return fieldStats.value
                        .filter(f => f.paper_count > 0)
                        .map(f => ({ value: f.key, label: f.name }));
                });

                const recentCacheStatus = computed(() => {
                    const info = recentPapers.value._cacheInfo;
                    if (!info) return '无缓存';
                    if (info.cached && info.updated_at) {
                        const date = new Date(info.updated_at);
                        return `缓存于 ${date.toLocaleString('zh-CN')}`;
                    }
                    return '无缓存';
                });

                const syncStatusText = computed(() => {
                    if (!syncStatus.value?.last_sync) return '从未同步';
                    return syncStatus.value.last_sync.status === 'completed' ? '已完成' : '进行中';
                });

                const syncStatusClass = computed(() => {
                    if (!syncStatus.value?.last_sync) return '';
                    return syncStatus.value.last_sync.status === 'completed' ? 'success' : 'warning';
                });

                const syncTimeClass = computed(() => {
                    if (!syncStatus.value?.last_sync?.time) return '';
                    const hours = (Date.now() - new Date(syncStatus.value.last_sync.time).getTime()) / 3600000;
                    if (hours < 24) return 'success';
                    if (hours < 72) return 'warning';
                    return '';
                });

                const formatSyncTime = computed(() => {
                    if (!syncStatus.value?.last_sync?.time) return '-';
                    const date = new Date(syncStatus.value.last_sync.time);
                    return date.toLocaleDateString('zh-CN');
                });

                async function checkInitStatus() {
                    try {
                        const res = await fetch(`${API_BASE}/config/status`);
                        const data = await res.json();
                        showSetup.value = !data.is_initialized;
                    } catch (e) {
                        console.error('Failed to check init status:', e);
                    }
                }

                async function testSetupAI() {
                    testingAI.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/config/test-ai`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(setupConfig.value)
                        });
                        const data = await res.json();
                        if (res.ok) {
                            ElementPlus.ElMessage.success(data.message || '连接成功');
                        } else {
                            ElementPlus.ElMessage.error(data.detail || '连接失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('连接失败');
                    } finally {
                        testingAI.value = false;
                    }
                }

                function toggleSetupField(key) {
                    const idx = setupConfig.value.selected_fields.indexOf(key);
                    if (idx >= 0) {
                        setupConfig.value.selected_fields.splice(idx, 1);
                    } else {
                        setupConfig.value.selected_fields.push(key);
                    }
                }

                async function startInitialSync() {
                    setupStep.value = 4;
                    initializing.value = true;
                    initLogs.value = [];
                    initProgress.value = 0;
                    initCurrentQuery.value = 0;
                    initTotalQueries.value = 0;

                    let msgIndex = 0;
                    waitingTimer = setInterval(() => {
                        msgIndex = (msgIndex + 1) % waitingMessages.length;
                        waitingMessage.value = waitingMessages[msgIndex];
                    }, 3000);

                    try {
                        await fetch(`${API_BASE}/config/init`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(setupConfig.value)
                        });

                        const response = await fetch(`${API_BASE}/config/init/sync`, { method: 'POST' });
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            initLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'total') {
                                            initTotalQueries.value = data.total;
                                        } else if (data.type === 'progress') {
                                            initCurrentQuery.value = data.current;
                                            initTotalQueries.value = data.total;
                                            initProgress.value = Math.round((data.current / data.total) * 100);
                                        } else if (data.type === 'done') {
                                            initLogs.value.push({ type: 'success', message: `同步完成，共 ${data.total_papers} 篇论文` });
                                            if (waitingTimer) clearInterval(waitingTimer);
                                            setTimeout(() => {
                                                showSetup.value = false;
                                                fetchStats();
                                                fetchFieldStats();
                                                fetchRecentCache();
                                            }, 1500);
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        initLogs.value.push({ type: 'error', message: `初始化失败: ${e.message}` });
                    } finally {
                        initializing.value = false;
                        if (waitingTimer) clearInterval(waitingTimer);
                    }
                }

                async function fetchConfig() {
                    try {
                        const res = await fetch(`${API_BASE}/config`);
                        const data = await res.json();
                        settingsConfig.value = {
                            ai_api_key: data.ai_api_key || '',
                            ai_model: data.ai_model || 'DeepSeek-V3.2',
                            ai_base_url: data.ai_base_url || 'https://llmapi.paratera.com',
                            selected_fields: data.selected_fields || [],
                            years_back: data.years_back || 5,
                            arxiv_max_results: data.arxiv_max_results || 10000
                        };
                    } catch (e) {
                        console.error('Failed to fetch config:', e);
                    }
                }

                async function testAIConnection() {
                    testingAI.value = true;
                    try {
                        const payload = {
                            ai_base_url: settingsConfig.value.ai_base_url,
                            ai_model: settingsConfig.value.ai_model
                        };
                        // Only send API key if it's not masked
                        if (settingsConfig.value.ai_api_key && settingsConfig.value.ai_api_key !== '***') {
                            payload.ai_api_key = settingsConfig.value.ai_api_key;
                        }
                        
                        const res = await fetch(`${API_BASE}/config/test-ai`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (res.ok) {
                            ElementPlus.ElMessage.success(data.message || '连接成功');
                        } else {
                            ElementPlus.ElMessage.error(data.detail || '连接失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('连接失败');
                    } finally {
                        testingAI.value = false;
                    }
                }

                function toggleSettingsField(key) {
                    if (!settingsConfig.value.selected_fields) {
                        settingsConfig.value.selected_fields = [];
                    }
                    const idx = settingsConfig.value.selected_fields.indexOf(key);
                    if (idx >= 0) {
                        settingsConfig.value.selected_fields.splice(idx, 1);
                    } else {
                        settingsConfig.value.selected_fields.push(key);
                    }
                }

                async function saveSettings() {
                    savingSettings.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/config`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(settingsConfig.value)
                        });
                        if (res.ok) {
                            ElementPlus.ElMessage.success('设置已保存');
                            showSettings.value = false;
                            fetchFieldStats();
                        } else {
                            ElementPlus.ElMessage.error('保存失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('保存失败');
                    } finally {
                        savingSettings.value = false;
                    }
                }

                async function fetchStats() {
                    try {
                        const res = await fetch(`${API_BASE}/stats`);
                        stats.value = await res.json();
                        await nextTick();
                        if (!yearChart) initCharts();
                        if (stats.value) {
                            renderYearChart(stats.value.years);
                            renderCategoryChart(stats.value.categories?.top);
                        }
                    } catch (e) {
                        console.error('Failed to fetch stats:', e);
                    }
                }

                async function fetchFieldStats() {
                    try {
                        const res = await fetch(`${API_BASE}/stats/fields`);
                        const data = await res.json();
                        fieldStats.value = data.fields || [];
                    } catch (e) {
                        console.error('Failed to fetch field stats:', e);
                    }
                }

                async function fetchRecentCache() {
                    loadingRecent.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/papers/recent/cache`);
                        const data = await res.json();
                        recentPapers.value = data.papers || [];
                        recentPapers.value._cacheInfo = {
                            cached: data.cached,
                            updated_at: data.updated_at,
                            days_back: data.days_back
                        };
                    } catch (e) {
                        console.error('Failed to fetch recent cache:', e);
                    } finally {
                        loadingRecent.value = false;
                    }
                }

                async function updateRecentPapers() {
                    updatingRecent.value = true;
                    recentLogs.value = [];
                    recentPapers.value = [];
                    try {
                        const params = new URLSearchParams({
                            days: recentDays.value,
                            limit: recentLimit.value,
                            need_sync: recentNeedSync.value,
                            sync_years: recentSyncYears.value
                        });
                        if (recentCategories.value.length > 0) {
                            params.append('categories', recentCategories.value.join(','));
                        }

                        const response = await fetch(`${API_BASE}/papers/recent/update?${params}`, { method: 'POST' });
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            recentLogs.value.push(data.message);
                                        } else if (data.type === 'result') {
                                            recentPapers.value.push(data.paper);
                                        } else if (data.type === 'done') {
                                            recentLogs.value.push(`更新完成，共 ${data.total} 篇论文`);
                                            recentPapers.value._cacheInfo = { cached: true, updated_at: new Date().toISOString() };
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Failed to update recent papers:', e);
                    } finally {
                        updatingRecent.value = false;
                    }
                }

                async function startSearch() {
                    if (!searchQuery.value.trim()) {
                        ElementPlus.ElMessage.warning('请输入搜索关键词');
                        return;
                    }
                    searching.value = true;
                    searchResults.value = [];
                    searchLogs.value = [];

                    try {
                        const params = new URLSearchParams({ q: searchQuery.value });
                        if (searchDays.value) params.append('days', searchDays.value);

                        const response = await fetch(`${API_BASE}/papers/search/stream?${params}`);
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            searchLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'result') {
                                            searchResults.value.push(data.paper);
                                        } else if (data.type === 'done') {
                                            searchLogs.value.push({ type: 'success', message: `搜索完成，共 ${data.total} 篇论文` });
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Search failed:', e);
                    } finally {
                        searching.value = false;
                    }
                }

                async function fetchCollections() {
                    try {
                        const res = await fetch(`${API_BASE}/collections`);
                        collections.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch collections:', e);
                    }
                }

                async function fetchSyncStatus() {
                    try {
                        const res = await fetch(`${API_BASE}/tasks/status`);
                        syncStatus.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch sync status:', e);
                    }
                }

                async function startSync() {
                    syncing.value = true;
                    syncLogs.value = [];
                    try {
                        const params = new URLSearchParams({
                            years_back: syncYearsBack.value,
                            force: syncForce.value
                        });

                        const response = await fetch(`${API_BASE}/tasks/sync?${params}`, { method: 'POST' });
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            syncLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'done') {
                                            syncLogs.value.push({ type: 'success', message: '同步完成' });
                                            fetchStats();
                                            fetchRecentCache();
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Sync failed:', e);
                    } finally {
                        syncing.value = false;
                    }
                }

                async function saveCollection() {
                    if (!newCollection.value.name.trim()) {
                        ElementPlus.ElMessage.warning('请输入论文集名称');
                        return;
                    }
                    savingCollection.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/collections`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newCollection.value)
                        });
                        if (res.ok) {
                            ElementPlus.ElMessage.success('创建成功');
                            showCreateCollection.value = false;
                            newCollection.value = { name: '', description: '', color: '#1e3a5f' };
                            fetchCollections();
                        } else {
                            ElementPlus.ElMessage.error('创建失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('创建失败');
                    } finally {
                        savingCollection.value = false;
                    }
                }

                function cancelCollectionDialog() {
                    showCreateCollection.value = false;
                    editingCollection.value = null;
                }

                function openEditCollection(collection) {
                    editingCollection.value = { ...collection };
                }

                function confirmDeleteCollection(collection) {
                    deletingCollection.value = collection;
                    showDeleteConfirm.value = true;
                }

                async function deleteCollection() {
                    deletingCollectionInProgress.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/collections/${deletingCollection.value.id}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            ElementPlus.ElMessage.success('删除成功');
                            showDeleteConfirm.value = false;
                            fetchCollections();
                        } else {
                            ElementPlus.ElMessage.error('删除失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('删除失败');
                    } finally {
                        deletingCollectionInProgress.value = false;
                    }
                }

                async function openCollectionDetail(collection) {
                    viewingCollection.value = collection;
                    loadingCollectionPapers.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/collections/${collection.id}/papers`);
                        collectionPapers.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch collection papers:', e);
                    } finally {
                        loadingCollectionPapers.value = false;
                    }
                }

                async function removePaperFromCollection(paperId) {
                    try {
                        const res = await fetch(
                            `${API_BASE}/collections/${viewingCollection.value.id}/papers/${paperId}`,
                            { method: 'DELETE' }
                        );
                        if (res.ok) {
                            ElementPlus.ElMessage.success('已移除');
                            openCollectionDetail(viewingCollection.value);
                            fetchCollections();
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('移除失败');
                    }
                }

                function addToCollection(paper) {
                    selectedPaper.value = paper;
                    selectedCollectionId.value = null;
                    showAddToCollection.value = true;
                }

                async function confirmAddToCollection() {
                    if (!selectedCollectionId.value) {
                        ElementPlus.ElMessage.warning('请选择论文集');
                        return;
                    }
                    addingToCollection.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/collections/${selectedCollectionId.value}/papers`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ paper_id: selectedPaper.value.id })
                        });
                        if (res.ok) {
                            ElementPlus.ElMessage.success('添加成功');
                            showAddToCollection.value = false;
                            fetchCollections();
                        } else {
                            const data = await res.json();
                            ElementPlus.ElMessage.error(data.detail || '添加失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('添加失败');
                    } finally {
                        addingToCollection.value = false;
                    }
                }

                function toggleRecentSelect(paperId) {
                    const idx = recentSelectedIds.value.indexOf(paperId);
                    if (idx >= 0) {
                        recentSelectedIds.value.splice(idx, 1);
                    } else {
                        recentSelectedIds.value.push(paperId);
                    }
                    recentSelectAll.value = recentSelectedIds.value.length === recentPapers.value.length;
                }

                function toggleRecentSelectAll(val) {
                    if (val) {
                        recentSelectedIds.value = recentPapers.value.map(p => p.id);
                    } else {
                        recentSelectedIds.value = [];
                    }
                }

                function toggleSearchSelect(paperId) {
                    const idx = searchSelectedIds.value.indexOf(paperId);
                    if (idx >= 0) {
                        searchSelectedIds.value.splice(idx, 1);
                    } else {
                        searchSelectedIds.value.push(paperId);
                    }
                    searchSelectAll.value = searchSelectedIds.value.length === searchResults.value.length;
                }

                function toggleSearchSelectAll(val) {
                    if (val) {
                        searchSelectedIds.value = searchResults.value.map(p => p.id);
                    } else {
                        searchSelectedIds.value = [];
                    }
                }

                async function exportRecent(format) {
                    if (recentSelectedIds.value.length === 0) return;
                    try {
                        const res = await fetch(`${API_BASE}/export/papers`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                paper_ids: recentSelectedIds.value,
                                format: format,
                                include_summary: true
                            })
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `recent_papers.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success(`已导出 ${recentSelectedIds.value.length} 篇论文`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                async function exportSearch(format) {
                    if (searchSelectedIds.value.length === 0) return;
                    try {
                        const res = await fetch(`${API_BASE}/export/papers`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                paper_ids: searchSelectedIds.value,
                                format: format,
                                include_summary: true
                            })
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `search_results.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success(`已导出 ${searchSelectedIds.value.length} 篇论文`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                async function exportCollection(format) {
                    if (!viewingCollection.value) return;
                    try {
                        const res = await fetch(`${API_BASE}/export/collection`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                collection_id: viewingCollection.value.id,
                                format: format,
                                include_summary: true
                            })
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `collection_${viewingCollection.value.name.replace(/\s+/g, '_')}.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success('导出成功');
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                function navigateTo(page) {
                    currentPage.value = page;
                }

                function onTabChange(tab) {
                    currentPage.value = tab;
                }

                function toggleHomeSelect(paperId) {
                    const idx = homeSelectedIds.value.indexOf(paperId);
                    if (idx >= 0) {
                        homeSelectedIds.value.splice(idx, 1);
                    } else {
                        homeSelectedIds.value.push(paperId);
                    }
                }

                async function startHomeSearch() {
                    if (!homeQuery.value.trim()) return;
                    
                    homeSearching.value = true;
                    homeLogs.value = [];
                    homeResults.value = [];
                    homeSelectedIds.value = [];
                    
                    try {
                        const params = new URLSearchParams({ q: homeQuery.value });
                        const response = await fetch(`${API_BASE}/papers/quick?${params}`);
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            homeLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'result') {
                                            homeResults.value.push(data.paper);
                                        } else if (data.type === 'done') {
                                            if (data.total === 0) {
                                                homeLogs.value.push({ type: 'info', message: '未找到匹配的论文' });
                                            }
                                        } else if (data.type === 'error') {
                                            homeLogs.value.push({ type: 'error', message: data.message });
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        homeLogs.value.push({ type: 'error', message: `搜索失败: ${e.message}` });
                    } finally {
                        homeSearching.value = false;
                    }
                }

                async function exportHome(format) {
                    if (homeSelectedIds.value.length === 0) return;
                    try {
                        const res = await fetch(`${API_BASE}/export/papers`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                paper_ids: homeSelectedIds.value,
                                format: format,
                                include_summary: true
                            })
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `search_results.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success(`已导出 ${homeSelectedIds.value.length} 篇论文`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                function initCharts() {
                    yearChart = echarts.init(document.getElementById('yearChart'));
                    categoryChart = echarts.init(document.getElementById('categoryChart'));
                }

                function renderYearChart(data) {
                    if (!yearChart) return;
                    const years = data ? Object.keys(data) : [];
                    const counts = data ? Object.values(data) : [];
                    
                    if (years.length === 0) {
                        yearChart.setOption({
                            title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#909399', fontSize: 14 } },
                            xAxis: { show: false },
                            yAxis: { show: false },
                            series: []
                        });
                        return;
                    }
                    
                    yearChart.setOption({
                        tooltip: { trigger: 'axis' },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: years, axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d' } },
                        yAxis: { type: 'value', axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d' }, splitLine: { lineStyle: { color: '#e8e6e1' } } },
                        series: [{ data: counts, type: 'bar', itemStyle: { color: '#1e3a5f', borderRadius: [4, 4, 0, 0] } }]
                    });
                }

                function renderCategoryChart(data) {
                    if (!categoryChart) return;
                    const categories = data || [];
                    
                    if (categories.length === 0) {
                        categoryChart.setOption({
                            title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#909399', fontSize: 14 } },
                            xAxis: { show: false },
                            yAxis: { show: false },
                            series: []
                        });
                        return;
                    }
                    
                    categoryChart.setOption({
                        tooltip: { trigger: 'item' },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: categories.map(d => d.name), axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d', rotate: 30 } },
                        yAxis: { type: 'value', axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d' }, splitLine: { lineStyle: { color: '#e8e6e1' } } },
                        series: [{ data: categories.map(d => d.count), type: 'bar', itemStyle: { color: '#c9a227', borderRadius: [4, 4, 0, 0] } }]
                    });
                }

                watch(showSetup, (val) => {
                    if (!val) {
                        nextTick(() => {
                            if (!yearChart) initCharts();
                            renderYearChart(stats.value?.years);
                            renderCategoryChart(stats.value?.categories?.top);
                        });
                    }
                });

                onMounted(() => {
                    checkInitStatus();
                    fetchStats();
                    fetchFieldStats();
                    fetchRecentCache();
                    fetchCollections();
                    fetchSyncStatus();
                    fetchConfig();
                });

                return {
                    showSetup, setupStep, setupConfig, initializing, testingAI, initLogs, initProgress,
                    initCurrentQuery, initTotalQueries, waitingMessage,
                    showSettings, settingsConfig, savingSettings,
                    currentPage, stats, fieldStats, recentPapers, searchResults, collections,
                    loadingRecent, updatingRecent, recentLogs,
                    recentDays, recentLimit, recentNeedSync, recentSyncYears, recentCategories,
                    categoryOptions, daysOptions, limitOptions, syncYearOptions, initYearOptions, syncYearsBackOptions, searchDaysOptions,
                    searching, searchQuery, searchDays, searchLogs,
                    syncStatus, syncing, syncLogs, syncYearsBack, syncForce,
                    syncStatusText, syncStatusClass, syncTimeClass, formatSyncTime,
                    recentCacheStatus, researchFields,
                    showCreateCollection, showAddToCollection, showDeleteConfirm,
                    newCollection, editingCollection, deletingCollection,
                    savingCollection, deletingCollectionInProgress,
                    selectedCollectionId, selectedPaper, addingToCollection,
                    viewingCollection, collectionPapers, loadingCollectionPapers,
                    recentSelectedIds, recentSelectAll, searchSelectedIds, searchSelectAll,
                    homeQuery, homeSearching, homeLogs, homeResults, homeSelectedIds,
                    checkInitStatus, testSetupAI, toggleSetupField, startInitialSync,
                    testAIConnection, saveSettings, toggleSettingsField,
                    fetchStats, fetchFieldStats, fetchRecentCache, updateRecentPapers, startSearch, fetchCollections,
                    fetchSyncStatus, startSync,
                    saveCollection, cancelCollectionDialog, openEditCollection,
                    confirmDeleteCollection, deleteCollection,
                    openCollectionDetail, removePaperFromCollection,
                    addToCollection, confirmAddToCollection,
                    toggleRecentSelect, toggleRecentSelectAll, toggleSearchSelect, toggleSearchSelectAll,
                    exportRecent, exportSearch, exportCollection,
                    navigateTo, onTabChange, startHomeSearch, toggleHomeSelect, exportHome
                };
            }
        });

        app.component('paper-card', {
            props: ['paper', 'collections', 'inCollection', 'selected'],
            emits: ['add-to-collection', 'remove-from-collection', 'toggle-select', 'download-card'],
            template: `
                <div class="paper-card" :class="{ 'paper-selected': selected }">
                    <div class="paper-header">
                        <el-checkbox v-if="selected !== undefined" :model-value="selected" @change="$emit('toggle-select')" />
                        <div class="paper-title" @click="openArxiv(paper.arxiv_id)">{{ paper.title }}</div>
                    </div>
                    <div v-if="paper.title_translation" class="paper-title-cn">{{ paper.title_translation }}</div>
                    <div class="paper-meta">
                        <span class="paper-meta-item">
                            <el-icon><Calendar /></el-icon>
                            {{ formatDate(paper.published) }}
                        </span>
                        <span class="paper-meta-item">
                            <el-icon><User /></el-icon>
                            {{ paper.authors?.slice(0, 2).map(a => a.name).join(', ') }}{{ paper.authors?.length > 2 ? ' 等' : '' }}
                        </span>
                        <span class="paper-relevance">
                            <span v-for="i in 5" :key="i" class="star">{{ i <= paper.relevance_score ? '★' : '☆' }}</span>
                        </span>
                    </div>
                    <div class="paper-category" v-if="paper.category_explanation">{{ paper.category_explanation }}</div>
                    <div v-if="!expanded" class="paper-abstract-preview">{{ paper.abstract?.slice(0, 200) }}...</div>
                    <div class="paper-actions">
                        <el-button size="small" text type="primary" @click="openArxiv(paper.arxiv_id)">
                            <el-icon><Link /></el-icon> arXiv
                        </el-button>
                        <el-button size="small" text type="primary" @click="downloadPDF(paper.arxiv_id)">
                            <el-icon><Download /></el-icon> PDF
                        </el-button>
                        <el-button size="small" text type="primary" @click="downloadCard">
                            <el-icon><Picture /></el-icon> 卡片
                        </el-button>
                        <el-button size="small" text type="primary" @click="expanded = !expanded">
                            {{ expanded ? '收起' : '展开详情' }}
                        </el-button>
                        <el-button size="small" text @click="$emit('add-to-collection', paper)">
                            <el-icon><FolderAdd /></el-icon> 加入论文集
                        </el-button>
                        <el-button v-if="inCollection" size="small" text type="danger" @click="$emit('remove-from-collection', paper.id)">
                            <el-icon><Delete /></el-icon> 移除
                        </el-button>
                    </div>
                    <div v-if="expanded" class="paper-detail">
                        <div v-if="paper.summary_text" class="ai-summary-section">
                            <h4>AI 总结</h4>
                            <p class="summary-text" v-html="formatSummary(paper.summary_text)"></p>
                        </div>
                        <div v-if="paper.key_findings?.length" class="key-findings">
                            <h4>关键发现</h4>
                            <ul>
                                <li v-for="(finding, i) in paper.key_findings" :key="i">{{ finding }}</li>
                            </ul>
                        </div>
                        <div v-if="paper.keywords?.length" class="paper-keywords">
                            <h4>关键词</h4>
                            <div class="keywords-list">
                                <el-tag v-for="kw in paper.keywords" :key="kw" size="small" type="info">{{ kw }}</el-tag>
                            </div>
                        </div>
                        <div v-if="paper.figure_url" class="paper-figure">
                            <img :src="paper.figure_url" @click="openImage(paper.figure_url)" />
                        </div>
                        <div class="abstract-section">
                            <h4>摘要 (Abstract)</h4>
                            <p>{{ paper.abstract }}</p>
                            <div v-if="paper.abstract_translation" class="translation">
                                <h4>中文翻译</h4>
                                <p>{{ paper.abstract_translation }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup(props) {
                const expanded = ref(false);
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString('zh-CN');
                };
                const formatSummary = (text) => {
                    if (!text) return '';
                    return text.replace(/\n/g, '<br>');
                };
                const openArxiv = (arxivId) => {
                    window.open(`https://arxiv.org/abs/${arxivId}`, '_blank');
                };
                const downloadPDF = (arxivId) => {
                    window.open(`https://arxiv.org/pdf/${arxivId}.pdf`, '_blank');
                };
                const openImage = (url) => {
                    window.open(url, '_blank');
                };
                const downloadCard = async () => {
                    const scale = 2;
                    const width = 700 * scale;
                    const padding = 32 * scale;
                    const lineHeight = 24 * scale;
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const wrapText = (text, maxWidth, fontSize) => {
                        if (!text) return [];
                        ctx.font = `${fontSize * scale}px sans-serif`;
                        const chars = text.split('');
                        const result = [];
                        let current = '';
                        for (const char of chars) {
                            const test = current + char;
                            if (ctx.measureText(test).width > maxWidth && current) {
                                result.push(current);
                                current = char;
                            } else {
                                current = test;
                            }
                        }
                        if (current) result.push(current);
                        return result;
                    };
                    
                    let y = padding;
                    const elements = [];
                    
                    const titleLines = wrapText(props.paper.title, width - padding * 2, 20);
                    titleLines.forEach(line => {
                        elements.push({ type: 'text', text: line, font: `bold ${20 * scale}px Georgia, "Noto Serif SC", serif`, color: '#1e3a5f', y: y });
                        y += 32 * scale;
                    });
                    
                    if (props.paper.title_translation) {
                        const transLines = wrapText(props.paper.title_translation, width - padding * 2, 16);
                        transLines.forEach(line => {
                            elements.push({ type: 'text', text: line, font: `italic ${16 * scale}px sans-serif`, color: '#5a6c7d', y: y });
                            y += 26 * scale;
                        });
                        y += 8 * scale;
                    }
                    
                    const pubDate = props.paper.published ? new Date(props.paper.published).toLocaleDateString('zh-CN') : 'N/A';
                    const authors = props.paper.authors?.slice(0, 4).map(a => a.name).join(', ') || '';
                    elements.push({ type: 'text', text: `${pubDate}  |  ${authors}${props.paper.authors?.length > 4 ? ' 等' : ''}`, font: `${13 * scale}px sans-serif`, color: '#909399', y: y });
                    y += 36 * scale;
                    
                    elements.push({ type: 'divider', y: y });
                    y += 20 * scale;
                    
                    if (props.paper.summary_text) {
                        elements.push({ type: 'section-title', text: 'AI 总结', y: y });
                        y += 28 * scale;
                        const paragraphs = props.paper.summary_text.split('\n\n');
                        paragraphs.forEach(para => {
                            if (para.trim()) {
                                const summaryLines = wrapText(para.trim(), width - padding * 2, 14);
                                summaryLines.forEach(line => {
                                    elements.push({ type: 'text', text: line, font: `${14 * scale}px sans-serif`, color: '#333', y: y });
                                    y += 22 * scale;
                                });
                                y += 8 * scale;
                            }
                        });
                        y += 4 * scale;
                    }
                    
                    if (props.paper.keywords?.length) {
                        elements.push({ type: 'section-title', text: '关键词', y: y });
                        y += 28 * scale;
                        const keywordsText = props.paper.keywords.join('  •  ');
                        const keywordLines = wrapText(keywordsText, width - padding * 2, 13);
                        keywordLines.forEach(line => {
                            elements.push({ type: 'text', text: line, font: `${13 * scale}px sans-serif`, color: '#c9a227', y: y });
                            y += 20 * scale;
                        });
                        y += 12 * scale;
                    }
                    
                    if (props.paper.key_findings?.length) {
                        elements.push({ type: 'section-title', text: '关键发现', y: y });
                        y += 28 * scale;
                        props.paper.key_findings.forEach(finding => {
                            const findingLines = wrapText(`• ${finding}`, width - padding * 2 - 20 * scale, 14);
                            findingLines.forEach(line => {
                                elements.push({ type: 'text', text: line, font: `${14 * scale}px sans-serif`, color: '#5a6c7d', y: y });
                                y += 22 * scale;
                            });
                        });
                        y += 12 * scale;
                    }
                    
                    if (props.paper.figure_url) {
                        try {
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                                img.src = props.paper.figure_url;
                            });
                            const maxImgWidth = width - padding * 2;
                            const imgScale = Math.min(1, maxImgWidth / img.width);
                            const imgDrawWidth = img.width * imgScale;
                            const imgDrawHeight = img.height * imgScale;
                            elements.push({ type: 'image', img, y, width: imgDrawWidth, height: imgDrawHeight });
                            y += imgDrawHeight + 20 * scale;
                        } catch (e) {}
                    }
                    
                    elements.push({ type: 'section-title', text: '摘要 (Abstract)', y: y });
                    y += 28 * scale;
                    
                    const abstractLines = wrapText(props.paper.abstract || '', width - padding * 2, 14);
                    abstractLines.forEach(line => {
                        elements.push({ type: 'text', text: line, font: `${14 * scale}px sans-serif`, color: '#444', y: y });
                        y += 22 * scale;
                    });
                    y += 12 * scale;
                    
                    if (props.paper.abstract_translation) {
                        elements.push({ type: 'section-title', text: '中文翻译', y: y });
                        y += 28 * scale;
                        const transAbstractLines = wrapText(props.paper.abstract_translation, width - padding * 2, 14);
                        transAbstractLines.forEach(line => {
                            elements.push({ type: 'text', text: line, font: `${14 * scale}px sans-serif`, color: '#555', y: y });
                            y += 22 * scale;
                        });
                        y += 12 * scale;
                    }
                    
                    y += 16 * scale;
                    elements.push({ type: 'divider', y: y });
                    y += 20 * scale;
                    
                    elements.push({ type: 'text', text: `arXiv: ${props.paper.arxiv_id}`, font: `${12 * scale}px sans-serif`, color: '#909399', y: y });
                    y += 24 * scale;
                    elements.push({ type: 'text', text: 'arXiv Pulse', font: `bold ${13 * scale}px Georgia, serif`, color: '#c9a227', y: y });
                    
                    const height = y + padding;
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, width, height);
                    
                    ctx.fillStyle = '#1e3a5f';
                    ctx.fillRect(0, 0, 6 * scale, height);
                    
                    ctx.fillStyle = '#c9a227';
                    ctx.fillRect(0, height - 4 * scale, width, 4 * scale);
                    
                    for (const el of elements) {
                        if (el.type === 'text') {
                            ctx.font = el.font;
                            ctx.fillStyle = el.color;
                            ctx.fillText(el.text, padding, el.y);
                        } else if (el.type === 'section-title') {
                            ctx.font = `bold ${15 * scale}px sans-serif`;
                            ctx.fillStyle = '#1e3a5f';
                            ctx.fillText(el.text, padding, el.y);
                            ctx.fillStyle = '#c9a227';
                            ctx.fillRect(padding, el.y + 6 * scale, 40 * scale, 2 * scale);
                        } else if (el.type === 'divider') {
                            ctx.strokeStyle = '#e8e6e1';
                            ctx.lineWidth = 1 * scale;
                            ctx.beginPath();
                            ctx.moveTo(padding, el.y);
                            ctx.lineTo(width - padding, el.y);
                            ctx.stroke();
                        } else if (el.type === 'image') {
                            ctx.drawImage(el.img, padding, el.y, el.width, el.height);
                        }
                    }
                    
                    const link = document.createElement('a');
                    link.download = `paper_${props.paper.arxiv_id}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                    
                    ElementPlus.ElMessage.success('已导出卡片图片');
                };
                return { expanded, formatDate, formatSummary, openArxiv, downloadPDF, openImage, downloadCard };
            }
        });

        app.use(ElementPlus);
        if (window.ElementPlusIconsVue) {
            for (const [key, component] of Object.entries(window.ElementPlusIconsVue)) {
                app.component(key, component);
            }
        }
        app.mount('#app');
    </script>
</body>
</html>
