<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>arXiv Pulse - 学术文献追踪</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="libs/element-plus/index.css">
    <style>
        [v-cloak] { display: none; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a87;
            --primary-dark: #0f1f33;
            --accent: #c9a227;
            --accent-light: #e6c458;
            --bg-main: #faf9f7;
            --bg-card: #ffffff;
            --bg-subtle: #f5f3f0;
            --text-primary: #2c3e50;
            --text-secondary: #5a6c7d;
            --text-muted: #8492a6;
            --border-light: #e8e6e1;
            --border-medium: #d4d0c8;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: var(--bg-main); 
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        h1, h2, h3, h4 { font-family: Georgia, 'Times New Roman', serif; }
        
        /* Setup Container */
        .setup-container { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(180deg, #f8f7f4 0%, #e8e5df 100%);
            padding: 20px;
            position: relative;
        }
        .setup-lang-btn {
            position: fixed;
            left: 24px;
            bottom: 24px;
            width: 56px !important;
            height: 56px !important;
            min-width: 56px !important;
            padding: 0 !important;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%) !important;
            border: none !important;
            color: white !important;
            opacity: 0.6;
            transition: all 0.3s;
            border-radius: 50% !important;
        }
        .setup-lang-btn:hover {
            transform: scale(1.08);
            opacity: 1;
        }
        .setup-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            padding: 48px; 
            width: 640px; 
            max-width: 100%; 
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
        }
        .setup-card h1 { 
            text-align: center; 
            margin-bottom: 8px; 
            color: var(--primary);
            font-size: 28px;
            font-weight: 700;
        }
        .setup-card .subtitle { 
            text-align: center; 
            color: var(--text-muted); 
            margin-bottom: 36px;
            font-size: 14px;
        }
        .setup-steps { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 36px; 
            gap: 12px; 
        }
        .setup-step { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .setup-step.active { background: var(--primary); color: white; }
        .setup-step.done { background: var(--accent); color: white; }
        .setup-step.pending { background: var(--bg-subtle); color: var(--text-muted); }
        
        .field-grid { 
            display: grid; 
            grid-template-columns: repeat(2, minmax(0, 1fr)); 
            gap: 10px; 
            max-height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            border: 1px solid var(--border-light); 
            border-radius: var(--radius-md); 
            background: var(--bg-subtle);
        }
        .field-item { 
            padding: 10px 12px; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            transition: all 0.2s ease; 
            border: 2px solid transparent; 
            background: var(--bg-card);
            min-width: 0;
            overflow: hidden;
        }
        .field-item:hover { 
            border-color: var(--border-medium);
            transform: translateY(-1px);
        }
        .field-item.selected { 
            background: #f0f7ff; 
            border-color: var(--primary); 
        }
        .field-item.has-papers { 
            border-color: var(--accent); 
        }
        .field-item.has-papers.selected { 
            border-color: var(--primary); 
            background: #f0f7ff; 
        }
        .field-item .name { 
            font-weight: 600; 
            color: var(--text-primary); 
            margin-bottom: 4px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 14px;
        }
        .field-item .desc { 
            font-size: 12px; 
            color: var(--text-muted); 
            line-height: 1.4;
        }
        .paper-badge { 
            background: var(--accent); 
            color: white; 
            font-size: 10px; 
            padding: 2px 8px; 
            border-radius: 12px; 
            font-weight: 500; 
        }
        
        /* Category Tree */
        .category-tree {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            padding: 8px;
        }
        .category-group {
            margin-bottom: 4px;
        }
        .category-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .category-header:hover {
            background: var(--bg-subtle);
        }
        .category-name {
            flex: 1;
        }
        .recommended-badge {
            background: linear-gradient(135deg, #f5a623 0%, #f7b731 100%);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
            margin-left: 8px;
        }
        .recommended-badge.small {
            font-size: 9px;
            padding: 1px 6px;
        }
        .category-children {
            margin-left: 20px;
        }
        .category-subgroup {
            margin: 4px 0;
        }
        .category-subheader {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .category-subheader:hover {
            background: var(--bg-subtle);
        }
        .category-items {
            margin-left: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 6px 0;
        }
        .category-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            background: var(--bg-subtle);
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .category-item:hover {
            background: #e8f4ff;
            color: var(--primary);
        }
        .category-item.selected {
            background: #e8f4ff;
            color: var(--primary);
            border-color: var(--primary);
            font-weight: 500;
        }
        .category-item.recommended {
            background: #fffbeb;
        }
        .category-item.recommended:hover {
            background: #fef3c7;
        }
        .category-item .star {
            font-size: 12px;
        }
        
        /* App Container */
        .app-container { min-height: 100vh; }
        
        /* Home Page */
        .home-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: linear-gradient(180deg, #f8f7f4 0%, #e8e5df 100%);
        }
        .home-brand {
            text-align: center;
            margin-bottom: 48px;
        }
        .home-brand h1 {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -1px;
        }
        .home-brand p {
            color: var(--text-muted);
            font-size: 16px;
        }
        .home-search-box {
            width: 100%;
            max-width: 680px;
            margin-bottom: 24px;
        }
        .home-search-box .el-input__wrapper {
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .home-search-box .el-input__wrapper:hover,
        .home-search-box .el-input__wrapper.is-focus {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg), 0 0 0 4px rgba(30, 58, 95, 0.1);
        }
        .home-search-box .el-input__inner {
            font-size: 17px;
            height: 32px;
        }
        .home-search-box .el-input__inner::placeholder {
            font-size: 17px;
        }
        .home-stats {
            display: flex;
            gap: 40px;
            margin-top: 32px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .home-stats span {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .home-hints {
            margin-top: 24px;
            color: var(--text-muted);
            font-size: 13px;
            text-align: center;
        }
        .home-footer {
            margin-top: 32px;
            padding-bottom: 100px;
        }
        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }
        .github-link:hover {
            color: var(--primary);
        }
        
        /* Bottom Navigation Bar - Auto Hide */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(30, 58, 95, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            z-index: 1001;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .bottom-nav::before {
            content: '';
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 2px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        .bottom-nav:hover::before {
            background: rgba(255, 255, 255, 0.8);
        }
        .bottom-nav .nav-items-wrapper {
            display: flex;
            gap: 6px;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .bottom-nav:hover .nav-items-wrapper {
            max-height: 70px;
            opacity: 1;
        }
        .nav-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255, 255, 255, 0.7);
            min-width: 56px;
        }
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }
        .nav-item.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            transform: translateY(-2px);
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 16px;
            height: 2px;
            background: #c9a227;
            border-radius: 1px;
        }
        .nav-item svg {
            margin-bottom: 2px;
        }
        .nav-item span {
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* Page Transition Animations */
        .page-fade-enter-active,
        .page-fade-leave-active {
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        .page-fade-enter-from {
            opacity: 0;
            transform: translateY(10px);
        }
        .page-fade-leave-to {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        @keyframes pageFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-animate {
            animation: pageFadeIn 0.3s ease-out;
        }
        
        /* Floating Buttons */
        .floating-buttons-left,
        .floating-buttons-right {
            position: fixed;
            bottom: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }
        .floating-buttons-left {
            left: 24px;
        }
        .floating-buttons-right {
            right: 24px;
        }
        .floating-buttons-left .el-button,
        .floating-buttons-right .el-button {
            width: 64px !important;
            height: 64px !important;
            min-width: 64px !important;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.4;
            margin: 0 !important;
            padding: 0 !important;
        }
        .floating-buttons-left .el-button:hover,
        .floating-buttons-right .el-button:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
            opacity: 1;
        }
        .floating-buttons-left .el-badge,
        .floating-buttons-right .el-badge {
            display: flex;
            justify-content: center;
            line-height: 1;
        }
        .lang-btn {
            background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%) !important;
            border: none !important;
            color: white !important;
        }
        .settings-btn {
            background: linear-gradient(135deg, #5a6c7d 0%, #3d4f5f 100%) !important;
            border: none !important;
            color: white !important;
        }
        .settings-btn .el-icon {
            font-size: 26px !important;
        }
        .cart-fab-btn {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%) !important;
            border: none !important;
            color: white !important;
        }
        .cart-fab-btn svg {
            color: white !important;
        }
        .chat-fab-btn {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%) !important;
            border: none !important;
            color: white !important;
        }
        .chat-fab-btn svg {
            color: white !important;
        }
        
        /* Page Transition Animations */
        .page-slide-enter-active {
            animation: slideInRight 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .page-slide-leave-active {
            animation: slideOutLeft 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes slideOutLeft {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(-30px);
            }
        }
        
        .header { 
            background: var(--primary); 
            color: white; 
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }
        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 40px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header-brand h1 { 
            font-size: 22px; 
            margin-bottom: 2px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .header-brand p { 
            opacity: 0.7; 
            font-size: 13px; 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .header-actions { display: flex; gap: 12px; }
        .header-actions .el-button {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: white;
        }
        .header-actions .el-button:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }
        
        .main-content { 
            padding: 32px 40px; 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* Stats Row */
        .stats-row { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 28px; 
        }
        .stat-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        .stat-card h3 { 
            color: var(--text-muted); 
            font-size: 12px; 
            margin-bottom: 12px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
        }
        .stat-card .value { 
            font-size: 32px; 
            font-weight: 700; 
            color: var(--primary);
            font-family: Georgia, 'Times New Roman', serif;
        }
        
        /* Page Content */
        .page-content {
            animation: pageFadeIn 0.35s ease-out;
        }
        @keyframes pageFadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Settings Section */
        .settings-section { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            margin-bottom: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }
        .settings-section h3 { 
            margin-bottom: 20px; 
            color: var(--primary); 
            font-size: 16px;
            border-bottom: 1px solid var(--border-light); 
            padding-bottom: 12px;
            font-weight: 600;
        }
        .settings-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; }
        .settings-row .el-input { flex: 1; min-width: 200px; }
        
        /* Paper Card - Academic Style */
        .paper-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px 28px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }
        .paper-card:hover { 
            box-shadow: var(--shadow-md); 
            border-color: var(--border-medium);
        }
        .paper-card.paper-selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f8faff 0%, var(--bg-card) 100%);
        }
        .paper-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }
        .paper-header .el-checkbox {
            margin-top: 4px;
        }
        .paper-header .paper-title {
            flex: 1;
        }
        .paper-title { 
            color: var(--primary); 
            font-size: 17px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-bottom: 8px; 
            line-height: 1.5;
            font-family: Georgia, 'Times New Roman', serif;
            transition: color 0.2s;
        }
        .paper-title:hover { 
            color: var(--primary-light); 
        }
        .paper-title-cn { 
            color: var(--text-secondary); 
            font-size: 15px; 
            margin-bottom: 12px; 
            line-height: 1.5;
            font-style: italic;
        }
        .paper-meta { 
            color: var(--text-muted); 
            font-size: 13px; 
            margin-bottom: 12px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 16px; 
        }
        .paper-meta-item { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
        }
        .paper-category { 
            background: var(--bg-subtle); 
            padding: 4px 12px; 
            border-radius: 4px; 
            font-size: 12px; 
            color: var(--text-secondary);
            font-style: italic;
        }
        .paper-relevance { font-size: 14px; }
        .paper-relevance .star { color: var(--accent); }
        .paper-abstract-preview { 
            color: var(--text-secondary); 
            font-size: 14px; 
            line-height: 1.7; 
            margin-bottom: 16px; 
        }
        .paper-actions { 
            display: flex; 
            gap: 6px; 
            flex-wrap: wrap;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
        }
        .paper-actions .el-button {
            display: inline-flex;
            flex-direction: row;
            align-items: center;
            padding: 6px 10px;
            border-radius: 8px;
            gap: 4px;
            transition: all 0.25s ease;
        }
        .paper-actions .el-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .paper-actions .el-button .el-icon {
            font-size: 16px;
            margin-right: 0 !important;
        }
        .paper-actions .el-button > span:not(.el-icon) {
            font-size: 12px;
            font-weight: 500;
        }
        
        .paper-detail { 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 1px solid var(--border-light); 
        }
        .ai-summary-section {
            background: linear-gradient(135deg, #f8f7f4 0%, #fff9f0 100%);
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            border-left: 3px solid var(--primary);
        }
        .ai-summary-section h4 {
            color: var(--primary);
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .ai-summary-section .summary-text {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.8;
        }
        .paper-keywords {
            margin-bottom: 20px;
        }
        .paper-keywords h4 {
            color: var(--primary);
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .key-findings { 
            background: #fffbf0; 
            padding: 16px 20px; 
            border-radius: var(--radius-sm); 
            margin-bottom: 20px;
            border-left: 3px solid var(--accent);
        }
        .key-findings h4 { 
            color: var(--accent); 
            font-size: 14px; 
            margin-bottom: 12px; 
            font-weight: 600;
        }
        .key-findings ul { margin: 0; padding-left: 20px; }
        .key-findings li { 
            color: var(--text-secondary); 
            font-size: 13px; 
            line-height: 1.7; 
            margin-bottom: 6px; 
        }
        .paper-figure { 
            margin-bottom: 20px; 
            text-align: center; 
        }
        .paper-figure img { 
            max-width: 100%; 
            max-height: 400px; 
            border-radius: var(--radius-md); 
            cursor: pointer; 
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease;
        }
        .paper-figure img:hover { transform: scale(1.02); }
        .abstract-section { margin-bottom: 20px; }
        .abstract-section h4 { 
            color: var(--primary); 
            font-size: 14px; 
            margin-bottom: 12px; 
            font-weight: 600;
        }
        .abstract-section p { 
            color: var(--text-secondary); 
            font-size: 14px; 
            line-height: 1.8; 
        }
        .abstract-section .translation { 
            background: #f5faf5; 
            padding: 16px 20px; 
            border-radius: var(--radius-sm); 
            margin-top: 16px;
            border-left: 3px solid #67c23a;
        }
        
        /* Search Options */
        .search-options { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            margin-bottom: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }
        .search-options-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; }
        .search-options-row .el-input { flex: 1; min-width: 300px; }
        
        /* Recent Header */
        .recent-header { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 20px 24px; 
            margin-bottom: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 16px; 
        }
        .recent-header .status-info { display: flex; align-items: center; gap: 20px; }
        .recent-header .status-info .label { color: var(--text-muted); font-size: 13px; }
        .recent-header .status-info .value { color: var(--text-primary); font-size: 13px; font-weight: 500; }
        
        /* Sync Status */
        .sync-status-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        .sync-status-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 20px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            text-align: center;
        }
        .sync-status-card .icon { font-size: 28px; margin-bottom: 10px; }
        .sync-status-card .label { color: var(--text-muted); font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .sync-status-card .value { color: var(--text-primary); font-size: 18px; font-weight: 600; }
        .sync-status-card .value.success { color: #67c23a; }
        .sync-status-card .value.warning { color: var(--accent); }
        
        /* Charts */
        .charts-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 24px; 
            margin-bottom: 24px; 
        }
        .chart-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }
        .chart-card h3 { 
            margin-bottom: 20px; 
            color: var(--primary); 
            font-size: 15px;
            font-weight: 600;
        }
        .chart-container { height: 280px; }
        
        /* Sync Options */
        .sync-options { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            margin-bottom: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }
        .sync-options h3 { 
            margin-bottom: 20px; 
            color: var(--primary); 
            font-size: 15px;
            font-weight: 600;
        }
        
        /* Logs */
        .logs-container { 
            background: var(--primary-dark); 
            border-radius: var(--radius-sm); 
            padding: 16px; 
            max-height: 250px; 
            overflow-y: auto; 
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }
        .log-line { 
            color: #a0aec0; 
            margin-bottom: 6px; 
            line-height: 1.5;
        }
        .log-line.success { color: #68d391; }
        .log-line.error { color: #fc8181; }
        
        /* Collections */
        .collections-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .collection-card { 
            background: var(--bg-card); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            cursor: pointer; 
            transition: all 0.3s;
        }
        .collection-card:hover { 
            box-shadow: var(--shadow-md); 
            transform: translateY(-2px);
            border-color: var(--border-medium);
        }
        .collection-card .color-bar { 
            height: 4px; 
            border-radius: 2px; 
            margin-bottom: 16px; 
        }
        .collection-card h4 { 
            color: var(--text-primary); 
            font-size: 16px; 
            margin-bottom: 8px; 
            font-weight: 600;
        }
        .collection-card p { 
            color: var(--text-muted); 
            font-size: 13px; 
            margin-bottom: 12px; 
            line-height: 1.5;
        }
        .collection-card .count { 
            color: var(--text-secondary); 
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Empty State */
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--text-muted); 
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { margin-bottom: 8px; color: var(--text-secondary); font-size: 16px; }
        .empty-state p { font-size: 14px; }
        
        /* Settings Drawer */
        .settings-drawer .el-drawer__header {
            margin-bottom: 0;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
        }
        .settings-drawer .el-drawer__title {
            font-family: Georgia, 'Times New Roman', serif;
            font-weight: 600;
            color: var(--primary);
        }
        .settings-drawer .el-drawer__body {
            padding: 0;
        }
        
        /* Export Bar */
        .export-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }
        
        /* Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }
        
        /* Page transition animation */
        .page-circle-exit {
            animation: circleShrink 0.4s ease forwards;
        }
        @keyframes circleShrink {
            0% {
                clip-path: circle(150% at 50% 50%);
            }
            100% {
                clip-path: circle(0% at 50% 50%);
            }
        }
        
        /* Add to collection animation */
        .fly-to-collection {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            animation: flyToCollection 0.6s ease-in-out forwards;
            overflow: hidden;
        }
        @keyframes flyToCollection {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            50% {
                opacity: 0.8;
                transform: scale(0.6) translateY(-80px);
            }
            100% {
                opacity: 0;
                transform: scale(0.2) translateY(-200px);
            }
        }
        
        /* Paper Basket */
        .cart-widget {
            position: fixed;
            bottom: 24px;
            right: 100px;
            z-index: 1000;
        }
        .cart-trigger {
            cursor: pointer;
        }
        .cart-trigger .el-button {
            width: 56px;
            height: 56px;
            box-shadow: 0 4px 16px rgba(201, 162, 39, 0.4);
            background: linear-gradient(135deg, #c9a227 0%, #d4af37 100%);
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cart-trigger .el-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(201, 162, 39, 0.5);
        }
        .cart-trigger .el-button svg {
            color: white;
            width: 24px;
            height: 24px;
        }
        .cart-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 22px;
            height: 22px;
            background: #f56c6c;
            color: white;
            border-radius: 11px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
        }
        
        /* Panel transition animation */
        .panel-enter-active {
            animation: panelSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .panel-leave-active {
            animation: panelSlideDown 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes panelSlideUp {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes panelSlideDown {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(20px) scale(0.95); }
        }
        
        /* Fade transition animation */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.5s ease;
        }
        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
        
        .cart-panel {
            width: 400px;
            max-height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            cursor: move;
        }
        .cart-panel .cart-header {
            cursor: move;
        }
        .cart-panel .cart-body,
        .cart-panel .cart-footer {
            cursor: default;
        }
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: linear-gradient(135deg, #f5a623 0%, #f7b731 100%);
            color: white;
        }
        .cart-header h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cart-header .collapse-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cart-header .collapse-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .cart-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            max-height: 320px;
        }
        .cart-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-subtle);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .cart-item:last-child {
            margin-bottom: 0;
        }
        .cart-item-info {
            flex: 1;
            min-width: 0;
        }
        .cart-item-title {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .cart-item-meta {
            font-size: 11px;
            color: var(--text-muted);
        }
        .cart-item-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .cart-footer {
            padding: 12px;
            border-top: 1px solid var(--border-light);
            background: var(--bg-white);
        }
        .cart-actions {
            display: flex;
            gap: 8px;
        }
        .cart-actions > * {
            flex: 1;
        }
        .cart-actions .el-button {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 6px;
            gap: 4px;
        }
        .cart-actions .el-button .el-icon {
            font-size: 18px;
            margin-right: 0 !important;
        }
        .cart-actions .el-button > span:not(.el-icon) {
            font-size: 11px;
        }
        .cart-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        .cart-empty svg {
            margin-bottom: 12px;
            opacity: 0.5;
        }
        .chat-trigger .el-button {
            width: 56px;
            height: 56px;
            box-shadow: 0 4px 16px rgba(30, 58, 95, 0.4);
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-trigger .el-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(30, 58, 95, 0.5);
        }
        .chat-trigger .el-button svg {
            color: white;
            width: 24px;
            height: 24px;
        }
        .chat-window {
            width: 480px;
            height: 620px;
            min-width: 360px;
            min-height: 400px;
            max-width: 90vw;
            max-height: 85vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            resize: both;
            cursor: move;
        }
        .chat-window .chat-header {
            cursor: move;
        }
        .chat-window .chat-body,
        .chat-window .chat-input-area {
            cursor: default;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .chat-title {
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-header-actions {
            display: flex;
            gap: 6px;
        }
        .chat-header-actions .el-button {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.15);
            color: white;
            transition: all 0.2s;
        }
        .chat-header-actions .el-button:hover {
            background: rgba(255,255,255,0.25);
        }
        .chat-header-actions .collapse-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chat-header-actions .collapse-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .chat-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .chat-sidebar {
            width: 200px;
            background: var(--bg-subtle);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
        }
        .chat-sidebar-header {
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
        }
        .chat-session-list {
            flex: 1;
            overflow-y: auto;
        }
        .chat-session-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-lighter);
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-session-item:hover {
            background: rgba(30, 58, 95, 0.05);
        }
        .chat-session-item.active {
            background: rgba(30, 58, 95, 0.1);
        }
        .session-info {
            flex: 1;
            overflow: hidden;
        }
        .session-title {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .session-time {
            font-size: 11px;
            color: var(--text-muted);
        }
        .session-delete {
            opacity: 0;
            transition: opacity 0.2s;
            color: var(--text-muted);
        }
        .session-delete:hover {
            color: #f56c6c;
        }
        .chat-session-item:hover .session-delete {
            opacity: 1;
        }
        .no-sessions {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .chat-welcome {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-secondary);
        }
        .chat-welcome h3 {
            margin: 16px 0 8px;
            color: var(--primary);
        }
        .chat-welcome p {
            font-size: 14px;
        }
        .chat-message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .chat-message.user {
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .message-avatar.user {
            background: var(--accent);
            color: white;
        }
        .message-avatar.assistant {
            background: var(--primary);
            color: white;
            font-size: 13px;
            font-weight: 700;
        }
        .message-avatar.assistant span {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .message-content {
            max-width: 75%;
            min-width: 50px;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .chat-message.user .message-content {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message.assistant .message-content {
            background: var(--bg-subtle);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            max-width: 85%;
        }
        .message-papers {
            margin-bottom: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .message-text {
            word-break: break-word;
        }
        .message-text h1, .message-text h2, .message-text h3, .message-text h4 {
            margin: 8px 0 4px;
            color: var(--primary);
            font-family: Georgia, 'Times New Roman', serif;
            font-weight: 600;
        }
        .message-text h1:first-child, .message-text h2:first-child, .message-text h3:first-child { margin-top: 0; }
        .message-text h1 { font-size: 17px; }
        .message-text h2 { font-size: 15px; }
        .message-text h3 { font-size: 14px; }
        .message-text h4 { font-size: 14px; }
        .message-text p { margin: 4px 0; line-height: 1.65; }
        .message-text p:first-child { margin-top: 0; }
        .message-text p:last-child { margin-bottom: 0; }
        .message-text ul, .message-text ol { margin: 4px 0; padding-left: 18px; }
        .message-text li { margin: 2px 0; line-height: 1.55; }
        .message-text code {
            background: var(--bg-subtle);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
        }
        .message-text pre {
            background: var(--primary-dark);
            color: #e2e8f0;
            padding: 10px 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 13px;
        }
        .message-text pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        .message-text blockquote {
            border-left: 3px solid var(--accent);
            margin: 6px 0;
            padding: 4px 12px;
            background: var(--bg-subtle);
            border-radius: 0 6px 6px 0;
            color: var(--text-secondary);
        }
        .message-text a {
            color: var(--primary);
            text-decoration: underline;
        }
        .message-text table {
            border-collapse: collapse;
            margin: 8px 0;
            width: 100%;
            font-size: 13px;
        }
        .message-text th, .message-text td {
            border: 1px solid var(--border-light);
            padding: 6px 10px;
            text-align: left;
        }
        .message-text th {
            background: var(--bg-subtle);
            font-weight: 600;
        }
 .chat-progress {
            padding: 12px 16px;
            background: linear-gradient(135deg, #f0f4f8 0%, #e8f0f8 100%);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--primary);
        }
        .progress-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .progress-header .el-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .progress-message {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .progress-bar-container {
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }
        .progress-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .progress-header .el-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .progress-message {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .progress-bar-container {
            height: 4px;
            background: var(--border-light);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        .selected-papers-bar {
            padding: 8px 16px;
            background: var(--bg-subtle);
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .chat-input-area {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border-light);
            background: white;
        }
        .chat-input-area .el-input {
            flex: 1;
        }

        /* Field Selector Dialog */
        .field-selector-dialog .el-dialog__body {
            padding: 0;
        }
        .field-selector {
            display: flex;
            height: 500px;
            border: 1px solid var(--border-light);
            border-radius: 0 0 8px 8px;
        }
        .field-selector-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-light);
        }
        .field-selector-right {
            width: 280px;
            display: flex;
            flex-direction: column;
            background: var(--bg-subtle);
        }
        .field-selector-search {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
        }
        .field-selector-search .el-input__wrapper {
            border-radius: 8px;
        }
        .field-selector-header {
            padding: 12px 16px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .field-selector-header .toggle-btn {
            font-size: 12px;
            color: var(--primary);
            cursor: pointer;
        }
        .field-selector-header .toggle-btn:hover {
            text-decoration: underline;
        }
        .field-selector-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .field-selector-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .field-group {
            margin-bottom: 2px;
        }
        .field-group-header {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            font-size: 13px;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .field-group-header:hover {
            background: var(--bg-subtle);
        }
        .field-group-header .el-icon {
            margin-right: 6px;
            font-size: 12px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .field-group-header.expanded .el-icon {
            transform: rotate(90deg);
        }
        .field-group-header .recommended-badge {
            font-size: 9px;
            padding: 1px 5px;
            margin-left: 8px;
        }
        .field-group-children {
            margin-left: 16px;
        }
        .field-item {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            transition: all 0.2s;
            gap: 6px;
        }
        .field-item:hover {
            background: #e8f4ff;
            color: var(--primary);
        }
        .field-item.selected {
            background: #e8f4ff;
            color: var(--primary);
        }
        .field-item .star {
            color: var(--accent);
            font-size: 11px;
        }
        .field-selected-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
            border: 1px solid var(--border-light);
        }
        .field-selected-item:hover {
            border-color: var(--primary);
        }
        .field-selected-item .name {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-primary);
        }
        .field-selected-item .star {
            color: var(--accent);
        }
        .field-selected-item .remove-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-muted);
            border-radius: 50%;
            transition: all 0.2s;
        }
        .field-selected-item .remove-btn:hover {
            background: #fee;
            color: #f56c6c;
        }
        .field-selector-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }
        .field-selector-footer .count {
            font-size: 12px;
            color: var(--text-muted);
        }
        .field-selector-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .charts-row { grid-template-columns: 1fr; }
            .collections-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .main-content { padding: 20px; }
            .header-inner { padding: 16px 20px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .sync-status-grid { grid-template-columns: repeat(2, 1fr); }
            .collections-grid { grid-template-columns: 1fr; }
            .field-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="showSetup" class="setup-container">
            <div class="setup-card">
                <h1>arXiv Pulse</h1>
                <p class="subtitle">{{ t('home.subtitle') }}</p>
                
                <div class="setup-steps">
                    <div class="setup-step" :class="setupStep > 1 ? 'done' : (setupStep === 1 ? 'active' : 'pending')">1</div>
                    <div class="setup-step" :class="setupStep > 2 ? 'done' : (setupStep === 2 ? 'active' : 'pending')">2</div>
                    <div class="setup-step" :class="setupStep > 3 ? 'done' : (setupStep === 3 ? 'active' : 'pending')">3</div>
                    <div class="setup-step" :class="setupStep >= 4 ? 'active' : 'pending'">4</div>
                </div>

                <div v-if="setupStep === 1">
                    <h3 style="margin-bottom: 24px; color: var(--primary); font-size: 18px;">{{ t('setup.aiConfig') }}</h3>
                    <el-form label-position="top">
                        <el-form-item :label="t('settings.apiBaseUrl')">
                            <el-input v-model="setupConfig.ai_base_url" placeholder="https://api.openai.com/v1" />
                        </el-form-item>
                        <el-form-item :label="t('settings.apiKey')">
                            <el-input v-model="setupConfig.ai_api_key" type="password" show-password placeholder="Enter your API Key" />
                        </el-form-item>
                        <el-form-item :label="t('settings.modelName')">
                            <el-select v-model="setupConfig.ai_model" filterable allow-create style="width: 100%;">
                                <el-option label="DeepSeek-V3.2" value="DeepSeek-V3.2" />
                                <el-option label="gpt-4o" value="gpt-4o" />
                                <el-option label="gpt-4-turbo" value="gpt-4-turbo" />
                                <el-option label="gpt-3.5-turbo" value="gpt-3.5-turbo" />
                            </el-select>
                        </el-form-item>
                        <el-form-item :label="t('settings.aiLanguage')">
                            <el-select v-model="setupConfig.translate_language" style="width: 100%;">
                                <el-option v-for="lang in aiLanguageOptions" :key="lang.value" :label="lang.label" :value="lang.value" />
                            </el-select>
                        </el-form-item>
                    </el-form>
                    <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                        <el-button @click="testSetupAI" :loading="testingAI">{{ t('settings.testConnection') }}</el-button>
                        <el-button type="primary" @click="setupStep = 2">{{ t('common.next') }}</el-button>
                    </div>
                </div>

                <div v-if="setupStep === 2">
                    <h3 style="margin-bottom: 8px; color: var(--primary); font-size: 18px;">{{ t('setup.selectFields') }}</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">{{ t('setup.fieldsHint') }}</p>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--bg-subtle); border-radius: 10px; cursor: pointer; margin-bottom: 16px;" @click.stop="openFieldSelector('init')">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                {{ currentLang === 'zh' ? '已选择' : 'Selected' }}: {{ setupConfig.selected_fields.length }} {{ currentLang === 'zh' ? '个研究领域' : 'research fields' }}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">
                                {{ setupConfig.selected_fields.slice(0, 3).map(id => allCategories[id]?.name || id).join(', ') }}{{ setupConfig.selected_fields.length > 3 ? '...' : '' }}
                            </div>
                        </div>
                        <div style="padding: 6px 12px; background: var(--primary); color: white; border-radius: 4px; font-size: 13px;">
                            {{ currentLang === 'zh' ? '选择领域' : 'Select Fields' }}
                        </div>
                    </div>
                    
                    <div style="margin-top: 24px; display: flex; justify-content: space-between;">
                        <el-button @click="setupStep = 1">{{ t('common.back') }}</el-button>
                        <el-button type="primary" @click="setupStep = 3" :disabled="setupConfig.selected_fields.length === 0 && setupConfig.search_queries.length === 0">
                            {{ t('common.next') }}
                        </el-button>
                    </div>
                </div>

                <div v-if="setupStep === 3">
                    <h3 style="margin-bottom: 24px; color: var(--primary); font-size: 18px;">{{ t('setup.syncSettings') }}</h3>
                    <el-form label-position="top">
                        <el-form-item :label="t('setup.yearsBack')">
                            <el-select v-model="setupConfig.years_back" style="width: 100%;">
                                <el-option v-for="item in initYearOptions" :key="item.value" :label="item.label" :value="item.value" />
                            </el-select>
                        </el-form-item>
                        <el-form-item :label="t('setup.maxResultsPerField')">
                            <el-input-number v-model="setupConfig.arxiv_max_results_per_field" :min="1000" :max="50000" :step="1000" style="width: 100%;" />
                        </el-form-item>
                    </el-form>
                    <p style="color: var(--text-muted); font-size: 13px; margin-top: 12px;">
                        {{ t('setup.selectedFields', { count: setupConfig.selected_fields.length }) }}
                    </p>
                    <div style="margin-top: 24px; display: flex; justify-content: space-between;">
                        <el-button @click="setupStep = 2">{{ t('common.back') }}</el-button>
                        <el-button type="primary" @click="startInitialSync" :loading="initializing">
                            {{ t('setup.syncBtn') }}
                        </el-button>
                    </div>
                </div>

                <div v-if="setupStep === 4">
                    <h3 style="margin-bottom: 20px; text-align: center; color: var(--primary);">{{ t('setup.syncing') }}</h3>
                    <transition name="fade" mode="out-in">
                        <div key="waiting" v-if="!initComplete" style="text-align: center; margin-bottom: 20px; color: var(--text-muted); font-size: 14px;">
                            {{ waitingMessage }}
                        </div>
                        <div key="complete" v-else style="text-align: center; margin-bottom: 20px; color: #67c23a; font-size: 16px; font-weight: 500;">
                            <el-icon style="vertical-align: middle; margin-right: 6px;"><CircleCheckFilled /></el-icon>
                            {{ t('setup.syncComplete') }}
                        </div>
                    </transition>
                    <div v-if="initProgress > 0 && !initComplete" style="text-align: center; margin-bottom: 16px; color: var(--text-secondary);">
                        {{ t('setup.processing', { current: initCurrentQuery, total: initTotalQueries }) }}
                    </div>
                    <el-progress v-if="initProgress > 0" :percentage="initProgress" :status="initComplete ? 'success' : ''" style="margin-bottom: 24px;" />
                </div>
            </div>
            
            <!-- Setup Language Switcher -->
            <el-button circle class="setup-lang-btn" @click="toggleLanguage">
                {{ currentLang === 'zh' ? 'EN' : '中' }}
            </el-button>
        </div>

        <div v-else class="app-container">
            <!-- Home Page -->
            <div v-if="currentPage === 'home'" class="home-container">
                <div class="home-brand">
                    <h1>arXiv Pulse</h1>
                    <p>{{ t('home.subtitle') }}</p>
                </div>
                
                <div class="home-search-box">
                    <el-input 
                        v-model="homeQuery" 
                        :placeholder="t('home.searchPlaceholder')"
                        size="large"
                        @keyup.enter="startHomeSearch"
                        clearable
                    >
                        <template #prefix>
                            <el-icon><Search /></el-icon>
                        </template>
                    </el-input>
                </div>
                    
                    <div v-if="homeLogs.length > 0" class="logs-container" style="margin-top: 20px; max-height: 200px; max-width: 680px; width: 100%;">
                        <div v-for="(log, index) in homeLogs" :key="index" class="log-line" :class="log.type">
                            > {{ log.message }}
                        </div>
                    </div>
                    
                    <div v-if="homeResults.length > 0" style="margin-top: 24px; max-width: 680px; width: 100%;">
                        <paper-card 
                            v-for="paper in homeResults" 
                            :key="paper.id" 
                            :paper="paper"
                            :collections="collections"
                            :in-cart="isInCart(paper.arxiv_id)"
                            @add-to-collection="addToCollection"
                            @add-to-cart="addToCart"
                            @remove-from-cart="removeFromCartByArxivId"
                        />
                    </div>
                
                <div class="home-stats">
                    <span><el-icon><Document /></el-icon> {{ stats?.papers?.total || 0 }} {{ t('home.totalPapers') }}</span>
                    <span><el-icon><Collection /></el-icon> {{ stats?.collections?.total || 0 }} {{ t('home.totalCollections') }}</span>
                    <span><el-icon><TrendCharts /></el-icon> {{ stats?.papers?.summarized || 0 }} {{ t('home.summarizedPapers') }}</span>
                </div>
                
                <div class="home-hints">
                    {{ t('home.hints') }}
                </div>
                
                <div class="home-footer">
                    <a href="https://github.com/kYangLi/arXiv-Pulse" target="_blank" class="github-link">
                        <svg class="github-icon" viewBox="0 0 24 24" width="18" height="18">
                            <path fill="currentColor" d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                        </svg>
                        GitHub
                    </a>
                </div>
            </div>
            
            <!-- Other Pages with Header -->
            <template v-else>
                <header class="header">
                    <div class="header-inner">
                        <div class="header-brand" style="cursor: pointer;" @click="navigateTo('home')">
                            <h1>arXiv Pulse</h1>
                            <p>{{ t('home.subtitle') }}</p>
                        </div>
                    </div>
                </header>

                <main class="main-content" style="padding-bottom: 100px;">
                    <transition name="page-slide" mode="out-in">
                        <div :key="currentPage">
                            <!-- Recent Papers Page -->
                            <div v-if="currentPage === 'recent'" class="page-content">
                    <div class="search-options" style="margin-bottom: 20px;">
                        <div class="search-options-row">
                            <el-select v-model="recentDays" :placeholder="t('papers.timeRange')" style="width: 120px;">
                                <el-option v-for="item in daysOptions" :key="item.value" :label="item.label" :value="item.value" />
                            </el-select>
                            <el-button @click="openFieldSelector('recent')" style="display: flex; align-items: center; gap: 6px;">
                                <el-icon><Filter /></el-icon>
                                <span v-if="recentCategories.length === 0">{{ currentLang === 'zh' ? '全部领域' : 'All Fields' }}</span>
                                <span v-else style="display: flex; align-items: center; gap: 4px;">
                                    <el-tag size="small" type="info" style="background: #e8f4ff; color: var(--primary); border: none;">
                                        {{ recentCategories.length }} {{ currentLang === 'zh' ? '个领域' : 'fields' }}
                                    </el-tag>
                                </span>
                            </el-button>
                            <el-checkbox v-model="recentNeedSync" style="margin: 0 10px;">{{ t('papers.syncNewPapers') }}</el-checkbox>
                            <el-button type="primary" @click="updateRecentPapers" :loading="updatingRecent">
                                <el-icon><Refresh /></el-icon> {{ t('papers.update') }}
                            </el-button>
                        </div>
                    </div>

                    <div v-if="recentLogs.length > 0" class="logs-container" style="margin-bottom: 20px;">
                        <div v-for="(log, index) in recentLogs" :key="index" class="log-line">
                            > {{ log }}
                        </div>
                    </div>

                    <div v-if="recentPapers.length > 0">
                        <paper-card 
                            v-for="paper in recentPapers" 
                            :key="paper.id" 
                            :paper="paper"
                            :collections="collections"
                            :in-cart="isInCart(paper.arxiv_id)"
                            @add-to-collection="addToCollection"
                            @add-to-cart="addToCart"
                            @remove-from-cart="removeFromCartByArxivId"
                        />
                    </div>
                    <div v-else class="empty-state">
                        <div class="icon"><el-icon><Document /></el-icon></div>
                        <h3>{{ t('papers.noPapers') }}</h3>
                        <p>{{ t('papers.noPapersHint') }}</p>
                    </div>
                </div>

            <!-- Sync Page -->
            <div v-else-if="currentPage === 'sync'" class="page-content">
                <div class="sync-status-grid">
                        <div class="sync-status-card">
                            <div class="label">{{ t('sync.status') }}</div>
                            <div class="value" :class="syncStatusClass">{{ syncStatusText }}</div>
                        </div>
                        <div class="sync-status-card">
                            <div class="label">{{ t('sync.lastSync') }}</div>
                            <div class="value" :class="syncTimeClass">{{ formatSyncTime }}</div>
                        </div>
                        <div class="sync-status-card">
                            <div class="label">{{ t('sync.researchFields') }}</div>
                            <div class="value">{{ fieldStats.filter(f => f.is_selected).length }}</div>
                        </div>
                        <div class="sync-status-card">
                            <div class="label">{{ t('sync.totalPapers') }}</div>
                            <div class="value">{{ stats?.papers?.total || 0 }}</div>
                        </div>
                    </div>

                    <div class="sync-options">
                        <h3>{{ t('sync.syncSettings') }}</h3>
                        <el-form label-position="top">
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
                                <el-form-item :label="t('sync.yearsBack')">
                                    <el-select v-model="syncYearsBack" style="width: 120px;">
                                        <el-option v-for="item in syncYearsBackOptions" :key="item.value" :label="item.label" :value="item.value" />
                                    </el-select>
                                </el-form-item>
                                <el-form-item :label="t('sync.forceSync')">
                                    <el-switch v-model="syncForce" />
                                </el-form-item>
                                <el-form-item label=" ">
                                    <el-button type="primary" @click="startSync" :loading="syncing">
                                        <el-icon><Refresh /></el-icon> {{ t('sync.startSync') }}
                                    </el-button>
                                </el-form-item>
                            </div>
                        </el-form>
                        <p style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">
                            {{ currentLang === 'zh' ? '同步年份覆盖默认设置。全局默认在左下角设置中配置。' : 'Sync years override default. Configure global defaults in Settings.' }}
                        </p>
                    </div>

                    <div v-if="syncLogs.length > 0" class="logs-container">
                        <div v-for="(log, index) in syncLogs" :key="index" class="log-line" :class="log.type">
                            > {{ log.message }}
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-card">
                            <h3>{{ t('sync.yearDistribution') }}</h3>
                            <div id="yearChart" class="chart-container"></div>
                        </div>
                        <div class="chart-card">
                            <h3>热门研究领域</h3>
                            <div id="categoryChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>

            <!-- Collections Page -->
            <div v-else-if="currentPage === 'collections'" class="page-content">
                <div style="margin-bottom: 20px;">
                        <el-button type="primary" @click="showCreateCollection = true">
                            <el-icon><Plus /></el-icon> {{ t('collections.create') }}
                        </el-button>
                    </div>

                    <div v-if="collections.length > 0" class="collections-grid">
                        <div v-for="collection in collections" :key="collection.id" 
                             class="collection-card" @click="openCollectionDetail(collection)">
                            <div class="color-bar" :style="{ background: collection.color }"></div>
                            <h4>{{ collection.name }}</h4>
                            <p>{{ collection.description || t('collections.noDescription') }}</p>
                            <div class="count">
                                <el-icon><Document /></el-icon>
                                {{ collection.paper_count || 0 }} {{ t('collections.papers') }}
                            </div>
                        </div>
                    </div>
                    <div v-else class="empty-state">
                        <div class="icon"><el-icon><Folder /></el-icon></div>
                        <h3>{{ t('collections.noCollections') }}</h3>
                        <p>{{ t('collections.createHint') }}</p>
                    </div>
                </div>
            </div>
        </transition>
    </main>
</template>

            <!-- Settings Drawer -->
            <el-drawer v-model="showSettings" :title="t('settings.title')" size="480px" class="settings-drawer">
                <div style="padding: 24px;">
                    <!-- UI Language -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 12px 16px; background: var(--bg-subtle); border-radius: 10px;">
                        <span>
                            <span :style="{ fontWeight: currentLang === 'zh' ? 600 : 400, opacity: currentLang === 'zh' ? 1 : 0.5 }">界面语言</span>
                            <span style="margin: 0 6px; opacity: 0.3;">/</span>
                            <span :style="{ fontWeight: currentLang === 'en' ? 600 : 400, opacity: currentLang === 'en' ? 1 : 0.5 }">UI Language</span>
                        </span>
                        <el-radio-group v-model="currentLang" size="small" @change="onLanguageChange">
                            <el-radio-button label="zh">中文</el-radio-button>
                            <el-radio-button label="en">EN</el-radio-button>
                        </el-radio-group>
                    </div>
                    
                    <div class="settings-section">
                        <h3>{{ t('settings.aiConfig') }}</h3>
                        <el-form label-position="top">
                            <el-form-item :label="t('settings.apiBaseUrl')">
                                <el-input v-model="settingsConfig.ai_base_url" />
                            </el-form-item>
                            <el-form-item :label="t('settings.apiKey')">
                                <el-input v-model="settingsConfig.ai_api_key" type="password" show-password>
                                    <template #append>
                                        <el-button type="primary" @click="saveApiKey" :loading="savingSettings">{{ t('settings.updateKey') }}</el-button>
                                    </template>
                                </el-input>
                            </el-form-item>
                            <el-form-item :label="t('settings.modelName')">
                                <el-input v-model="settingsConfig.ai_model" />
                            </el-form-item>
                            <el-form-item :label="t('settings.aiLanguage')">
                                <el-select v-model="settingsConfig.translate_language" style="width: 100%;">
                                    <el-option v-for="lang in aiLanguageOptions" :key="lang.value" :label="lang.label" :value="lang.value" />
                                </el-select>
                                <p style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">{{ t('settings.aiLanguageHint') }}</p>
                            </el-form-item>
                            <el-form-item>
                                <el-button @click="testAIConnection" :loading="testingAI">{{ t('settings.testConnection') }}</el-button>
                            </el-form-item>
                        </el-form>
                    </div>

                    <div class="settings-section">
                        <h3>{{ t('settings.researchFields') }}</h3>
                        <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 12px;">
                            {{ t('settings.fieldsHint') }}
                        </p>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-subtle); border-radius: 8px; cursor: pointer;" @click="openFieldSelector('settings')">
                            <span style="font-size: 13px; color: var(--text-primary);">
                                {{ currentLang === 'zh' ? '已选择' : 'Selected' }}: {{ settingsConfig.selected_fields?.length || 0 }} {{ currentLang === 'zh' ? '个领域' : 'fields' }}
                            </span>
                            <el-icon><ArrowRight /></el-icon>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>{{ t('settings.syncSettings') }}</h3>
                        <el-form label-position="top">
                            <el-form-item :label="t('settings.yearsBack')">
                                <el-select v-model="settingsConfig.years_back" style="width: 100%;">
                                    <el-option v-for="item in initYearOptions" :key="item.value" :label="item.label" :value="item.value" />
                                </el-select>
                            </el-form-item>
                            <el-form-item :label="t('settings.maxResultsPerField')">
                                <el-input-number v-model="settingsConfig.arxiv_max_results_per_field" :min="1000" :max="50000" :step="1000" style="width: 100%;" />
                            </el-form-item>
                            <el-form-item :label="t('settings.arxivMaxResults')">
                                <el-input-number v-model="settingsConfig.arxiv_max_results" :min="10000" :max="200000" :step="10000" style="width: 100%;" />
                            </el-form-item>
                            <el-form-item :label="t('settings.recentPapersLimit')">
                                <el-input-number v-model="settingsConfig.recent_papers_limit" :min="20" :max="200" :step="10" style="width: 100%;" />
                            </el-form-item>
                        </el-form>
                    </div>
                </div>
            </el-drawer>

            <!-- Dialogs -->
            <el-dialog v-model="showCreateCollection" :title="t('collections.create')" width="480px">
                <el-form label-position="top">
                    <el-form-item :label="t('collections.name')">
                        <el-input v-model="newCollection.name" :placeholder="t('collections.name')" />
                    </el-form-item>
                    <el-form-item :label="t('collections.description')">
                        <el-input v-model="newCollection.description" type="textarea" rows="3" :placeholder="t('collections.description')" />
                    </el-form-item>
                    <el-form-item :label="t('collections.color')">
                        <el-color-picker v-model="newCollection.color" />
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="showCreateCollection = false">{{ t('common.cancel') }}</el-button>
                    <el-button type="primary" @click="saveCollection" :loading="savingCollection">{{ t('common.confirm') }}</el-button>
                </template>
            </el-dialog>

            <el-dialog v-model="showAddToCollection" :title="t('collections.addToCollection')" width="400px">
                <p style="margin-bottom: 12px; color: var(--text-secondary);">
                    {{ t('collections.addPapersTo', { count: paperCart.length > 0 ? paperCart.length : 1 }) }}
                </p>
                <div v-if="selectedPaper?.collection_ids?.length > 0" style="margin-bottom: 12px; padding: 8px 12px; background: var(--bg-subtle); border-radius: 8px;">
                    <span style="color: var(--text-muted); font-size: 12px;">{{ t('collections.alreadyIn') }}: </span>
                    <el-tag v-for="cid in selectedPaper.collection_ids" :key="cid" size="small" style="margin: 2px;">
                        {{ collections.find(c => c.id === cid)?.name || '#' + cid }}
                    </el-tag>
                </div>
                <el-select v-model="selectedCollectionId" :placeholder="t('collections.selectPlaceholder')" style="width: 100%;">
                    <el-option v-for="c in collections" :key="c.id" :label="c.name" :value="c.id" />
                </el-select>
                <template #footer>
                    <el-button @click="showAddToCollection = false">{{ t('common.cancel') }}</el-button>
                    <el-button type="primary" @click="confirmAddToCollection" :loading="addingToCollection">{{ t('common.add') }}</el-button>
                </template>
            </el-dialog>

            <el-dialog v-model="viewingCollection" :title="viewingCollection?.name" width="800px">
                <div v-if="loadingCollectionPapers" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading" style="font-size: 32px;"><Loading /></el-icon>
                </div>
                <div v-else-if="collectionPapers.length > 0">
                    <div class="export-bar">
                        <span style="color: var(--text-secondary);">{{ collectionPapers.length }} {{ t('collections.papers') }}</span>
                        <el-dropdown @command="exportCollection">
                            <el-button type="primary" plain>
                                <el-icon><Download /></el-icon> {{ t('collections.exportCollection') }}
                                <el-icon class="el-icon--right"><ArrowDown /></el-icon>
                            </el-button>
                            <template #dropdown>
                                <el-dropdown-menu>
                                    <el-dropdown-item command="markdown">Markdown (.md)</el-dropdown-item>
                                    <el-dropdown-item command="pdf">{{ t('export.pdfDoc') }}</el-dropdown-item>
                                    <el-dropdown-item command="csv">{{ t('export.csvTable') }}</el-dropdown-item>
                                    <el-dropdown-item command="bibtex">BibTeX (.bib)</el-dropdown-item>
                                </el-dropdown-menu>
                            </template>
                        </el-dropdown>
                    </div>
                    <paper-card 
                        v-for="paper in collectionPapers" 
                        :key="paper.id" 
                        :paper="paper"
                        :collections="collections"
                        :in-collection="true"
                        :in-cart="isInCart(paper.arxiv_id)"
                        @add-to-collection="addToCollection"
                        @remove-from-collection="removePaperFromCollection"
                        @add-to-cart="addToCart"
                        @remove-from-cart="removeFromCartByArxivId"
                    />
                </div>
                <div v-else class="empty-state">
                    <p>{{ t('collections.noPapersInCollection') }}</p>
                </div>
            </el-dialog>

            <el-dialog v-model="showDeleteConfirm" :title="t('common.confirmDelete')" width="400px">
                <p>{{ t('collections.deleteConfirm', { name: deletingCollection?.name }) }}</p>
                <template #footer>
                    <el-button @click="showDeleteConfirm = false">{{ t('common.cancel') }}</el-button>
                    <el-button type="danger" @click="deleteCollection" :loading="deletingCollectionInProgress">{{ t('common.delete') }}</el-button>
                </template>
            </el-dialog>
        </div>

        <!-- Field Selector Dialog (Global - accessible from setup and main app) -->
        <el-dialog 
            v-model="showFieldSelector" 
            width="800px" 
            :close-on-click-modal="false"
            append-to-body
        >
            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px; font-weight: 500; color: var(--text-primary);">
                    {{ t('fields.selectFields') }}
                </div>
                <el-tooltip :content="fieldAdvancedMode ? t('fields.switchToVisual') : t('fields.switchToCode')" placement="top">
                    <el-button 
                        :type="fieldAdvancedMode ? 'primary' : 'default'" 
                        size="small" 
                        @click="fieldAdvancedMode = !fieldAdvancedMode"
                        style="display: flex; align-items: center; gap: 4px;"
                    >
                        <el-icon style="font-size: 14px;"><Document /></el-icon>
                        <span style="font-size: 12px;">{{ fieldAdvancedMode ? t('fields.visualMode') : t('fields.codeMode') }}</span>
                    </el-button>
                </el-tooltip>
            </div>
            
            <div class="field-selector">
                <div class="field-selector-left">
                    <template v-if="fieldAdvancedMode">
                        <div style="background: #1e1e1e; border-radius: 8px 0 0 0; overflow: hidden;">
                            <el-input
                                v-model="advancedQueriesText"
                                type="textarea"
                                :rows="14"
                                :placeholder="t('fields.advancedPlaceholder')"
                                style="--el-input-bg-color: #1e1e1e; --el-input-text-color: #d4d4d4; --el-input-border-color: #3c3c3c; --el-input-placeholder-color: #6a6a6a;"
                                input-style="font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 13px; line-height: 1.6; background: #1e1e1e; color: #d4d4d4;"
                            />
                        </div>
                        <div style="padding: 8px 12px; background: #252526; font-size: 11px; color: #8a8a8a; border-radius: 0 0 0 8px; display: flex; justify-content: space-between;">
                            <span>{{ advancedQueriesLines.length }} {{ currentLang === 'zh' ? '条查询' : 'queries' }}</span>
                            <span style="color: #6a6a6a;">arXiv API</span>
                        </div>
                    </template>
                    <template v-else>
                        <div class="field-selector-search">
                            <el-input v-model="fieldSearchQuery" :placeholder="t('fields.searchPlaceholder')" clearable>
                                <template #prefix>
                                    <el-icon><Search /></el-icon>
                                </template>
                            </el-input>
                        </div>
                        <div class="field-selector-tree">
                            <template v-for="(group, groupKey) in filteredCategories" :key="groupKey">
                                <div class="field-group">
                                    <div class="field-group-header" :class="{ expanded: fieldSelectorExpanded[groupKey] }" @click="toggleFieldSelectorGroup(groupKey)">
                                        <el-icon><ArrowRight /></el-icon>
                                        <span>{{ currentLang === 'zh' ? group.name : group.name_en }}</span>
                                        <span v-if="group.recommended" class="recommended-badge">{{ t('fields.recommended') }}</span>
                                    </div>
                                    <div v-show="fieldSelectorExpanded[groupKey]" class="field-group-children">
                                        <template v-for="(cat, catKey) in group.children" :key="catKey">
                                            <div v-if="cat.children" class="field-group">
                                                <div class="field-group-header" :class="{ expanded: fieldSelectorExpanded[catKey] }" @click.stop="toggleFieldSelectorGroup(catKey)">
                                                    <el-icon><ArrowRight /></el-icon>
                                                    <span>{{ currentLang === 'zh' ? cat.name : cat.name_en }}</span>
                                                </div>
                                                <div v-show="fieldSelectorExpanded[catKey]" class="field-group-children">
                                                    <div v-for="(subcat, subcatKey) in cat.children" :key="subcatKey"
                                                         class="field-item"
                                                         :class="{ selected: tempSelectedFields.includes(subcat.id) }"
                                                         @click="toggleTempField(subcat.id)">
                                                        <el-checkbox :model-value="tempSelectedFields.includes(subcat.id)" />
                                                        <span v-if="subcat.recommended" class="star">⭐</span>
                                                        <span>{{ currentLang === 'zh' ? subcat.name : subcat.name_en }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else
                                                 class="field-item"
                                                 :class="{ selected: tempSelectedFields.includes(cat.id) }"
                                                 @click="toggleTempField(cat.id)">
                                                <el-checkbox :model-value="tempSelectedFields.includes(cat.id)" />
                                                <span v-if="cat.recommended" class="star">⭐</span>
                                                <span>{{ currentLang === 'zh' ? cat.name : cat.name_en }}</span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                <div class="field-selector-right">
                    <div class="field-selector-header">
                        <span>{{ currentLang === 'zh' ? '已选择' : 'Selected' }}</span>
                        <span class="toggle-btn" v-if="!fieldAdvancedMode && tempSelectedFields.length > 0" @click="clearTempSelection">{{ currentLang === 'zh' ? '清空' : 'Clear' }}</span>
                    </div>
                    <div class="field-selector-list">
                        <template v-if="!fieldAdvancedMode">
                            <div v-if="tempSelectedFields.length === 0" class="field-selector-empty">
                                {{ currentLang === 'zh' ? '点击左侧领域添加' : 'Click fields to add' }}
                            </div>
                            <div v-for="fieldId in tempSelectedFields" :key="fieldId" class="field-selected-item">
                                <div class="name">
                                    <span v-if="allCategories[fieldId]?.recommended" class="star">⭐</span>
                                    <span>{{ currentLang === 'zh' ? allCategories[fieldId]?.name : allCategories[fieldId]?.name_en }}</span>
                                    <span style="color: var(--text-muted); font-size: 11px; margin-left: 4px;">{{ fieldId }}</span>
                                </div>
                                <div class="remove-btn" @click="removeFromTempSelection(fieldId)">
                                    <el-icon><Close /></el-icon>
                                </div>
                            </div>
                        </template>
                        <template v-else>
                            <div v-if="advancedQueriesLines.length === 0" class="field-selector-empty">
                                {{ currentLang === 'zh' ? '在左侧输入查询语句' : 'Enter queries on the left' }}
                            </div>
                            <template v-else>
                                <div v-if="parsedCodeResult.standardFields.length > 0" style="margin-bottom: 8px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">{{ currentLang === 'zh' ? '标准分类' : 'Standard' }}</div>
                                    <div v-for="fieldId in parsedCodeResult.standardFields" :key="fieldId" class="field-selected-item" style="background: #e8f4ff;">
                                        <div class="name">
                                            <span v-if="allCategories[fieldId]?.recommended" class="star">⭐</span>
                                            <span style="color: var(--primary);">{{ currentLang === 'zh' ? allCategories[fieldId]?.name : allCategories[fieldId]?.name_en }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="parsedCodeResult.customQueries.length > 0">
                                    <div style="font-size: 11px; color: #e6a23c; margin-bottom: 4px;">{{ currentLang === 'zh' ? '自定义规则' : 'Custom' }}</div>
                                    <div v-for="(query, idx) in parsedCodeResult.customQueries" :key="idx" class="field-selected-item" style="background: #fdf6ec; border-color: #e6a23c;">
                                        <div class="name" style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: #e6a23c;">
                                            {{ query }}
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </div>
                    <div class="field-selector-footer">
                        <span class="count">
                            <template v-if="!fieldAdvancedMode">
                                {{ tempSelectedFields.length }} {{ currentLang === 'zh' ? '个领域' : 'fields' }}
                            </template>
                            <template v-else>
                                {{ advancedQueriesLines.length }} {{ currentLang === 'zh' ? '条查询' : 'queries' }}
                                <span v-if="parsedCodeResult.customQueries.length > 0" style="color: #e6a23c;"> ({{ parsedCodeResult.customQueries.length }} {{ currentLang === 'zh' ? '自定义' : 'custom' }})</span>
                            </template>
                        </span>
                    </div>
                </div>
            </div>
            <template #footer>
                <el-button @click="showFieldSelector = false">{{ t('common.cancel') }}</el-button>
                <el-button type="primary" @click="confirmFieldSelection">{{ t('common.confirm') }}</el-button>
            </template>
        </el-dialog>

        <!-- Bottom Navigation Bar -->
        <div v-if="!showSetup" class="bottom-nav" @mouseenter="(e) => e.currentTarget.style.cursor='default'">
            <div class="nav-items-wrapper">
                <div class="nav-item" :class="{ active: currentPage === 'home' }" @click="navigateTo('home')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                    <span>{{ t('nav.home') }}</span>
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'recent' }" @click="navigateTo('recent')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    <span>{{ t('nav.recent') }}</span>
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'sync' }" @click="navigateTo('sync')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                    </svg>
                    <span>{{ t('nav.sync') }}</span>
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'collections' }" @click="navigateTo('collections')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                    </svg>
                    <span>{{ t('nav.collections') }}</span>
                </div>
            </div>
        </div>

        <!-- Paper Basket Panel -->
        <transition name="panel">
            <div v-if="!showSetup && showCart" 
                 class="cart-panel" 
                 ref="cartPanelRef"
                 :style="{ position: 'fixed', left: cartPosition.x + 'px', top: cartPosition.y + 'px', zIndex: 1000 }"
                 @mousedown="startDragCart">
                <div class="cart-header">
                    <h3>
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                        </svg>
                        {{ t('basket.title') }}
                        <span v-if="paperCart.length > 0" style="opacity: 0.7; font-weight: 400;">({{ paperCart.length }})</span>
                    </h3>
                    <div class="collapse-btn" @click.stop="showCart = false" :title="currentLang === 'zh' ? '收起' : 'Collapse'">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/>
                        </svg>
                    </div>
                </div>
                <div class="cart-body">
                    <div v-if="paperCart.length === 0" class="cart-empty">
                        <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor" style="opacity: 0.5;">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        <p style="margin-top: 12px; color: var(--text-muted);">{{ t('basket.empty') }}</p>
                        <p style="font-size: 12px; color: var(--text-muted);">{{ t('basket.emptyHint') }}</p>
                    </div>
                    <div v-for="(paper, index) in paperCart" :key="paper.arxiv_id" class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-title">{{ paper.title }}</div>
                            <div class="cart-item-meta">{{ paper.arxiv_id }} · {{ formatDate(paper.published) }}</div>
                        </div>
                        <div class="cart-item-actions">
                            <el-button text size="small" @click="removeFromCart(index)" :title="t('common.delete')">
                                <el-icon><Delete /></el-icon>
                            </el-button>
                        </div>
                    </div>
                </div>
                <div v-if="paperCart.length > 0" class="cart-footer">
                    <div class="cart-actions">
                        <el-dropdown @command="exportCart" placement="top">
                            <el-button type="primary" plain>
                                <el-icon><Download /></el-icon> {{ t('basket.export') }}
                            </el-button>
                            <template #dropdown>
                                <el-dropdown-menu>
                                    <el-dropdown-item command="markdown">Markdown</el-dropdown-item>
                                    <el-dropdown-item command="pdf">PDF</el-dropdown-item>
                                    <el-dropdown-item command="pdf_original">PDF (Original)</el-dropdown-item>
                                    <el-dropdown-item command="csv">CSV</el-dropdown-item>
                                    <el-dropdown-item command="bibtex">BibTeX</el-dropdown-item>
                                </el-dropdown-menu>
                            </template>
                        </el-dropdown>
                        <el-button @click="addCartToCollection" plain>
                            <el-icon><Folder /></el-icon> {{ t('basket.addToCollection') }}
                        </el-button>
                        <el-button @click="copyCartLinks" type="info" plain>
                            <el-icon><Tickets /></el-icon> {{ t('basket.copyLinks') }}
                        </el-button>
                        <el-button @click="clearCart" type="danger" plain>
                            <el-icon><Delete /></el-icon> {{ t('basket.clear') }}
                        </el-button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Floating Buttons Left (Language + Settings) -->
        <div v-if="!showSetup" class="floating-buttons-left">
            <el-button circle class="lang-btn" @click="toggleLanguage">
                {{ currentLang === 'zh' ? 'EN' : '中' }}
            </el-button>
            <el-button circle class="settings-btn" @click="showSettings = true">
                <el-icon><Setting /></el-icon>
            </el-button>
        </div>

        <!-- Floating Buttons Right (Cart + Chat) -->
        <div v-if="!showSetup" class="floating-buttons-right">
            <el-badge :value="paperCart.length" :hidden="paperCart.length === 0" :max="9">
                <el-button circle class="cart-fab-btn" @click="showCart = !showCart">
                    <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor">
                        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                </el-button>
            </el-badge>
            <el-badge :value="chatUnreadCount" :hidden="chatUnreadCount === 0" :max="9">
                <el-button circle class="chat-fab-btn" @click="toggleChat">
                    <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                    </svg>
                </el-button>
            </el-badge>
        </div>

        <!-- AI Chat Window -->
        <transition name="panel">
            <div v-if="!showSetup && chatExpanded" 
                 class="chat-window" 
                 ref="chatPanelRef"
                 :style="{ position: 'fixed', left: chatPosition.x + 'px', top: chatPosition.y + 'px', zIndex: 999 }"
                 @mousedown="startDragChat">
                <div class="chat-header">
                    <span class="chat-title">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                        </svg>
                        {{ t('chat.title') }}
                    </span>
                    <div class="chat-header-actions">
                        <el-button text @click.stop="createNewChat" :title="t('chat.newChat')">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                        </el-button>
                        <div class="collapse-btn" @click.stop="chatExpanded = false" :title="currentLang === 'zh' ? '收起' : 'Collapse'">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="chat-body">
                    <div class="chat-sidebar" v-show="showChatSidebar">
                        <div class="chat-sidebar-header">
                            <span>{{ t('chat.history') }}</span>
                            <el-button text size="small" @click="showChatSidebar = false">
                                <el-icon><ArrowLeft /></el-icon>
                            </el-button>
                        </div>
                        <div class="chat-session-list">
                            <div 
                                v-for="session in chatSessions" 
                                :key="session.id" 
                                class="chat-session-item"
                                :class="{ active: currentChatSession?.id === session.id }"
                            >
                                <div class="session-info" @click="selectChatSession(session)">
                                    <div class="session-title">{{ session.title }}</div>
                                    <div class="session-time">{{ formatChatTime(session.updated_at) }}</div>
                                </div>
                                <el-button 
                                    class="session-delete" 
                                    text 
                                    size="small" 
                                    @click.stop="deleteChatSession(session)"
                                    :title="t('common.delete')"
                                >
                                    <el-icon><Delete /></el-icon>
                                </el-button>
                            </div>
                            <div v-if="chatSessions.length === 0" class="no-sessions">
                                {{ t('chat.noSession') }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-main">
                        <div class="chat-messages" ref="chatMessagesContainer" @scroll="handleChatScroll">
                            <div v-if="chatMessages.length === 0" class="chat-welcome">
                                <el-icon size="48" color="#c9a227"><ChatDotRound /></el-icon>
                                <h3>{{ t('chat.title') }}</h3>
                                <p>{{ t('chat.welcome') }}</p>
                            </div>
                            <div v-for="msg in chatMessages" :key="msg.id" class="chat-message" :class="msg.role">
                                <div v-if="msg.role === 'user'" class="message-avatar user">
                                    <el-icon><User /></el-icon>
                                </div>
                                <div class="message-content">
                                    <div v-if="msg.paper_ids?.length" class="message-papers">
                                        <el-tag v-for="pid in msg.paper_ids" :key="pid" size="small" type="info">{{ pid }}</el-tag>
                                    </div>
                                    <div class="message-text" v-html="formatChatMessage(msg.content)"></div>
                                </div>
                                <div v-if="msg.role === 'assistant'" class="message-avatar assistant">
                                    <span>AI</span>
                                </div>
                            </div>
                            <div v-if="chatTyping" class="chat-message assistant">
                                <div class="message-avatar assistant">
                                    <span>AI</span>
                                </div>
                                <div class="message-content">
                                    <div v-if="chatProgress" class="chat-progress">
                                        <div class="progress-header">
                                            <el-icon class="is-loading"><Loading /></el-icon>
                                            <span class="progress-message">{{ chatProgress.message }}</span>
                                        </div>
                                        <div v-if="chatProgress.progress" class="progress-bar-container">
                                            <div class="progress-bar" :style="{ width: chatProgress.progress + '%' }"></div>
                                        </div>
                                        <div v-if="chatProgress.textLength || chatProgress.pageCount" class="progress-details">
                                            <span v-if="chatProgress.textLength">{{ chatProgress.textLength.toLocaleString() }} 字符</span>
                                            <span v-if="chatProgress.pageCount">{{ chatProgress.pageCount }} 页</span>
                                        </div>
                                    </div>
                                    <div v-else-if="chatMessages.length > 0 && chatMessages[chatMessages.length - 1].role === 'assistant'" class="message-text" v-html="formatChatMessage(chatMessages[chatMessages.length - 1].content, true)"></div>
                                    <div v-else class="typing-indicator">
                                        <span></span><span></span><span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div v-if="selectedChatPapers.length > 0" class="selected-papers-bar">
                            <span>{{ t('chat.selectedPapers', { count: selectedChatPapers.length }) }}</span>
                            <el-tag 
                                v-for="paper in selectedChatPapers" 
                                :key="paper.arxiv_id" 
                                closable 
                                size="small"
                                @close="removeSelectedChatPaper(paper.arxiv_id)"
                            >
                                {{ paper.title?.slice(0, 20) }}...
                            </el-tag>
                        </div>
                        
                        <div class="chat-input-area">
                            <el-button text @click="showChatSidebar = !showChatSidebar" :title="t('chat.history')">
                                <el-icon><List /></el-icon>
                            </el-button>
                            <el-input
                                v-model="chatInput"
                                :placeholder="t('chat.inputPlaceholder')"
                                @keyup.enter="sendChatMessage"
                                :disabled="chatTyping"
                            />
                            <el-button type="primary" @click="sendChatMessage" :loading="chatTyping" :disabled="!chatInput.trim()">
                                <el-icon><Promotion /></el-icon>
                            </el-button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script src="libs/vue/vue.global.prod.js"></script>
    <script src="libs/element-plus/index.full.js"></script>
    <script src="libs/element-plus/icons.iife.min.js"></script>
    <script src="libs/echarts/echarts.min.js"></script>
    <script src="libs/marked/marked.min.js"></script>
    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        const API_BASE = '/api';

        // i18n translations
        const i18n = {
            zh: {
                nav: {
                    home: '首页',
                    recent: '近期论文',
                    sync: '同步管理',
                    collections: '论文集',
                    settings: '设置'
                },
                common: {
                    search: '搜索',
                    update: '更新',
                    export: '导出',
                    cancel: '取消',
                    save: '保存',
                    delete: '删除',
                    edit: '编辑',
                    confirm: '确认',
                    add: '添加',
                    loading: '加载中...',
                    noData: '暂无数据',
                    success: '成功',
                    error: '错误',
                    confirmDelete: '确认删除',
                    next: '下一步',
                    back: '上一步'
                },
                home: {
                    title: 'arXiv Pulse',
                    subtitle: '智能学术文献追踪与分析系统',
                    searchPlaceholder: '输入 arXiv ID、关键词或自然语言描述搜索论文...',
                    searchBtn: '搜索',
                    hints: '支持 arXiv ID 或 URL 精准搜索；支持自然语言搜索，如"机器学习在材料设计中的应用"',
                    recentPapers: '近期论文',
                    syncManage: '同步管理',
                    paperCollections: '论文集',
                    totalPapers: '篇论文',
                    totalCollections: '个论文集',
                    summarizedPapers: '篇已总结'
                },
                papers: {
                    recentPapers: '近期论文',
                    update: '更新',
                    startSync: '开始同步',
                    never: '从未',
                    noPapers: '暂无论文',
                    noPapersHint: '点击"更新"获取最新文献',
                    syncNow: '立即同步',
                    latestSync: '最近同步',
                    daysAgo: '天前',
                    justNow: '刚刚',
                    timeRange: '时间范围',
                    limit: '数量限制',
                    categoryFilter: '领域过滤',
                    syncNewPapers: '同步新论文',
                    yearsBack: '回溯年数'
                },
                sync: {
                    status: '同步状态',
                    lastSync: '上次同步',
                    researchFields: '研究领域',
                    totalPapers: '总论文数',
                    syncSettings: '同步设置',
                    forceSync: '强制同步',
                    startSync: '开始同步',
                    yearsBack: '回溯年数',
                    yearDistribution: '文献年份分布',
                    categoryDistribution: '热门领域研究',
                    noCache: '无缓存',
                    neverSynced: '从未同步',
                    completed: '已完成',
                    inProgress: '进行中'
                },
                collections: {
                    title: '论文集',
                    create: '新建论文集',
                    name: '名称',
                    description: '描述',
                    color: '颜色',
                    papers: '篇论文',
                    noCollections: '暂无论文集',
                    noDescription: '暂无描述',
                    createHint: '创建论文集来整理你感兴趣的文献',
                    noPapersInCollection: '该论文集暂无论文',
                    deleteConfirm: '确定要删除论文集 "{name}" 吗？此操作不可恢复。',
                    exportCollection: '导出论文集',
                    addToCollection: '添加到论文集',
                    addPapersTo: '将 {count} 篇论文添加到论文集',
                    alreadyIn: '已在论文集中',
                    selectPlaceholder: '选择论文集'
                },
                export: {
                    pdfDoc: 'PDF 文档',
                    csvTable: 'CSV 表格'
                },
                settings: {
                    title: '系统设置',
                    uiLanguage: '界面语言',
                    aiConfig: 'AI 设置',
                    apiBaseUrl: 'API Base URL',
                    apiKey: 'API Key',
                    modelName: '模型名称',
                    testConnection: '测试连接',
                    researchFields: '研究领域',
                    fieldsHint: '已有论文的领域取消后仅停止同步，不会删除已有论文',
                    syncSettings: '同步设置',
                    yearsBack: '默认同步年份',
                    arxivMaxResults: '全局最大论文数',
                    maxResultsPerField: '每领域最大论文数',
                    recentPapersLimit: '近期论文默认数量',
                    aiLanguage: 'AI 输出语言',
                    aiLanguageHint: 'AI 总结、翻译、对话的语言。切换后已缓存的翻译不会更新，建议谨慎切换。',
                    updateKey: '更新'
                },
                setup: {
                    welcome: '欢迎使用 arXiv Pulse',
                    step: '步骤',
                    aiConfig: '配置 AI',
                    selectFields: '选择研究领域',
                    syncSettings: '同步设置',
                    startSync: '开始同步',
                    apiHint: '配置 AI 以启用智能总结和翻译功能',
                    fieldsHint: '选择您感兴趣的研究领域',
                    syncHint: '设置同步参数',
                    syncBtn: '开始同步',
                    yearsBack: '默认同步年份',
                    maxResultsPerField: '每领域最大论文数',
                    selectedFields: '已选择: {count} 个研究领域',
                    processing: '正在处理: {current} / {total} 个研究领域',
                    syncing: '正在同步...',
                    syncComplete: '同步完成'
                },
                basket: {
                    title: '暂存篮',
                    empty: '暂存篮是空的',
                    emptyHint: '点击论文卡片的"暂存"按钮添加论文',
                    export: '导出',
                    addToCollection: '论文集',
                    copyLinks: '复制链接',
                    clear: '清空',
                    added: '已添加到暂存篮',
                    alreadyInCart: '该论文已在暂存篮中',
                    removed: '已从暂存篮移除',
                    cleared: '暂存篮已清空'
                },
                chat: {
                    title: 'AI 助手',
                    newChat: '新建对话',
                    inputPlaceholder: '输入消息...',
                    send: '发送',
                    thinking: '思考中...',
                    history: '对话历史',
                    noSession: '暂无对话',
                    selectedPapers: '已选 {count} 篇论文:',
                    welcome: '你好！我是 AI 助手，可以帮你分析论文、回答问题。有什么可以帮你的吗？',
                    analyzePaper: '分析'
                },
                paper: {
                    aiSummary: 'AI 总结',
                    keyFindings: '关键发现',
                    keywords: '关键词',
                    abstract: '摘要',
                    chineseTranslation: '摘要翻译',
                    expandDetail: '展开',
                    collapse: '收起',
                    arxiv: 'arXiv',
                    pdf: 'PDF',
                    card: '卡片',
                    bookmark: '暂存',
                    bookmarked: '已暂存',
                    analyze: '分析',
                    addToCollection: '论文集',
                    removeFromCollection: '移除'
                },
                time: {
                    justNow: '刚刚',
                    minutesAgo: '分钟前',
                    hoursAgo: '小时前',
                    daysAgo: '天前',
                    yesterday: '昨天',
                    never: '从未'
                },
                status: {
                    running: '运行中',
                    completed: '已完成',
                    failed: '失败',
                    pending: '等待中'
                },
                fields: {
                    recommended: '推荐',
                    selectFields: '选择研究领域',
                    searchPlaceholder: '搜索领域...',
                    advancedMode: '高级模式',
                    advancedHint: '直接编辑 arXiv 查询语句，每行一条。支持 cat: 分类、ti: 标题、au: 作者等。例：cat:cond-mat.mtrl-sci OR ti:neural network',
                    advancedPlaceholder: 'cat:cond-mat.mtrl-sci\ncat:quant-ph\nti:machine learning AND cat:cs.LG\n...',
                    switchToCode: '切换到源码模式编辑',
                    switchToVisual: '切换到可视化选择',
                    codeMode: '源码',
                    visualMode: '可视化',
                    condensed_matter: { name: '凝聚态物理', desc: '超导、强关联电子、介观系统等' },
                    dft: { name: '密度泛函理论 (DFT)', desc: '第一性原理计算、材料设计' },
                    machine_learning: { name: '机器学习', desc: 'ML在物理和材料科学中的应用' },
                    force_fields: { name: '力场与分子动力学', desc: '力场开发、MD模拟' },
                    first_principles: { name: '第一性原理计算', desc: 'ab initio 方法' },
                    quantum_physics: { name: '量子物理', desc: '量子信息、量子计算' },
                    computational_physics: { name: '计算物理', desc: '数值计算方法' },
                    chemical_physics: { name: '化学物理', desc: '化学过程的物理基础' },
                    molecular_dynamics: { name: '分子动力学', desc: 'MD模拟技术' },
                    computational_materials: { name: '计算材料科学', desc: '材料计算与模拟' },
                    astro_physics: { name: '天体物理', desc: '天体物理学、宇宙学' },
                    high_energy_physics: { name: '高能物理', desc: '粒子物理理论与实验' },
                    nuclear_physics: { name: '核物理', desc: '核物理理论与实验' },
                    general_relativity: { name: '广义相对论', desc: '引力理论、宇宙学' },
                    mathematical_physics: { name: '数学物理', desc: '物理问题的数学方法' },
                    statistics: { name: '统计学', desc: '统计学理论与应用' },
                    quantitative_biology: { name: '定量生物学', desc: '生物信息学、系统生物学' },
                    artificial_intelligence: { name: '人工智能', desc: 'AI、神经网络' },
                    mathematics: { name: '数学', desc: '纯数学与应用数学' },
                    numerical_analysis: { name: '数值分析', desc: '数值计算方法与算法' },
                    optimization_control: { name: '优化与控制', desc: '数学优化、最优控制理论' },
                    statistics_math: { name: '统计学（数学）', desc: '数理统计理论' },
                    statistical_learning: { name: '统计学习', desc: '统计学习方法与应用' },
                    computer_vision: { name: '计算机视觉', desc: '图像处理、计算机视觉' },
                    natural_language: { name: '自然语言处理', desc: '计算语言学、NLP' },
                    computer_science_other: { name: '计算机科学（其他）', desc: '其他计算机科学领域' },
                    quantitative_finance: { name: '定量金融', desc: '金融数学、金融工程' },
                    electrical_engineering: { name: '电子工程', desc: '信号处理、控制系统' },
                    economics: { name: '经济学', desc: '经济学理论、计量经济学' },
                    physics_other: { name: '物理学（其他）', desc: '其他物理学领域' },
                    nonlinear_science: { name: '非线性科学', desc: '非线性动力学、复杂系统' },
                    quantum_chemistry: { name: '量子化学', desc: '量子化学方法与计算' }
                }
            },
            en: {
                nav: {
                    home: 'Home',
                    recent: 'Recent',
                    sync: 'Sync',
                    collections: 'Collections',
                    settings: 'Settings'
                },
                common: {
                    search: 'Search',
                    update: 'Update',
                    export: 'Export',
                    cancel: 'Cancel',
                    save: 'Save',
                    delete: 'Delete',
                    edit: 'Edit',
                    confirm: 'Confirm',
                    confirmDelete: 'Confirm Delete',
                    add: 'Add',
                    loading: 'Loading...',
                    noData: 'No data',
                    success: 'Success',
                    error: 'Error',
                    confirmDelete: 'Confirm Delete',
                    next: 'Next',
                    back: 'Back'
                },
                home: {
                    title: 'arXiv Pulse',
                    subtitle: 'Intelligent Academic Literature Tracking & Analysis System',
                    searchPlaceholder: 'Enter arXiv ID, keywords or natural language...',
                    searchBtn: 'Search',
                    hints: 'Supports arXiv ID or URL for exact search; Natural language search, e.g., "machine learning for materials design"',
                    recentPapers: 'Recent',
                    syncManage: 'Sync Management',
                    paperCollections: 'Collections',
                    totalPapers: 'papers',
                    totalCollections: 'collections',
                    summarizedPapers: 'summarized'
                },
                papers: {
                    recentPapers: 'Recent',
                    update: 'Update',
                    startSync: 'Start Sync',
                    never: 'Never',
                    noPapers: 'No papers yet',
                    noPapersHint: 'Click "Update" to fetch latest papers',
                    syncNow: 'Sync Now',
                    latestSync: 'Latest Sync',
                    daysAgo: 'days ago',
                    justNow: 'Just now',
                    timeRange: 'Time Range',
                    limit: 'Limit',
                    categoryFilter: 'Category Filter',
                    syncNewPapers: 'Sync New Papers',
                    yearsBack: 'Years Back'
                },
                sync: {
                    status: 'Sync Status',
                    lastSync: 'Last Sync',
                    researchFields: 'Research Fields',
                    totalPapers: 'Total Papers',
                    syncSettings: 'Sync Settings',
                    forceSync: 'Force Sync',
                    startSync: 'Start Sync',
                    yearsBack: 'Years Back',
                    yearDistribution: 'Year Distribution',
                    categoryDistribution: 'Top Categories',
                    noCache: 'No cache',
                    neverSynced: 'Never synced',
                    completed: 'Completed',
                    inProgress: 'In progress'
                },
                collections: {
                    title: 'Collections',
                    create: 'New Collection',
                    name: 'Name',
                    description: 'Description',
                    color: 'Color',
                    papers: 'papers',
                    noCollections: 'No collections yet',
                    noDescription: 'No description',
                    createHint: 'Create collections to organize your papers',
                    noPapersInCollection: 'This collection has no papers',
                    deleteConfirm: 'Are you sure you want to delete "{name}"? This cannot be undone.',
                    exportCollection: 'Export Collection',
                    addToCollection: 'Add to Collection',
                    addPapersTo: 'Add {count} paper(s) to collection',
                    alreadyIn: 'Already in',
                    selectPlaceholder: 'Select collection'
                },
                export: {
                    pdfDoc: 'PDF Document',
                    csvTable: 'CSV Spreadsheet'
                },
                settings: {
                    title: 'Settings',
                    uiLanguage: 'UI Language',
                    aiConfig: 'AI Settings',
                    apiBaseUrl: 'API Base URL',
                    apiKey: 'API Key',
                    modelName: 'Model Name',
                    testConnection: 'Test Connection',
                    researchFields: 'Research Fields',
                    fieldsHint: 'Unchecking fields with papers only stops syncing, papers are preserved',
                    syncSettings: 'Sync Settings',
                    yearsBack: 'Default Years Back',
                    arxivMaxResults: 'Global Max Papers',
                    maxResultsPerField: 'Max Papers Per Field',
                    recentPapersLimit: 'Recent Papers Limit',
                    aiLanguage: 'AI Output Language',
                    aiLanguageHint: 'Language for AI summaries, translations, and chat. Cached translations won\'t update after switching.',
                    updateKey: 'Update'
                },
                setup: {
                    welcome: 'Welcome to arXiv Pulse',
                    step: 'Step',
                    aiConfig: 'Configure AI',
                    selectFields: 'Select Research Fields',
                    syncSettings: 'Sync Settings',
                    startSync: 'Start Sync',
                    apiHint: 'Configure AI for intelligent summarization and translation',
                    fieldsHint: 'Select your research fields of interest',
                    syncHint: 'Set sync parameters',
                    syncBtn: 'Start Sync',
                    yearsBack: 'Default Years Back',
                    maxResultsPerField: 'Max Papers Per Field',
                    selectedFields: 'Selected: {count} research fields',
                    processing: 'Processing: {current} / {total} fields',
                    syncing: 'Syncing...',
                    syncComplete: 'Sync Complete'
                },
                basket: {
                    title: 'Basket',
                    empty: 'Basket is empty',
                    emptyHint: 'Click "Mark" on paper cards to add papers',
                    export: 'Export',
                    addToCollection: 'Collection',
                    copyLinks: 'Copy Links',
                    clear: 'Clear',
                    added: 'Added to basket',
                    alreadyInCart: 'Paper already in basket',
                    removed: 'Removed from basket',
                    cleared: 'Basket cleared'
                },
                chat: {
                    title: 'AI Assistant',
                    newChat: 'New Chat',
                    inputPlaceholder: 'Enter message...',
                    send: 'Send',
                    thinking: 'Thinking...',
                    history: 'Chat History',
                    noSession: 'No sessions yet',
                    selectedPapers: 'Selected {count} paper(s):',
                    welcome: 'Hello! I\'m an AI assistant that can help you analyze papers and answer questions. How can I help you?',
                    analyzePaper: 'Analyze'
                },
                paper: {
                    aiSummary: 'AI Summary',
                    keyFindings: 'Key Findings',
                    keywords: 'Keywords',
                    abstract: 'Abstract',
                    chineseTranslation: 'Translation',
                    expandDetail: 'Expand',
                    collapse: 'Collapse',
                    arxiv: 'arXiv',
                    pdf: 'PDF',
                    card: 'Card',
                    bookmark: 'Mark',
                    bookmarked: 'Marked',
                    analyze: 'Analyze',
                    addToCollection: 'Collection',
                    removeFromCollection: 'Remove'
                },
                time: {
                    justNow: 'Just now',
                    minutesAgo: 'minutes ago',
                    hoursAgo: 'hours ago',
                    daysAgo: 'days ago',
                    yesterday: 'Yesterday',
                    never: 'Never'
                },
                status: {
                    running: 'Running',
                    completed: 'Completed',
                    failed: 'Failed',
                    pending: 'Pending'
                },
                fields: {
                    recommended: 'Recommended',
                    selectFields: 'Select Research Fields',
                    searchPlaceholder: 'Search fields...',
                    advancedMode: 'Advanced Mode',
                    advancedHint: 'Edit arXiv queries directly, one per line. Supports cat: category, ti: title, au: author, etc. E.g.: cat:cond-mat.mtrl-sci OR ti:neural network',
                    advancedPlaceholder: 'cat:cond-mat.mtrl-sci\ncat:quant-ph\nti:machine learning AND cat:cs.LG\n...',
                    switchToCode: 'Switch to code editor',
                    switchToVisual: 'Switch to visual selector',
                    codeMode: 'Code',
                    visualMode: 'Visual',
                    condensed_matter: { name: 'Condensed Matter', desc: 'Superconductivity, strongly correlated electrons' },
                    dft: { name: 'DFT', desc: 'First-principles calculations, materials design' },
                    machine_learning: { name: 'Machine Learning', desc: 'ML in physics and materials science' },
                    force_fields: { name: 'Force Fields & MD', desc: 'Force field development, MD simulations' },
                    first_principles: { name: 'First-Principles', desc: 'Ab initio methods' },
                    quantum_physics: { name: 'Quantum Physics', desc: 'Quantum information, quantum computing' },
                    computational_physics: { name: 'Computational Physics', desc: 'Numerical methods' },
                    chemical_physics: { name: 'Chemical Physics', desc: 'Physical basis of chemical processes' },
                    molecular_dynamics: { name: 'Molecular Dynamics', desc: 'MD simulation techniques' },
                    computational_materials: { name: 'Computational Materials', desc: 'Materials computation and simulation' },
                    astro_physics: { name: 'Astrophysics', desc: 'Astrophysics, cosmology' },
                    high_energy_physics: { name: 'High Energy Physics', desc: 'Particle physics theory and experiments' },
                    nuclear_physics: { name: 'Nuclear Physics', desc: 'Nuclear physics theory and experiments' },
                    general_relativity: { name: 'General Relativity', desc: 'Gravity theory, cosmology' },
                    mathematical_physics: { name: 'Mathematical Physics', desc: 'Mathematical methods for physics' },
                    statistics: { name: 'Statistics', desc: 'Statistical theory and applications' },
                    quantitative_biology: { name: 'Quantitative Biology', desc: 'Bioinformatics, systems biology' },
                    artificial_intelligence: { name: 'Artificial Intelligence', desc: 'AI, neural networks' },
                    mathematics: { name: 'Mathematics', desc: 'Pure and applied mathematics' },
                    numerical_analysis: { name: 'Numerical Analysis', desc: 'Numerical methods and algorithms' },
                    optimization_control: { name: 'Optimization & Control', desc: 'Mathematical optimization, optimal control' },
                    statistics_math: { name: 'Statistics (Math)', desc: 'Mathematical statistics theory' },
                    statistical_learning: { name: 'Statistical Learning', desc: 'Statistical learning methods' },
                    computer_vision: { name: 'Computer Vision', desc: 'Image processing, computer vision' },
                    natural_language: { name: 'Natural Language', desc: 'Computational linguistics, NLP' },
                    computer_science_other: { name: 'Computer Science (Other)', desc: 'Other computer science fields' },
                    quantitative_finance: { name: 'Quantitative Finance', desc: 'Financial mathematics, financial engineering' },
                    electrical_engineering: { name: 'Electrical Engineering', desc: 'Signal processing, control systems' },
                    economics: { name: 'Economics', desc: 'Economic theory, econometrics' },
                    physics_other: { name: 'Physics (Other)', desc: 'Other physics fields' },
                    nonlinear_science: { name: 'Nonlinear Science', desc: 'Nonlinear dynamics, complex systems' },
                    quantum_chemistry: { name: 'Quantum Chemistry', desc: 'Quantum chemistry methods' }
                }
            }
        };

        const currentLang = ref('zh');
        function t(key, params = {}) {
            const keys = key.split('.');
            let value = i18n[currentLang.value];
            for (const k of keys) {
                if (value && typeof value === 'object') {
                    value = value[k];
                } else {
                    return key;
                }
            }
            if (typeof value !== 'string') return key;
            return value.replace(/\{(\w+)\}/g, (_, k) => params[k] ?? `{${k}}`);
        }
        function setLanguage(lang) {
            currentLang.value = lang;
        }
        function getFieldTranslation(fieldKey, type) {
            if (currentLang.value === 'zh') return null;
            const fieldTrans = i18n[currentLang.value]?.fields?.[fieldKey];
            if (!fieldTrans) return null;
            return type === 'name' ? fieldTrans.name : fieldTrans.desc;
        }
        window.t = t;
        window.setLanguage = setLanguage;

        const arxivCategories = ref({});
        const allCategories = ref({});
        const defaultFields = ['cond-mat.mtrl-sci', 'quant-ph', 'cs.LG'];

        const app = createApp({
            setup() {
                const showSetup = ref(false);
                const setupStep = ref(1);
                const initializing = ref(false);
                const testingAI = ref(false);
                const initLogs = ref([]);
                const initProgress = ref(0);
                const initCurrentQuery = ref(0);
                const initTotalQueries = ref(0);
                const initComplete = ref(false);
                
                const waitingMessages = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return isZh ? [
                        '正在从 arXiv 获取论文...',
                        '首次同步可能需要几分钟...',
                        '正在处理论文数据...',
                        'arXiv 服务器响应中...',
                        '马上就好了...',
                        '正在建立索引...'
                    ] : [
                        'Fetching papers from arXiv...',
                        'First sync may take a few minutes...',
                        'Processing paper data...',
                        'arXiv server responding...',
                        'Almost done...',
                        'Building index...'
                    ];
                });
                const waitingMessage = ref('');
                let waitingTimer = null;
                
                const setupConfig = ref({
                    ai_api_key: '',
                    ai_model: 'DeepSeek-V3.2',
                    ai_base_url: 'https://llmapi.paratera.com',
                    translate_language: 'zh',
                    selected_fields: [...defaultFields],
                    search_queries: [],
                    years_back: 5,
                    arxiv_max_results_per_field: 10000
                });

                const showSettings = ref(false);
                const savingSettings = ref(false);
                const settingsConfig = ref({
                    ai_api_key: '',
                    ai_model: 'DeepSeek-V3.2',
                    ai_base_url: 'https://llmapi.paratera.com',
                    selected_fields: [],
                    search_queries: [],
                    years_back: 5,
                    arxiv_max_results: 100000,
                    arxiv_max_results_per_field: 10000,
                    recent_papers_limit: 64,
                    ui_language: 'zh',
                    translate_language: 'zh'
                });

                // Field Selector
                const showFieldSelector = ref(false);
                const fieldSelectorSource = ref('settings');
                const tempSelectedFields = ref([]);
                const fieldSearchQuery = ref('');
                const fieldSelectorExpanded = ref({});
                const recentCategories = ref([]);
                const fieldAdvancedMode = ref(false);
                const advancedQueriesText = ref('');

                const currentPage = ref('home');
                const stats = ref(null);
                const fieldStats = ref([]);
                const expandedGroups = ref({});
                const recentPapers = ref([]);
                const loadingRecent = ref(false);
                const updatingRecent = ref(false);
                const recentLogs = ref([]);
                const recentDays = ref('7');
                const recentNeedSync = ref(true);

                const homeQuery = ref('');
                const homeSearching = ref(false);
                const homeLogs = ref([]);
                const homeResults = ref([]);
                const homeSelectedIds = ref([]);

                const paperCart = ref([]);
                const showCart = ref(false);
                const cartExportLoading = ref(false);
                const cartPosition = ref({ x: window.innerWidth - 420, y: 100 });
                const cartPanelRef = ref(null);

                const chatExpanded = ref(false);
                const chatSessions = ref([]);
                const currentChatSession = ref(null);
                const chatMessages = ref([]);
                const chatInput = ref('');
                const selectedChatPapers = ref([]);
                const chatTyping = ref(false);
                const chatProgress = ref(null);
                const showChatSidebar = ref(false);
                const chatUnreadCount = ref(0);
                const chatMessagesContainer = ref(null);
                const userScrolledUp = ref(false);
                const chatPosition = ref({ x: window.innerWidth - 500, y: 80 });
                const chatPanelRef = ref(null);

                // Drag functionality
                let isDragging = false;
                let dragTarget = null;
                let dragOffset = { x: 0, y: 0 };

                function startDragCart(e) {
                    if (e.target.closest('.collapse-btn') || e.target.closest('.el-button')) return;
                    isDragging = true;
                    dragTarget = 'cart';
                    dragOffset = { x: e.clientX - cartPosition.value.x, y: e.clientY - cartPosition.value.y };
                    document.addEventListener('mousemove', onDrag);
                    document.addEventListener('mouseup', stopDrag);
                }

                function startDragChat(e) {
                    if (e.target.closest('.collapse-btn') || e.target.closest('.el-button')) return;
                    isDragging = true;
                    dragTarget = 'chat';
                    dragOffset = { x: e.clientX - chatPosition.value.x, y: e.clientY - chatPosition.value.y };
                    document.addEventListener('mousemove', onDrag);
                    document.addEventListener('mouseup', stopDrag);
                }

                function onDrag(e) {
                    if (!isDragging) return;
                    if (dragTarget === 'cart') {
                        cartPosition.value = { 
                            x: Math.max(0, Math.min(window.innerWidth - 400, e.clientX - dragOffset.x)),
                            y: Math.max(0, Math.min(window.innerHeight - 200, e.clientY - dragOffset.y))
                        };
                    } else if (dragTarget === 'chat') {
                        chatPosition.value = { 
                            x: Math.max(0, Math.min(window.innerWidth - 480, e.clientX - dragOffset.x)),
                            y: Math.max(0, Math.min(window.innerHeight - 200, e.clientY - dragOffset.y))
                        };
                    }
                }

                function stopDrag() {
                    isDragging = false;
                    dragTarget = null;
                    document.removeEventListener('mousemove', onDrag);
                    document.removeEventListener('mouseup', stopDrag);
                }

                const searchQuery = ref('');
                const searchDays = ref('');
                const searching = ref(false);
                const searchResults = ref([]);
                const searchLogs = ref([]);

                const recentSelectedIds = ref([]);
                const recentSelectAll = ref(false);
                const searchSelectedIds = ref([]);
                const searchSelectAll = ref(false);

                const syncStatus = ref(null);
                const syncing = ref(false);
                const syncLogs = ref([]);
                const syncYearsBack = ref('5');
                const syncForce = ref(false);

                const collections = ref([]);
                const showCreateCollection = ref(false);
                const showAddToCollection = ref(false);
                const showDeleteConfirm = ref(false);
                const newCollection = ref({ name: '', description: '', color: '#1e3a5f' });
                const editingCollection = ref(null);
                const deletingCollection = ref(null);
                const savingCollection = ref(false);
                const deletingCollectionInProgress = ref(false);
                const selectedCollectionId = ref(null);
                const selectedPaper = ref(null);
                const addingToCollection = ref(false);
                const viewingCollection = ref(null);
                const collectionPapers = ref([]);
                const loadingCollectionPapers = ref(false);

                let yearChart = null;
                let categoryChart = null;

                const daysOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: '1', label: isZh ? '1 天' : '1 day' },
                        { value: '3', label: isZh ? '3 天' : '3 days' },
                        { value: '7', label: isZh ? '7 天' : '7 days' },
                        { value: '14', label: isZh ? '14 天' : '14 days' },
                        { value: '30', label: isZh ? '30 天' : '30 days' }
                    ];
                });

                const limitOptions = [
                    { value: '20', label: '20' },
                    { value: '50', label: '50' },
                    { value: '64', label: '64' },
                    { value: '100', label: '100' },
                    { value: '200', label: '200' }
                ];

                const syncYearOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: '1', label: isZh ? '1 年' : '1 year' },
                        { value: '2', label: isZh ? '2 年' : '2 years' },
                        { value: '3', label: isZh ? '3 年' : '3 years' },
                        { value: '5', label: isZh ? '5 年' : '5 years' },
                        { value: '10', label: isZh ? '10 年' : '10 years' }
                    ];
                });

                const initYearOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: 1, label: isZh ? '1 年' : '1 year' },
                        { value: 2, label: isZh ? '2 年' : '2 years' },
                        { value: 3, label: isZh ? '3 年' : '3 years' },
                        { value: 5, label: isZh ? '5 年（推荐）' : '5 years (Recommended)' },
                        { value: 10, label: isZh ? '10 年' : '10 years' }
                    ];
                });

                const syncYearsBackOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: '1', label: isZh ? '1 年' : '1 year' },
                        { value: '2', label: isZh ? '2 年' : '2 years' },
                        { value: '5', label: isZh ? '5 年' : '5 years' },
                        { value: '10', label: isZh ? '10 年' : '10 years' },
                        { value: '20', label: isZh ? '20 年' : '20 years' }
                    ];
                });

                const searchDaysOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: '', label: isZh ? '不限' : 'Any' },
                        { value: '30', label: isZh ? '最近 30 天' : 'Last 30 days' },
                        { value: '90', label: isZh ? '最近 90 天' : 'Last 90 days' },
                        { value: '180', label: isZh ? '最近 180 天' : 'Last 180 days' },
                        { value: '365', label: isZh ? '最近 1 年' : 'Last 1 year' }
                    ];
                });

                const aiLanguageOptions = [
                    { value: 'zh', label: '中文' },
                    { value: 'en', label: 'English' },
                    { value: 'ja', label: '日本語' },
                    { value: 'ko', label: '한국어' },
                    { value: 'fr', label: 'Français' },
                    { value: 'de', label: 'Deutsch' },
                    { value: 'es', label: 'Español' }
                ];

                const categoryOptions = computed(() => {
                    return fieldStats.value
                        .filter(f => f.paper_count > 0)
                        .map(f => ({ value: f.key, label: f.name }));
                });

                const recentCacheStatus = computed(() => {
                    const info = recentPapers.value._cacheInfo;
                    if (!info) return '无缓存';
                    if (info.cached && info.updated_at) {
                        const date = new Date(info.updated_at);
                        return `缓存于 ${date.toLocaleString('zh-CN')}`;
                    }
                    return t('sync.noCache');
                });

                const syncStatusText = computed(() => {
                    if (!syncStatus.value?.last_sync) return t('sync.neverSynced');
                    return syncStatus.value.last_sync.status === 'completed' ? t('sync.completed') : t('sync.inProgress');
                });

                const syncStatusClass = computed(() => {
                    if (!syncStatus.value?.last_sync) return '';
                    return syncStatus.value.last_sync.status === 'completed' ? 'success' : 'warning';
                });

                const syncTimeClass = computed(() => {
                    if (!syncStatus.value?.last_sync?.time) return '';
                    const hours = (Date.now() - new Date(syncStatus.value.last_sync.time).getTime()) / 3600000;
                    if (hours < 24) return 'success';
                    if (hours < 72) return 'warning';
                    return '';
                });

                const formatSyncTime = computed(() => {
                    if (!syncStatus.value?.last_sync?.time) return '-';
                    const date = new Date(syncStatus.value.last_sync.time);
                    return date.toLocaleDateString('zh-CN');
                });

                async function checkInitStatus() {
                    try {
                        const res = await fetch(`${API_BASE}/config/status`);
                        const data = await res.json();
                        showSetup.value = !data.is_initialized;
                        await fetchCategories();
                    } catch (e) {
                        console.error('Failed to check init status:', e);
                    }
                }

                async function fetchCategories() {
                    try {
                        const res = await fetch(`${API_BASE}/config/categories`);
                        const data = await res.json();
                        arxivCategories.value = data.categories || {};
                        allCategories.value = data.all_categories || {};
                        
                        const defaultExpanded = ['physics', 'cond-mat', 'cs'];
                        defaultExpanded.forEach(key => {
                            expandedGroups.value[key] = true;
                        });
                    } catch (e) {
                        console.error('Failed to fetch categories:', e);
                    }
                }

                async function testSetupAI() {
                    testingAI.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/config/test-ai`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(setupConfig.value)
                        });
                        const data = await res.json();
                        if (res.ok) {
                            ElementPlus.ElMessage.success(data.message || '连接成功');
                        } else {
                            ElementPlus.ElMessage.error(data.detail || '连接失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('连接失败');
                    } finally {
                        testingAI.value = false;
                    }
                }

                function toggleCategoryGroup(key) {
                    expandedGroups.value[key] = !expandedGroups.value[key];
                }

                function toggleSetupField(key) {
                    const idx = setupConfig.value.selected_fields.indexOf(key);
                    if (idx >= 0) {
                        setupConfig.value.selected_fields.splice(idx, 1);
                    } else {
                        setupConfig.value.selected_fields.push(key);
                    }
                }

                async function startInitialSync() {
                    setupStep.value = 4;
                    initializing.value = true;
                    initLogs.value = [];
                    initProgress.value = 0;
                    initCurrentQuery.value = 0;
                    initTotalQueries.value = 0;
                    initComplete.value = false;

                    let msgIndex = 0;
                    waitingMessage.value = waitingMessages.value[0];
                    waitingTimer = setInterval(() => {
                        msgIndex = (msgIndex + 1) % waitingMessages.value.length;
                        waitingMessage.value = waitingMessages.value[msgIndex];
                    }, 4000);

                    try {
                        await fetch(`${API_BASE}/config/init`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(setupConfig.value)
                        });

                        const response = await fetch(`${API_BASE}/config/init/sync`, { method: 'POST' });
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'total') {
                                            initTotalQueries.value = data.total;
                                        } else if (data.type === 'progress') {
                                            initCurrentQuery.value = data.current;
                                            initTotalQueries.value = data.total;
                                            initProgress.value = Math.round((data.current / data.total) * 100);
                                        } else if (data.type === 'done') {
                                            if (waitingTimer) clearInterval(waitingTimer);
                                            initProgress.value = 100;
                                            initComplete.value = true;
                                            setTimeout(() => {
                                                showSetup.value = false;
                                                fetchStats();
                                                fetchFieldStats();
                                                fetchRecentCache();
                                            }, 2000);
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        initLogs.value.push({ type: 'error', message: `初始化失败: ${e.message}` });
                    } finally {
                        initializing.value = false;
                        if (waitingTimer) clearInterval(waitingTimer);
                    }
                }

                async function fetchConfig() {
                    try {
                        const res = await fetch(`${API_BASE}/config`);
                        const data = await res.json();
                        settingsConfig.value = {
                            ai_api_key: data.ai_api_key || '',
                            ai_model: data.ai_model || 'DeepSeek-V3.2',
                            ai_base_url: data.ai_base_url || 'https://llmapi.paratera.com',
                            selected_fields: data.selected_fields || [],
                            search_queries: data.search_queries || [],
                            years_back: data.years_back || 5,
                            arxiv_max_results: data.arxiv_max_results || 100000,
                            arxiv_max_results_per_field: data.arxiv_max_results_per_field || 10000,
                            recent_papers_limit: data.recent_papers_limit || 64,
                            ui_language: data.ui_language || 'zh',
                            translate_language: data.translate_language || 'zh'
                        };
                        setLanguage(settingsConfig.value.ui_language || 'zh');
                        nextTick(() => { settingsInitialized = true; });
                    } catch (e) {
                        console.error('Failed to fetch config:', e);
                    }
                }

                async function saveApiKey() {
                    savingSettings.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/config`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ai_api_key: settingsConfig.value.ai_api_key })
                        });
                        if (res.ok) {
                            ElementPlus.ElMessage.success(currentLang.value === 'zh' ? 'API Key 已更新' : 'API Key updated');
                        } else {
                            ElementPlus.ElMessage.error(currentLang.value === 'zh' ? '更新失败' : 'Update failed');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error(currentLang.value === 'zh' ? '更新失败' : 'Update failed');
                    } finally {
                        savingSettings.value = false;
                    }
                }

                async function testAIConnection() {
                    testingAI.value = true;
                    try {
                        const payload = {
                            ai_base_url: settingsConfig.value.ai_base_url,
                            ai_model: settingsConfig.value.ai_model
                        };
                        // Only send API key if it's not masked
                        if (settingsConfig.value.ai_api_key && settingsConfig.value.ai_api_key !== '***') {
                            payload.ai_api_key = settingsConfig.value.ai_api_key;
                        }
                        
                        const res = await fetch(`${API_BASE}/config/test-ai`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (res.ok) {
                            ElementPlus.ElMessage.success(data.message || '连接成功');
                        } else {
                            ElementPlus.ElMessage.error(data.detail || '连接失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('连接失败');
                    } finally {
                        testingAI.value = false;
                    }
                }

                function toggleSettingsField(key) {
                    if (!settingsConfig.value.selected_fields) {
                        settingsConfig.value.selected_fields = [];
                    }
                    const idx = settingsConfig.value.selected_fields.indexOf(key);
                    if (idx >= 0) {
                        settingsConfig.value.selected_fields.splice(idx, 1);
                    } else {
                        settingsConfig.value.selected_fields.push(key);
                    }
                }

                function openFieldSelector(source) {
                    console.log('openFieldSelector called with source:', source);
                    fieldSelectorSource.value = source;
                    fieldAdvancedMode.value = false;
                    syncingFromCode = true; // 防止 watch 触发
                    
                    if (source === 'settings') {
                        tempSelectedFields.value = [...(settingsConfig.value.selected_fields || [])];
                        if (settingsConfig.value.search_queries?.length > 0) {
                            advancedQueriesText.value = settingsConfig.value.search_queries.join('\n');
                        } else {
                            advancedQueriesText.value = tempSelectedFields.value.map(f => `cat:${f}`).join('\n');
                        }
                    } else if (source === 'init') {
                        tempSelectedFields.value = [...(setupConfig.value.selected_fields || [])];
                        if (setupConfig.value.search_queries?.length > 0) {
                            advancedQueriesText.value = setupConfig.value.search_queries.join('\n');
                        } else {
                            advancedQueriesText.value = tempSelectedFields.value.map(f => `cat:${f}`).join('\n');
                        }
                    } else if (source === 'recent') {
                        tempSelectedFields.value = [...recentCategories.value];
                        advancedQueriesText.value = '';
                    }
                    
                    fieldSearchQuery.value = '';
                    nextTick(() => { syncingFromCode = false; });
                    
                    const recommendedGroups = ['physics', 'cond-mat', 'cs', 'quant-ph'];
                    fieldSelectorExpanded.value = {};
                    recommendedGroups.forEach(key => {
                        fieldSelectorExpanded.value[key] = true;
                    });
                    
                    showFieldSelector.value = true;
                    console.log('showFieldSelector set to true');
                }

                function toggleFieldSelectorGroup(key) {
                    fieldSelectorExpanded.value[key] = !fieldSelectorExpanded.value[key];
                }

                function toggleTempField(fieldId) {
                    const idx = tempSelectedFields.value.indexOf(fieldId);
                    if (idx >= 0) {
                        tempSelectedFields.value.splice(idx, 1);
                    } else {
                        tempSelectedFields.value.push(fieldId);
                    }
                    // 同步更新源码
                    syncFieldsToCode();
                }

                function removeFromTempSelection(fieldId) {
                    const idx = tempSelectedFields.value.indexOf(fieldId);
                    if (idx >= 0) {
                        tempSelectedFields.value.splice(idx, 1);
                    }
                    syncFieldsToCode();
                }

                function clearTempSelection() {
                    tempSelectedFields.value = [];
                    advancedQueriesText.value = '';
                }

                let syncingFromCode = false;

                const advancedQueriesLines = computed(() => {
                    return advancedQueriesText.value
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                });

                function syncFieldsToCode() {
                    const queries = tempSelectedFields.value.map(f => `cat:${f}`);
                    advancedQueriesText.value = queries.join('\n');
                }

                function parseCodeToFields() {
                    const lines = advancedQueriesLines.value;
                    const standardFields = [];
                    const customQueries = [];
                    
                    for (const line of lines) {
                        const catMatch = line.match(/^cat:(.+)$/);
                        if (catMatch) {
                            const fieldId = catMatch[1].trim();
                            if (allCategories.value[fieldId]) {
                                standardFields.push(fieldId);
                            } else {
                                customQueries.push(line);
                            }
                        } else {
                            customQueries.push(line);
                        }
                    }
                    
                    return { standardFields, customQueries };
                }

                const parsedCodeResult = computed(() => {
                    if (!fieldAdvancedMode.value) return { standardFields: [], customQueries: [] };
                    return parseCodeToFields();
                });

                // 源码变化时同步 fields（仅在源码模式）
                watch(advancedQueriesText, () => {
                    if (fieldAdvancedMode.value && !syncingFromCode) {
                        syncingFromCode = true;
                        const { standardFields } = parseCodeToFields();
                        tempSelectedFields.value = standardFields;
                        nextTick(() => { syncingFromCode = false; });
                    }
                });

                // fields 变化时同步源码（仅在可视化模式）
                watch(tempSelectedFields, () => {
                    if (!fieldAdvancedMode.value && !syncingFromCode) {
                        syncingFromCode = true;
                        syncFieldsToCode();
                        nextTick(() => { syncingFromCode = false; });
                    }
                }, { deep: true });

                function confirmFieldSelection() {
                    const { standardFields, customQueries } = parseCodeToFields();
                    
                    if (fieldSelectorSource.value === 'settings') {
                        // 合并标准分类和自定义查询
                        settingsConfig.value.selected_fields = [...tempSelectedFields.value];
                        settingsConfig.value.search_queries = [...advancedQueriesLines.value];
                    } else if (fieldSelectorSource.value === 'init') {
                        setupConfig.value.selected_fields = [...tempSelectedFields.value];
                        setupConfig.value.search_queries = [...advancedQueriesLines.value];
                    } else if (fieldSelectorSource.value === 'recent') {
                        recentCategories.value = [...tempSelectedFields.value];
                    }
                    showFieldSelector.value = false;
                }

                const filteredCategories = computed(() => {
                    if (!fieldSearchQuery.value) return arxivCategories.value;
                    const query = fieldSearchQuery.value.toLowerCase();
                    const result = {};
                    for (const [groupKey, group] of Object.entries(arxivCategories.value)) {
                        const filteredGroup = { ...group, children: {} };
                        let hasMatch = false;
                        if (group.name?.toLowerCase().includes(query) || group.name_en?.toLowerCase().includes(query)) {
                            hasMatch = true;
                        }
                        if (group.children) {
                            for (const [catKey, cat] of Object.entries(group.children)) {
                                let catMatch = false;
                                if (cat.name?.toLowerCase().includes(query) || cat.name_en?.toLowerCase().includes(query) || cat.id?.toLowerCase().includes(query)) {
                                    catMatch = true;
                                }
                                if (cat.children) {
                                    const filteredChildren = {};
                                    for (const [subcatKey, subcat] of Object.entries(cat.children)) {
                                        if (subcat.name?.toLowerCase().includes(query) || subcat.name_en?.toLowerCase().includes(query) || subcat.id?.toLowerCase().includes(query)) {
                                            filteredChildren[subcatKey] = subcat;
                                            catMatch = true;
                                        }
                                    }
                                    if (catMatch) {
                                        filteredGroup.children[catKey] = { ...cat, children: filteredChildren };
                                        hasMatch = true;
                                    }
                                } else if (catMatch) {
                                    filteredGroup.children[catKey] = cat;
                                    hasMatch = true;
                                }
                            }
                        }
                        if (hasMatch) {
                            result[groupKey] = filteredGroup;
                            fieldSelectorExpanded.value[groupKey] = true;
                        }
                    }
                    return result;
                });

                let saveTimeout = null;
                async function saveSettings() {
                    savingSettings.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/config`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(settingsConfig.value)
                        });
                        if (res.ok) {
                            ElementPlus.ElMessage.success(currentLang.value === 'zh' ? '设置已保存' : 'Settings saved');
                            if (settingsConfig.value.ui_language) {
                                setLanguage(settingsConfig.value.ui_language);
                            }
                            fetchFieldStats();
                        } else {
                            ElementPlus.ElMessage.error(currentLang.value === 'zh' ? '保存失败' : 'Save failed');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error(currentLang.value === 'zh' ? '保存失败' : 'Save failed');
                    } finally {
                        savingSettings.value = false;
                    }
                }

                function debouncedSave() {
                    if (saveTimeout) clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => saveSettings(), 500);
                }

                let settingsInitialized = false;
                watch(settingsConfig, (newVal, oldVal) => {
                    if (!settingsInitialized) return;
                    const keysToWatch = ['ai_base_url', 'ai_model', 'translate_language', 'years_back', 'arxiv_max_results', 'arxiv_max_results_per_field', 'recent_papers_limit', 'selected_fields', 'search_queries', 'ui_language'];
                    for (const key of keysToWatch) {
                        if (JSON.stringify(newVal[key]) !== JSON.stringify(oldVal?.[key])) {
                            debouncedSave();
                            break;
                        }
                    }
                }, { deep: true });

                function onLanguageChange(lang) {
                    setLanguage(lang);
                    if (settingsConfig.value) {
                        settingsConfig.value.ui_language = lang;
                    }
                }

                async function toggleLanguage() {
                    const newLang = currentLang.value === 'zh' ? 'en' : 'zh';
                    setLanguage(newLang);
                    if (settingsConfig.value) {
                        settingsConfig.value.ui_language = newLang;
                        try {
                            await fetch(`${API_BASE}/config`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(settingsConfig.value)
                            });
                        } catch (e) {
                            console.error('Failed to save language setting:', e);
                        }
                    }
                }

                async function fetchStats() {
                    try {
                        const res = await fetch(`${API_BASE}/stats`);
                        stats.value = await res.json();
                        await nextTick();
                        if (!yearChart) initCharts();
                        if (stats.value) {
                            renderYearChart(stats.value.years);
                            renderCategoryChart(stats.value.categories?.top);
                        }
                    } catch (e) {
                        console.error('Failed to fetch stats:', e);
                    }
                }

                async function fetchFieldStats() {
                    try {
                        const res = await fetch(`${API_BASE}/stats/fields`);
                        const data = await res.json();
                        fieldStats.value = data.fields || [];
                    } catch (e) {
                        console.error('Failed to fetch field stats:', e);
                    }
                }

                async function fetchRecentCache() {
                    loadingRecent.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/papers/recent/cache`);
                        const data = await res.json();
                        recentPapers.value = data.papers || [];
                        recentPapers.value._cacheInfo = {
                            cached: data.cached,
                            updated_at: data.updated_at,
                            days_back: data.days_back
                        };
                    } catch (e) {
                        console.error('Failed to fetch recent cache:', e);
                    } finally {
                        loadingRecent.value = false;
                    }
                }

                async function updateRecentPapers() {
                    updatingRecent.value = true;
                    recentLogs.value = [];
                    recentPapers.value = [];
                    try {
                        const params = new URLSearchParams({
                            days: recentDays.value,
                            need_sync: recentNeedSync.value
                        });
                        if (recentCategories.value.length > 0) {
                            params.append('categories', recentCategories.value.join(','));
                        }

                        const response = await fetch(`${API_BASE}/papers/recent/update?${params}`, { method: 'POST' });
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            recentLogs.value.push(data.message);
                                        } else if (data.type === 'result') {
                                            recentPapers.value.push(data.paper);
                                        } else if (data.type === 'done') {
                                            recentLogs.value.push(`更新完成，共 ${data.total} 篇论文`);
                                            recentPapers.value._cacheInfo = { cached: true, updated_at: new Date().toISOString() };
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Failed to update recent papers:', e);
                    } finally {
                        updatingRecent.value = false;
                    }
                }

                async function startSearch() {
                    if (!searchQuery.value.trim()) {
                        ElementPlus.ElMessage.warning('请输入搜索关键词');
                        return;
                    }
                    searching.value = true;
                    searchResults.value = [];
                    searchLogs.value = [];

                    try {
                        const params = new URLSearchParams({ q: searchQuery.value });
                        if (searchDays.value) params.append('days', searchDays.value);

                        const response = await fetch(`${API_BASE}/papers/search/stream?${params}`);
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            searchLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'result') {
                                            searchResults.value.push(data.paper);
                                        } else if (data.type === 'done') {
                                            searchLogs.value.push({ type: 'success', message: `搜索完成，共 ${data.total} 篇论文` });
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Search failed:', e);
                    } finally {
                        searching.value = false;
                    }
                }

                async function fetchCollections() {
                    try {
                        const res = await fetch(`${API_BASE}/collections`);
                        collections.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch collections:', e);
                    }
                }

                async function fetchSyncStatus() {
                    try {
                        const res = await fetch(`${API_BASE}/tasks/status`);
                        syncStatus.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch sync status:', e);
                    }
                }

                async function startSync() {
                    syncing.value = true;
                    syncLogs.value = [];
                    try {
                        const params = new URLSearchParams({
                            years_back: syncYearsBack.value,
                            force: syncForce.value
                        });

                        const response = await fetch(`${API_BASE}/tasks/sync?${params}`, { method: 'POST' });
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            syncLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'done') {
                                            syncLogs.value.push({ type: 'success', message: '同步完成' });
                                            fetchStats();
                                            fetchRecentCache();
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Sync failed:', e);
                    } finally {
                        syncing.value = false;
                    }
                }

                async function saveCollection() {
                    if (!newCollection.value.name.trim()) {
                        ElementPlus.ElMessage.warning('请输入论文集名称');
                        return;
                    }
                    savingCollection.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/collections`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newCollection.value)
                        });
                        if (res.ok) {
                            ElementPlus.ElMessage.success('创建成功');
                            showCreateCollection.value = false;
                            newCollection.value = { name: '', description: '', color: '#1e3a5f' };
                            fetchCollections();
                        } else {
                            ElementPlus.ElMessage.error('创建失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('创建失败');
                    } finally {
                        savingCollection.value = false;
                    }
                }

                function cancelCollectionDialog() {
                    showCreateCollection.value = false;
                    editingCollection.value = null;
                }

                function openEditCollection(collection) {
                    editingCollection.value = { ...collection };
                }

                function confirmDeleteCollection(collection) {
                    deletingCollection.value = collection;
                    showDeleteConfirm.value = true;
                }

                async function deleteCollection() {
                    deletingCollectionInProgress.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/collections/${deletingCollection.value.id}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            ElementPlus.ElMessage.success('删除成功');
                            showDeleteConfirm.value = false;
                            fetchCollections();
                        } else {
                            ElementPlus.ElMessage.error('删除失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('删除失败');
                    } finally {
                        deletingCollectionInProgress.value = false;
                    }
                }

                async function openCollectionDetail(collection) {
                    viewingCollection.value = collection;
                    loadingCollectionPapers.value = true;
                    try {
                        const res = await fetch(`${API_BASE}/collections/${collection.id}/papers`);
                        collectionPapers.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch collection papers:', e);
                    } finally {
                        loadingCollectionPapers.value = false;
                    }
                }

                async function removePaperFromCollection(paperId) {
                    try {
                        const res = await fetch(
                            `${API_BASE}/collections/${viewingCollection.value.id}/papers/${paperId}`,
                            { method: 'DELETE' }
                        );
                        if (res.ok) {
                            ElementPlus.ElMessage.success('已移除');
                            openCollectionDetail(viewingCollection.value);
                            fetchCollections();
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('移除失败');
                    }
                }

                function addToCollection(paper) {
                    selectedPaper.value = paper;
                    selectedCollectionId.value = null;
                    showAddToCollection.value = true;
                }

                async function confirmAddToCollection() {
                    if (!selectedCollectionId.value) {
                        ElementPlus.ElMessage.warning('请选择论文集');
                        return;
                    }
                    addingToCollection.value = true;
                    try {
                        const papersToAdd = paperCart.value.length > 0 ? paperCart.value : (selectedPaper.value ? [selectedPaper.value] : []);
                        if (papersToAdd.length === 0) {
                            ElementPlus.ElMessage.warning('没有选中的论文');
                            return;
                        }
                        
                        let successCount = 0;
                        for (const paper of papersToAdd) {
                            const res = await fetch(`${API_BASE}/collections/${selectedCollectionId.value}/papers`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ paper_id: paper.id })
                            });
                            if (res.ok) successCount++;
                        }
                        
                        if (successCount > 0) {
                            ElementPlus.ElMessage.success(`成功添加 ${successCount} 篇论文`);
                            showAddToCollection.value = false;
                            fetchCollections();
                            if (paperCart.value.length > 0) {
                                paperCart.value = [];
                            }
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('添加失败');
                    } finally {
                        addingToCollection.value = false;
                    }
                }

                function toggleRecentSelect(paperId) {
                    const idx = recentSelectedIds.value.indexOf(paperId);
                    if (idx >= 0) {
                        recentSelectedIds.value.splice(idx, 1);
                    } else {
                        recentSelectedIds.value.push(paperId);
                    }
                    recentSelectAll.value = recentSelectedIds.value.length === recentPapers.value.length;
                }

                function toggleRecentSelectAll(val) {
                    if (val) {
                        recentSelectedIds.value = recentPapers.value.map(p => p.id);
                    } else {
                        recentSelectedIds.value = [];
                    }
                }

                function toggleSearchSelect(paperId) {
                    const idx = searchSelectedIds.value.indexOf(paperId);
                    if (idx >= 0) {
                        searchSelectedIds.value.splice(idx, 1);
                    } else {
                        searchSelectedIds.value.push(paperId);
                    }
                    searchSelectAll.value = searchSelectedIds.value.length === searchResults.value.length;
                }

                function toggleSearchSelectAll(val) {
                    if (val) {
                        searchSelectedIds.value = searchResults.value.map(p => p.id);
                    } else {
                        searchSelectedIds.value = [];
                    }
                }

                async function exportRecent(format) {
                    if (recentSelectedIds.value.length === 0) return;
                    try {
                        const res = await fetch(`${API_BASE}/export/papers`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                paper_ids: recentSelectedIds.value,
                                format: format,
                                include_summary: true
                            })
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `recent_papers.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success(`已导出 ${recentSelectedIds.value.length} 篇论文`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                async function exportSearch(format) {
                    if (searchSelectedIds.value.length === 0) return;
                    try {
                        const res = await fetch(`${API_BASE}/export/papers`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                paper_ids: searchSelectedIds.value,
                                format: format,
                                include_summary: true
                            })
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `search_results.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success(`已导出 ${searchSelectedIds.value.length} 篇论文`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                async function exportCollection(format) {
                    if (!viewingCollection.value) return;
                    try {
                        const res = await fetch(`${API_BASE}/export/collection`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                collection_id: viewingCollection.value.id,
                                format: format,
                                include_summary: true
                            })
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `collection_${viewingCollection.value.name.replace(/\s+/g, '_')}.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success('导出成功');
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                function navigateTo(page) {
                    currentPage.value = page;
                }

                function navigateToHome() {
                    const app = document.querySelector('#app');
                    if (app) {
                        app.classList.add('page-circle-exit');
                        setTimeout(() => {
                            currentPage.value = 'home';
                            app.classList.remove('page-circle-exit');
                        }, 350);
                    } else {
                        currentPage.value = 'home';
                    }
                }

                function onTabChange(tab) {
                    currentPage.value = tab;
                }

                function toggleHomeSelect(paperId) {
                    const idx = homeSelectedIds.value.indexOf(paperId);
                    if (idx >= 0) {
                        homeSelectedIds.value.splice(idx, 1);
                    } else {
                        homeSelectedIds.value.push(paperId);
                    }
                }

                async function startHomeSearch() {
                    if (!homeQuery.value.trim()) return;
                    
                    homeSearching.value = true;
                    homeLogs.value = [];
                    homeResults.value = [];
                    homeSelectedIds.value = [];
                    
                    try {
                        const params = new URLSearchParams({ q: homeQuery.value });
                        const response = await fetch(`${API_BASE}/papers/quick?${params}`);
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            homeLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'result') {
                                            homeResults.value.push(data.paper);
                                        } else if (data.type === 'done') {
                                            if (data.total === 0) {
                                                homeLogs.value.push({ type: 'info', message: '未找到匹配的论文' });
                                            }
                                        } else if (data.type === 'error') {
                                            homeLogs.value.push({ type: 'error', message: data.message });
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        homeLogs.value.push({ type: 'error', message: `搜索失败: ${e.message}` });
                    } finally {
                        homeSearching.value = false;
                    }
                }

                async function exportHome(format) {
                    if (homeSelectedIds.value.length === 0) return;
                    try {
                        const res = await fetch(`${API_BASE}/export/papers`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                paper_ids: homeSelectedIds.value,
                                format: format,
                                include_summary: true
                            })
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `search_results.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success(`已导出 ${homeSelectedIds.value.length} 篇论文`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                function initCharts() {
                    const yearEl = document.getElementById('yearChart');
                    const categoryEl = document.getElementById('categoryChart');
                    if (yearEl) yearChart = echarts.init(yearEl);
                    if (categoryEl) categoryChart = echarts.init(categoryEl);
                }

                function renderYearChart(data) {
                    if (!yearChart) return;
                    const years = data ? Object.keys(data) : [];
                    const counts = data ? Object.values(data) : [];
                    
                    if (years.length === 0) {
                        yearChart.setOption({
                            title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#909399', fontSize: 14 } },
                            xAxis: { show: false },
                            yAxis: { show: false },
                            series: []
                        });
                        return;
                    }
                    
                    yearChart.setOption({
                        tooltip: { trigger: 'axis' },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: years, axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d' } },
                        yAxis: { type: 'value', axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d' }, splitLine: { lineStyle: { color: '#e8e6e1' } } },
                        series: [{ data: counts, type: 'bar', itemStyle: { color: '#1e3a5f', borderRadius: [4, 4, 0, 0] } }]
                    });
                }

                function renderCategoryChart(data) {
                    if (!categoryChart) return;
                    const categories = data || [];
                    
                    if (categories.length === 0) {
                        categoryChart.setOption({
                            title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#909399', fontSize: 14 } },
                            xAxis: { show: false },
                            yAxis: { show: false },
                            series: []
                        });
                        return;
                    }
                    
                    categoryChart.setOption({
                        tooltip: { trigger: 'item' },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: categories.map(d => d.name), axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d', rotate: 30 } },
                        yAxis: { type: 'value', axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d' }, splitLine: { lineStyle: { color: '#e8e6e1' } } },
                        series: [{ data: categories.map(d => d.count), type: 'bar', itemStyle: { color: '#c9a227', borderRadius: [4, 4, 0, 0] } }]
                    });
                }

                watch(showSetup, (val) => {
                    if (!val) {
                        nextTick(() => {
                            if (!yearChart) initCharts();
                            renderYearChart(stats.value?.years);
                            renderCategoryChart(stats.value?.categories?.top);
                        });
                    }
                });
                
                watch(currentPage, (newPage) => {
                    if (newPage === 'sync') {
                        nextTick(() => {
                            if (!yearChart) initCharts();
                            renderYearChart(stats.value?.years);
                            renderCategoryChart(stats.value?.categories?.top);
                        });
                    }
                });

                function toggleChat() {
                    chatExpanded.value = !chatExpanded.value;
                    if (chatExpanded.value && chatSessions.value.length === 0) {
                        fetchChatSessions();
                    }
                }

                async function fetchChatSessions() {
                    try {
                        const res = await fetch(`${API_BASE}/chat/sessions`);
                        chatSessions.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch chat sessions:', e);
                    }
                }

                async function createNewChat() {
                    try {
                        const res = await fetch(`${API_BASE}/chat/sessions`, { method: 'POST' });
                        const session = await res.json();
                        chatSessions.value.unshift(session);
                        selectChatSession(session);
                    } catch (e) {
                        ElementPlus.ElMessage.error('创建对话失败');
                    }
                }

                async function selectChatSession(session) {
                    currentChatSession.value = session;
                    showChatSidebar.value = false;
                    try {
                        const res = await fetch(`${API_BASE}/chat/sessions/${session.id}`);
                        const data = await res.json();
                        chatMessages.value = data.messages || [];
                        await nextTick();
                        scrollToBottom();
                    } catch (e) {
                        console.error('Failed to fetch messages:', e);
                    }
                }

                async function deleteChatSession(session) {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除对话 "${session.title}" 吗？`,
                            '删除对话',
                            { confirmButtonText: '删除', cancelButtonText: '取消', type: 'warning' }
                        );
                        
                        const res = await fetch(`${API_BASE}/chat/sessions/${session.id}`, { method: 'DELETE' });
                        if (res.ok) {
                            const idx = chatSessions.value.findIndex(s => s.id === session.id);
                            if (idx >= 0) chatSessions.value.splice(idx, 1);
                            
                            if (currentChatSession.value?.id === session.id) {
                                currentChatSession.value = null;
                                chatMessages.value = [];
                            }
                            ElementPlus.ElMessage.success('已删除');
                        }
                    } catch (e) {
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error('删除失败');
                        }
                    }
                }

                function scrollToBottom() {
                    if (chatMessagesContainer.value) {
                        chatMessagesContainer.value.scrollTop = chatMessagesContainer.value.scrollHeight;
                    }
                }

                function handleChatScroll() {
                    if (chatMessagesContainer.value) {
                        const { scrollTop, scrollHeight, clientHeight } = chatMessagesContainer.value;
                        const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;
                        userScrolledUp.value = !isNearBottom;
                    }
                }

                async function sendChatMessage() {
                    if (!chatInput.value.trim() || chatTyping.value) return;
                    
                    if (!currentChatSession.value) {
                        await createNewChat();
                        if (!currentChatSession.value) return;
                    }

                    const userMessage = {
                        id: Date.now(),
                        role: 'user',
                        content: chatInput.value,
                        paper_ids: selectedChatPapers.value.map(p => p.arxiv_id),
                        created_at: new Date().toISOString()
                    };
                    chatMessages.value.push(userMessage);
                    
                    const messageContent = chatInput.value;
                    const paperIds = selectedChatPapers.value.map(p => p.arxiv_id);
                    chatInput.value = '';
                    selectedChatPapers.value = [];
                    chatTyping.value = true;
                    chatProgress.value = null;
                    userScrolledUp.value = false;

                    await nextTick();
                    scrollToBottom();

                    try {
                        const response = await fetch(`${API_BASE}/chat/sessions/${currentChatSession.value.id}/send`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content: messageContent, paper_ids: paperIds })
                        });

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        let assistantMessage = { id: Date.now() + 1, role: 'assistant', content: '', created_at: new Date().toISOString() };
                        chatMessages.value.push(assistantMessage);

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'progress') {
                                            chatProgress.value = {
                                                stage: data.stage,
                                                message: data.message,
                                                arxivId: data.arxiv_id,
                                                paperIndex: data.paper_index,
                                                totalPapers: data.total_papers,
                                                progress: data.progress,
                                                textLength: data.text_length,
                                                pageCount: data.page_count,
                                            };
                                            await nextTick();
                                            scrollToBottom();
                                        } else if (data.type === 'chunk') {
                                            chatProgress.value = null;
                                            assistantMessage.content += data.content;
                                            await nextTick();
                                            if (!userScrolledUp.value) {
                                                scrollToBottom();
                                            }
                                        } else if (data.type === 'error') {
                                            chatProgress.value = null;
                                            assistantMessage.content = `**错误**: ${data.message}`;
                                        } else if (data.type === 'done') {
                                            chatProgress.value = null;
                                        }
                                    } catch (e) {}
                                }
                            }
                        }

                        fetchChatSessions();
                    } catch (e) {
                        ElementPlus.ElMessage.error('发送消息失败');
                    } finally {
                        chatTyping.value = false;
                        chatProgress.value = null;
                        userScrolledUp.value = false;
                    }
                }

                function formatChatMessage(content, isStreaming = false) {
                    if (!content) return '';
                    
                    let processedContent = content;
                    
                    if (isStreaming) {
                        const codeBlockCount = (content.match(/```/g) || []).length;
                        if (codeBlockCount % 2 !== 0) {
                            processedContent += '\n```';
                        }
                    }
                    
                    if (typeof marked !== 'undefined') {
                        try {
                            return marked.parse(processedContent, {
                                breaks: true,
                                gfm: true,
                            });
                        } catch (e) {
                            return content
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/\n/g, '<br>');
                        }
                    }
                    return content
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/`(.*?)`/g, '<code style="background:#f5f5f5;padding:2px 6px;border-radius:4px;">$1</code>');
                }

                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString('zh-CN');
                }

                function formatChatTime(timeStr) {
                    if (!timeStr) return '';
                    const date = new Date(timeStr);
                    const now = new Date();
                    const diff = now - date;
                    if (diff < 60000) return '刚刚';
                    if (diff < 3600000) return `${Math.floor(diff / 60000)} 分钟前`;
                    if (diff < 86400000) return `${Math.floor(diff / 3600000)} 小时前`;
                    return date.toLocaleDateString('zh-CN');
                }

                function togglePaperSelection(paper) {
                    const idx = selectedChatPapers.value.findIndex(p => p.arxiv_id === paper.arxiv_id);
                    if (idx >= 0) {
                        selectedChatPapers.value.splice(idx, 1);
                    } else {
                        selectedChatPapers.value.push(paper);
                    }
                }

                function removeSelectedChatPaper(arxivId) {
                    const idx = selectedChatPapers.value.findIndex(p => p.arxiv_id === arxivId);
                    if (idx >= 0) {
                        selectedChatPapers.value.splice(idx, 1);
                    }
                }

                function addToCart(paper) {
                    if (!paperCart.value.some(p => p.arxiv_id === paper.arxiv_id)) {
                        paperCart.value.push(paper);
                        ElementPlus.ElMessage.success(t('basket.added'));
                    } else {
                        ElementPlus.ElMessage.info(t('basket.alreadyInCart'));
                    }
                }

                function removeFromCart(index) {
                    paperCart.value.splice(index, 1);
                }

                function removeFromCartByArxivId(arxivId) {
                    const idx = paperCart.value.findIndex(p => p.arxiv_id === arxivId);
                    if (idx >= 0) {
                        paperCart.value.splice(idx, 1);
                        ElementPlus.ElMessage.success(t('basket.removed'));
                    }
                }

                function clearCart() {
                    paperCart.value = [];
                    ElementPlus.ElMessage.success(t('basket.cleared'));
                }

                function isInCart(arxivId) {
                    return paperCart.value.some(p => p.arxiv_id === arxivId);
                }

                async function exportCart(format) {
                    if (paperCart.value.length === 0) return;
                    
                    const papersWithId = paperCart.value.filter(p => p.id);
                    const filename = `papers_export_${Date.now()}`;
                    
                    if (format === 'pdf') {
                        if (papersWithId.length === 0) {
                            ElementPlus.ElMessage.warning('PDF 导出需要论文已保存到数据库，请先同步论文');
                            return;
                        }
                        try {
                            const res = await fetch(`${API_BASE}/export/papers`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    paper_ids: papersWithId.map(p => p.id), 
                                    format: 'pdf',
                                    include_summary: true 
                                })
                            });
                            if (res.ok) {
                                const blob = await res.blob();
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `${filename}.pdf`;
                                a.click();
                                URL.revokeObjectURL(url);
                            } else {
                                ElementPlus.ElMessage.error('导出失败');
                            }
                        } catch (e) {
                            ElementPlus.ElMessage.error('导出失败');
                        }
                        return;
                    }
                    
                    if (format === 'pdf_original') {
                        ElementPlus.ElMessage.info(`开始下载 ${paperCart.value.length} 个 PDF 原文...`);
                        let successCount = 0;
                        for (const paper of paperCart.value) {
                            try {
                                const res = await fetch(`${API_BASE}/papers/pdf/${paper.arxiv_id}`);
                                if (res.ok) {
                                    const blob = await res.blob();
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    const safeId = paper.arxiv_id.replace(/[\/\\]/g, '_');
                                    a.download = `${safeId}.pdf`;
                                    a.click();
                                    URL.revokeObjectURL(url);
                                    successCount++;
                                    await new Promise(r => setTimeout(r, 300));
                                } else {
                                    console.error(`Failed to download ${paper.arxiv_id}: HTTP ${res.status}`);
                                }
                            } catch (e) {
                                console.error(`Failed to download ${paper.arxiv_id}:`, e);
                            }
                        }
                        if (successCount > 0) {
                            ElementPlus.ElMessage.success(`已下载 ${successCount} 个 PDF 原文`);
                        } else {
                            ElementPlus.ElMessage.error('下载失败');
                        }
                        return;
                    }
                    
                    let content = '';
                    
                    if (format === 'markdown') {
                        content = paperCart.value.map(p => {
                            return `## ${p.title}\n\n**arXiv:** ${p.arxiv_id}\n**作者:** ${p.authors?.map(a => a.name).join(', ') || 'N/A'}\n**日期:** ${p.published || 'N/A'}\n\n**摘要:**\n${p.abstract || ''}\n\n${p.summary_text ? '**AI 总结:**\n' + p.summary_text : ''}\n\n---\n`;
                        }).join('\n');
                        downloadFile(content, `${filename}.md`, 'text/markdown');
                    } else if (format === 'csv') {
                        const header = 'arxiv_id,title,authors,published,abstract\n';
                        const rows = paperCart.value.map(p => {
                            const title = (p.title || '').replace(/"/g, '""');
                            const authors = (p.authors?.map(a => a.name).join('; ') || '').replace(/"/g, '""');
                            const abstract = (p.abstract || '').replace(/"/g, '""').replace(/\n/g, ' ');
                            return `"${p.arxiv_id}","${title}","${authors}","${p.published || ''}","${abstract}"`;
                        }).join('\n');
                        downloadFile(header + rows, `${filename}.csv`, 'text/csv');
                    } else if (format === 'bibtex') {
                        content = paperCart.value.map(p => {
                            const year = p.published ? new Date(p.published).getFullYear() : new Date().getFullYear();
                            const firstAuthor = p.authors?.[0]?.name?.split(' ').pop() || 'Unknown';
                            const key = `${firstAuthor}${year}${p.arxiv_id.replace('.', '')}`;
                            return `@article{${key},\n  title={${p.title || 'Untitled'}},\n  author={${p.authors?.map(a => a.name).join(' and ') || 'Unknown'}},\n  journal={arXiv preprint arXiv:${p.arxiv_id}},\n  year={${year}},\n  eprint={${p.arxiv_id}}\n}`;
                        }).join('\n\n');
                        downloadFile(content, `${filename}.bib`, 'application/x-bibtex');
                    }
                }

                function addCartToCollection() {
                    if (paperCart.value.length === 0) return;
                    selectedCollectionId.value = null;
                    showAddToCollection.value = true;
                }

                function copyCartLinks() {
                    if (paperCart.value.length === 0) return;
                    const links = paperCart.value.map(p => `https://arxiv.org/abs/${p.arxiv_id}`).join('\n');
                    
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(links).then(() => {
                            ElementPlus.ElMessage.success(`已复制 ${paperCart.value.length} 个链接`);
                        }).catch(() => {
                            fallbackCopy(links);
                        });
                    } else {
                        fallbackCopy(links);
                    }
                    
                    function fallbackCopy(text) {
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed';
                        textarea.style.left = '-9999px';
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            ElementPlus.ElMessage.success(`已复制 ${paperCart.value.length} 个链接`);
                        } catch (e) {
                            ElementPlus.ElMessage.error('复制失败，请手动复制');
                        }
                        document.body.removeChild(textarea);
                    }
                }

                function downloadFile(content, filename, mimeType) {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                onMounted(() => {
                    checkInitStatus();
                    fetchStats();
                    fetchFieldStats();
                    fetchRecentCache();
                    fetchCollections();
                    fetchSyncStatus();
                    fetchConfig();
                    
                    window.addEventListener('analyze-paper', (e) => {
                        const paper = e.detail;
                        if (!selectedChatPapers.value.some(p => p.arxiv_id === paper.arxiv_id)) {
                            selectedChatPapers.value.push(paper);
                        }
                        chatExpanded.value = true;
                        if (chatSessions.value.length === 0) {
                            fetchChatSessions();
                        }
                    });
                });

                return {
                    showSetup, setupStep, setupConfig, initializing, testingAI, initLogs, initProgress,
                    initCurrentQuery, initTotalQueries, waitingMessage, initComplete,
                    showSettings, settingsConfig, savingSettings,
                    currentPage, stats, fieldStats, expandedGroups, recentPapers, searchResults, collections,
                    loadingRecent, updatingRecent, recentLogs,
                    recentDays, recentNeedSync, recentCategories,
                    categoryOptions, daysOptions, limitOptions, syncYearOptions, initYearOptions, syncYearsBackOptions, searchDaysOptions, aiLanguageOptions,
                    searching, searchQuery, searchDays, searchLogs,
                    syncStatus, syncing, syncLogs, syncYearsBack, syncForce,
                    syncStatusText, syncStatusClass, syncTimeClass, formatSyncTime,
                    recentCacheStatus, arxivCategories, allCategories,
                    showCreateCollection, showAddToCollection, showDeleteConfirm,
                    newCollection, editingCollection, deletingCollection,
                    savingCollection, deletingCollectionInProgress,
                    selectedCollectionId, selectedPaper, addingToCollection,
                    viewingCollection, collectionPapers, loadingCollectionPapers,
                    recentSelectedIds, recentSelectAll, searchSelectedIds, searchSelectAll,
                    homeQuery, homeSearching, homeLogs, homeResults, homeSelectedIds,
                    checkInitStatus, fetchCategories, testSetupAI, toggleSetupField, toggleCategoryGroup, startInitialSync,
                    testAIConnection, saveSettings, saveApiKey, toggleSettingsField, onLanguageChange,
                    fetchStats, fetchFieldStats, fetchRecentCache, updateRecentPapers, startSearch, fetchCollections,
                    fetchSyncStatus, startSync,
                    saveCollection, cancelCollectionDialog, openEditCollection,
                    confirmDeleteCollection, deleteCollection,
                    openCollectionDetail, removePaperFromCollection,
                    addToCollection, confirmAddToCollection,
                    toggleRecentSelect, toggleRecentSelectAll, toggleSearchSelect, toggleSearchSelectAll,
                    exportRecent, exportSearch, exportCollection,
                    navigateTo, navigateToHome, onTabChange, startHomeSearch, toggleHomeSelect, exportHome,
                    chatExpanded, chatSessions, currentChatSession, chatMessages, chatInput, chatPosition, chatPanelRef,
                    selectedChatPapers, chatTyping, chatProgress, showChatSidebar,
                    chatUnreadCount, chatMessagesContainer,
                    toggleChat, fetchChatSessions, createNewChat, selectChatSession,
                    sendChatMessage, formatChatMessage, formatChatTime, formatDate,
                    togglePaperSelection, removeSelectedChatPaper, deleteChatSession, userScrolledUp,
                    paperCart, showCart, cartExportLoading, cartPosition, cartPanelRef,
                    startDragCart, startDragChat,
                    addToCart, removeFromCart, removeFromCartByArxivId, clearCart, isInCart, exportCart,
                    addCartToCollection, copyCartLinks,
                    scrollToBottom, handleChatScroll,
                    t, currentLang, toggleLanguage, i18n, getFieldTranslation,
                    // Field Selector
                    showFieldSelector, fieldSelectorSource, tempSelectedFields, fieldSearchQuery,
                    fieldSelectorExpanded, openFieldSelector, toggleFieldSelectorGroup, toggleTempField,
                    removeFromTempSelection, clearTempSelection, confirmFieldSelection, filteredCategories,
                    fieldAdvancedMode, advancedQueriesText, advancedQueriesLines, parsedCodeResult
                };
            }
        });

        app.component('paper-card', {
            props: ['paper', 'collections', 'inCollection', 'inCart'],
            emits: ['add-to-collection', 'remove-from-collection', 'download-card', 'analyze-paper', 'add-to-cart', 'remove-from-cart'],
            template: `
                <div class="paper-card" :data-arxiv-id="paper.arxiv_id">
                    <div class="paper-header">
                        <div class="paper-title" @click="openArxiv(paper.arxiv_id)">{{ paper.title }}</div>
                    </div>
                    <div v-if="paper.title_translation" class="paper-title-cn">{{ paper.title_translation }}</div>
                    <div class="paper-meta">
                        <span class="paper-meta-item">
                            <el-icon><Calendar /></el-icon>
                            {{ formatDate(paper.published) }}
                        </span>
                        <span class="paper-meta-item">
                            <el-icon><User /></el-icon>
                            {{ paper.authors?.slice(0, 2).map(a => a.name).join(', ') }}{{ paper.authors?.length > 2 ? (isZh ? ' 等' : ' et al.') : '' }}
                        </span>
                        <span class="paper-relevance">
                            <span v-for="i in 5" :key="i" class="star">{{ i <= paper.relevance_score ? '★' : '☆' }}</span>
                        </span>
                    </div>
                    <div class="paper-category" v-if="paper.category_explanation">{{ paper.category_explanation }}</div>
                    <div v-if="!expanded" class="paper-abstract-preview">{{ paper.abstract?.slice(0, 200) }}...</div>
                    <div class="paper-actions">
                        <el-button size="small" text type="primary" @click="openArxiv(paper.arxiv_id)">
                            <el-icon><Promotion /></el-icon> {{ t('paper.arxiv') }}
                        </el-button>
                        <el-button size="small" text type="primary" @click="downloadPDF(paper.arxiv_id)">
                            <el-icon><Download /></el-icon> {{ t('paper.pdf') }}
                        </el-button>
                        <el-button size="small" text type="primary" @click="downloadCard">
                            <el-icon><Picture /></el-icon> {{ t('paper.card') }}
                        </el-button>
                        <el-button v-if="!inCart" size="small" text type="warning" @click="$emit('add-to-cart', paper)">
                            <el-icon><Star /></el-icon> {{ t('paper.bookmark') }}
                        </el-button>
                        <el-button v-else size="small" type="warning" plain @click="$emit('remove-from-cart', paper.arxiv_id)">
                            <el-icon><StarFilled /></el-icon> {{ t('paper.bookmarked') }}
                        </el-button>
                        <el-button size="small" text type="primary" @click="analyzePaper">
                            <el-icon><ChatDotRound /></el-icon> {{ t('paper.analyze') }}
                        </el-button>
                        <el-button size="small" text @click="$emit('add-to-collection', paper)">
                            <el-icon><Folder /></el-icon> {{ t('paper.addToCollection') }}
                        </el-button>
                        <el-button size="small" text type="primary" @click="expanded = !expanded">
                            {{ expanded ? t('paper.collapse') : t('paper.expandDetail') }}
                        </el-button>
                        <el-button v-if="inCollection" size="small" text type="danger" @click="$emit('remove-from-collection', paper.id)">
                            <el-icon><Delete /></el-icon> {{ t('paper.removeFromCollection') }}
                        </el-button>
                    </div>
                    <div v-if="expanded" class="paper-detail">
                        <div v-if="paper.summary_text" class="ai-summary-section">
                            <h4>{{ t('paper.aiSummary') }}</h4>
                            <p class="summary-text" v-html="formatSummary(paper.summary_text)"></p>
                        </div>
                        <div v-if="paper.key_findings?.length" class="key-findings">
                            <h4>{{ t('paper.keyFindings') }}</h4>
                            <ul>
                                <li v-for="(finding, i) in paper.key_findings" :key="i">{{ finding }}</li>
                            </ul>
                        </div>
                        <div v-if="paper.keywords?.length" class="paper-keywords">
                            <h4>{{ t('paper.keywords') }}</h4>
                            <div class="keywords-list">
                                <el-tag v-for="kw in paper.keywords" :key="kw" size="small" type="info">{{ kw }}</el-tag>
                            </div>
                        </div>
                        <div v-if="paper.figure_url" class="paper-figure">
                            <img :src="paper.figure_url" @click="openImage(paper.figure_url)" />
                        </div>
                        <div class="abstract-section">
                            <h4>{{ t('paper.abstract') }}</h4>
                            <p>{{ paper.abstract }}</p>
                            <div v-if="paper.abstract_translation" class="translation">
                                <h4>{{ t('paper.chineseTranslation') }}</h4>
                                <p>{{ paper.abstract_translation }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup(props) {
                const expanded = ref(false);
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString('zh-CN');
                };
                const formatSummary = (text) => {
                    if (!text) return '';
                    return text.replace(/\n/g, '<br>');
                };
                const openArxiv = (arxivId) => {
                    window.open(`https://arxiv.org/abs/${arxivId}`, '_blank');
                };
                const downloadPDF = (arxivId) => {
                    window.open(`https://arxiv.org/pdf/${arxivId}.pdf`, '_blank');
                };
                const openImage = (url) => {
                    window.open(url, '_blank');
                };
                
                const isZh = computed(() => currentLang.value === 'zh');
                const downloadCard = async () => {
                    const scale = 2;
                    const width = 700 * scale;
                    const padding = 32 * scale;
                    const lineHeight = 24 * scale;
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const wrapText = (text, maxWidth, fontSize) => {
                        if (!text) return [];
                        ctx.font = `${fontSize * scale}px sans-serif`;
                        const chars = text.split('');
                        const result = [];
                        let current = '';
                        for (const char of chars) {
                            const test = current + char;
                            if (ctx.measureText(test).width > maxWidth && current) {
                                result.push(current);
                                current = char;
                            } else {
                                current = test;
                            }
                        }
                        if (current) result.push(current);
                        return result;
                    };
                    
                    let y = padding;
                    const elements = [];
                    
                    const titleLines = wrapText(props.paper.title, width - padding * 2, 20);
                    titleLines.forEach(line => {
                        elements.push({ type: 'text', text: line, font: `bold ${20 * scale}px Georgia, "Noto Serif SC", serif`, color: '#1e3a5f', y: y });
                        y += 32 * scale;
                    });
                    
                    if (props.paper.title_translation) {
                        const transLines = wrapText(props.paper.title_translation, width - padding * 2, 16);
                        transLines.forEach(line => {
                            elements.push({ type: 'text', text: line, font: `italic ${16 * scale}px sans-serif`, color: '#5a6c7d', y: y });
                            y += 26 * scale;
                        });
                        y += 8 * scale;
                    }
                    
                    const pubDate = props.paper.published ? new Date(props.paper.published).toLocaleDateString('zh-CN') : 'N/A';
                    const authors = props.paper.authors?.slice(0, 4).map(a => a.name).join(', ') || '';
                    elements.push({ type: 'text', text: `${pubDate}  |  ${authors}${props.paper.authors?.length > 4 ? ' 等' : ''}`, font: `${13 * scale}px sans-serif`, color: '#909399', y: y });
                    y += 36 * scale;
                    
                    elements.push({ type: 'divider', y: y });
                    y += 20 * scale;
                    
                    if (props.paper.summary_text) {
                        elements.push({ type: 'section-title', text: 'AI 总结', y: y });
                        y += 28 * scale;
                        const paragraphs = props.paper.summary_text.split('\n\n');
                        paragraphs.forEach(para => {
                            if (para.trim()) {
                                const summaryLines = wrapText(para.trim(), width - padding * 2, 14);
                                summaryLines.forEach(line => {
                                    elements.push({ type: 'text', text: line, font: `${14 * scale}px sans-serif`, color: '#333', y: y });
                                    y += 22 * scale;
                                });
                                y += 8 * scale;
                            }
                        });
                        y += 4 * scale;
                    }
                    
                    if (props.paper.keywords?.length) {
                        elements.push({ type: 'section-title', text: '关键词', y: y });
                        y += 28 * scale;
                        const keywordsText = props.paper.keywords.join('  •  ');
                        const keywordLines = wrapText(keywordsText, width - padding * 2, 13);
                        keywordLines.forEach(line => {
                            elements.push({ type: 'text', text: line, font: `${13 * scale}px sans-serif`, color: '#c9a227', y: y });
                            y += 20 * scale;
                        });
                        y += 12 * scale;
                    }
                    
                    if (props.paper.key_findings?.length) {
                        elements.push({ type: 'section-title', text: '关键发现', y: y });
                        y += 28 * scale;
                        props.paper.key_findings.forEach(finding => {
                            const findingLines = wrapText(`• ${finding}`, width - padding * 2 - 20 * scale, 14);
                            findingLines.forEach(line => {
                                elements.push({ type: 'text', text: line, font: `${14 * scale}px sans-serif`, color: '#5a6c7d', y: y });
                                y += 22 * scale;
                            });
                        });
                        y += 12 * scale;
                    }
                    
                    if (props.paper.figure_url) {
                        try {
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            await new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                                img.src = props.paper.figure_url;
                            });
                            const maxImgWidth = width - padding * 2;
                            const imgScale = Math.min(1, maxImgWidth / img.width);
                            const imgDrawWidth = img.width * imgScale;
                            const imgDrawHeight = img.height * imgScale;
                            elements.push({ type: 'image', img, y, width: imgDrawWidth, height: imgDrawHeight });
                            y += imgDrawHeight + 20 * scale;
                        } catch (e) {}
                    }
                    
                    elements.push({ type: 'section-title', text: '摘要 (Abstract)', y: y });
                    y += 28 * scale;
                    
                    const abstractLines = wrapText(props.paper.abstract || '', width - padding * 2, 14);
                    abstractLines.forEach(line => {
                        elements.push({ type: 'text', text: line, font: `${14 * scale}px sans-serif`, color: '#444', y: y });
                        y += 22 * scale;
                    });
                    y += 12 * scale;
                    
                    if (props.paper.abstract_translation) {
                        elements.push({ type: 'section-title', text: t('paper.chineseTranslation'), y: y });
                        y += 28 * scale;
                        const transAbstractLines = wrapText(props.paper.abstract_translation, width - padding * 2, 14);
                        transAbstractLines.forEach(line => {
                            elements.push({ type: 'text', text: line, font: `${14 * scale}px sans-serif`, color: '#555', y: y });
                            y += 22 * scale;
                        });
                        y += 12 * scale;
                    }
                    
                    y += 16 * scale;
                    elements.push({ type: 'divider', y: y });
                    y += 20 * scale;
                    
                    elements.push({ type: 'text', text: `arXiv: ${props.paper.arxiv_id}`, font: `${12 * scale}px sans-serif`, color: '#909399', y: y });
                    y += 24 * scale;
                    elements.push({ type: 'text', text: 'arXiv Pulse', font: `bold ${13 * scale}px Georgia, serif`, color: '#c9a227', y: y });
                    
                    const height = y + padding;
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, width, height);
                    
                    ctx.fillStyle = '#1e3a5f';
                    ctx.fillRect(0, 0, 6 * scale, height);
                    
                    ctx.fillStyle = '#c9a227';
                    ctx.fillRect(0, height - 4 * scale, width, 4 * scale);
                    
                    for (const el of elements) {
                        if (el.type === 'text') {
                            ctx.font = el.font;
                            ctx.fillStyle = el.color;
                            ctx.fillText(el.text, padding, el.y);
                        } else if (el.type === 'section-title') {
                            ctx.font = `bold ${15 * scale}px sans-serif`;
                            ctx.fillStyle = '#1e3a5f';
                            ctx.fillText(el.text, padding, el.y);
                            ctx.fillStyle = '#c9a227';
                            ctx.fillRect(padding, el.y + 6 * scale, 40 * scale, 2 * scale);
                        } else if (el.type === 'divider') {
                            ctx.strokeStyle = '#e8e6e1';
                            ctx.lineWidth = 1 * scale;
                            ctx.beginPath();
                            ctx.moveTo(padding, el.y);
                            ctx.lineTo(width - padding, el.y);
                            ctx.stroke();
                        } else if (el.type === 'image') {
                            ctx.drawImage(el.img, padding, el.y, el.width, el.height);
                        }
                    }
                    
                    const link = document.createElement('a');
                    link.download = `paper_${props.paper.arxiv_id}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                    
                    ElementPlus.ElMessage.success('已导出卡片图片');
                };
                
                const analyzePaper = () => {
                    window.dispatchEvent(new CustomEvent('analyze-paper', { detail: props.paper }));
                };
                
                return { expanded, formatDate, formatSummary, openArxiv, downloadPDF, openImage, downloadCard, analyzePaper, t, currentLang, isZh };
            }
        });

        app.use(ElementPlus);
        if (window.ElementPlusIconsVue) {
            for (const [key, component] of Object.entries(window.ElementPlusIconsVue)) {
                app.component(key, component);
            }
        }
        app.mount('#app');
    </script>
</body>
</html>
