<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>arXiv Pulse - 学术文献追踪</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="libs/element-plus/index.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="showSetup" class="setup-container">
            <div class="setup-card">
                <h1>arXiv Pulse</h1>
                <p class="subtitle">{{ t('home.subtitle') }}</p>
                
                <div class="setup-steps">
                    <div class="setup-step" :class="setupStep > 1 ? 'done' : (setupStep === 1 ? 'active' : 'pending')">1</div>
                    <div class="setup-step" :class="setupStep > 2 ? 'done' : (setupStep === 2 ? 'active' : 'pending')">2</div>
                    <div class="setup-step" :class="setupStep > 3 ? 'done' : (setupStep === 3 ? 'active' : 'pending')">3</div>
                    <div class="setup-step" :class="setupStep >= 4 ? 'active' : 'pending'">4</div>
                </div>

                <div v-if="setupStep === 1">
                    <h3 style="margin-bottom: 24px; color: var(--primary); font-size: 18px;">{{ t('setup.aiConfig') }}</h3>
                    <el-form label-position="top">
                        <el-form-item :label="t('settings.apiBaseUrl')">
                            <el-input v-model="setupConfig.ai_base_url" placeholder="https://api.openai.com/v1" />
                        </el-form-item>
                        <el-form-item :label="t('settings.apiKey')">
                            <el-input v-model="setupConfig.ai_api_key" type="password" show-password placeholder="Enter your API Key" />
                        </el-form-item>
                        <el-form-item :label="t('settings.modelName')">
                            <el-input v-model="setupConfig.ai_model" placeholder="DeepSeek-V3.2" />
                        </el-form-item>
                        <el-form-item :label="t('settings.aiLanguage')">
                            <el-select v-model="setupConfig.translate_language" style="width: 100%;">
                                <el-option v-for="lang in aiLanguageOptions" :key="lang.value" :label="lang.label" :value="lang.value" />
                            </el-select>
                        </el-form-item>
                    </el-form>
                    <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                        <el-button @click="testSetupAI" :loading="testingAI">{{ t('settings.testConnection') }}</el-button>
                        <el-button type="primary" @click="setupStep = 2">{{ t('common.next') }}</el-button>
                    </div>
                </div>

                <div v-if="setupStep === 2">
                    <h3 style="margin-bottom: 8px; color: var(--primary); font-size: 18px;">{{ t('setup.selectFields') }}</h3>
                    <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">{{ t('setup.fieldsHint') }}</p>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--bg-subtle); border-radius: 10px; cursor: pointer; margin-bottom: 16px;" @click.stop="openFieldSelector('init')">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                {{ currentLang === 'zh' ? '已选择' : 'Selected' }}: {{ setupConfig.selected_fields.length }} {{ currentLang === 'zh' ? '个研究领域' : 'research fields' }}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">
                                {{ setupConfig.selected_fields.slice(0, 3).map(id => allCategories[id]?.name || id).join(', ') }}{{ setupConfig.selected_fields.length > 3 ? '...' : '' }}
                            </div>
                        </div>
                        <div style="padding: 6px 12px; background: var(--primary); color: white; border-radius: 4px; font-size: 13px;">
                            {{ currentLang === 'zh' ? '选择领域' : 'Select Fields' }}
                        </div>
                    </div>
                    
                    <div style="margin-top: 24px; display: flex; justify-content: space-between;">
                        <el-button @click="setupStep = 1">{{ t('common.back') }}</el-button>
                        <el-button type="primary" @click="setupStep = 3" :disabled="setupConfig.selected_fields.length === 0 && setupConfig.search_queries.length === 0">
                            {{ t('common.next') }}
                        </el-button>
                    </div>
                </div>

                <div v-if="setupStep === 3">
                    <h3 style="margin-bottom: 24px; color: var(--primary); font-size: 18px;">{{ t('setup.syncSettings') }}</h3>
                    <el-form label-position="top">
                        <el-form-item :label="t('setup.yearsBack')">
                            <el-select v-model="setupConfig.years_back" style="width: 100%;">
                                <el-option v-for="item in initYearOptions" :key="item.value" :label="item.label" :value="item.value" />
                            </el-select>
                        </el-form-item>
                        <el-form-item :label="t('setup.maxResultsPerField')">
                            <el-input-number v-model="setupConfig.arxiv_max_results_per_field" :min="1000" :max="50000" :step="1000" style="width: 100%;" />
                        </el-form-item>
                        <el-form-item :label="t('setup.maxResultsGlobal')">
                            <el-input-number v-model="setupConfig.arxiv_max_results" :min="10000" :max="200000" :step="10000" style="width: 100%;" />
                        </el-form-item>
                        <el-form-item :label="t('setup.recentPapersLimit')">
                            <el-input-number v-model="setupConfig.recent_papers_limit" :min="20" :max="200" :step="10" style="width: 100%;" />
                        </el-form-item>
                        <el-form-item :label="t('setup.searchLimit')">
                            <el-input-number v-model="setupConfig.search_limit" :min="5" :max="100" :step="5" style="width: 100%;" />
                        </el-form-item>
                    </el-form>
                    <p style="color: var(--text-muted); font-size: 13px; margin-top: 12px;">
                        {{ t('setup.selectedFields', { count: setupConfig.selected_fields.length }) }}
                    </p>
                    <div style="margin-top: 24px; display: flex; justify-content: space-between;">
                        <el-button @click="setupStep = 2">{{ t('common.back') }}</el-button>
                        <el-button type="primary" @click="startInitialSync" :loading="initializing">
                            {{ t('setup.syncBtn') }}
                        </el-button>
                    </div>
                </div>

                <div v-if="setupStep === 4">
                    <transition name="fade" mode="out-in">
                        <h3 v-if="!initComplete" key="syncing" style="margin-bottom: 20px; text-align: center; color: var(--primary);">{{ t('setup.syncing') }}</h3>
                        <h3 v-else key="complete" style="margin-bottom: 20px; text-align: center; color: #67c23a;">{{ t('setup.syncComplete') }}</h3>
                    </transition>
                    <div v-if="!initComplete" style="text-align: center; margin-bottom: 20px; min-height: 22px;">
                        <transition name="message-fade" mode="out-in">
                            <span :key="waitingMessage" style="color: var(--text-muted); font-size: 14px;">{{ waitingMessage }}</span>
                        </transition>
                    </div>
                    <div v-if="initProgress > 0 && !initComplete" style="text-align: center; margin-bottom: 16px; color: var(--text-muted); font-size: 14px;">
                        {{ t('setup.processing', { current: initCurrentQuery, total: initTotalQueries }) }}
                    </div>
                    <el-progress v-if="initProgress > 0" :percentage="initProgress" :status="initComplete ? 'success' : ''" style="margin-bottom: 24px;" />
                </div>
            </div>
            
            <!-- Setup Language Switcher -->
            <el-button circle class="setup-lang-btn" @click="toggleLanguage">
                {{ currentLang === 'zh' ? 'EN' : '中' }}
            </el-button>
        </div>

        <div v-else class="app-container">
            <transition name="page-slide" mode="out-in">
                <div :key="currentPage">
                    <!-- Home Page -->
                    <div v-if="currentPage === 'home'" class="home-container">
                <div class="home-brand">
                    <h1>arXiv Pulse</h1>
                    <p>{{ t('home.subtitle') }}</p>
                </div>
                
                <div class="home-search-box">
                    <el-input 
                        v-model="homeQuery" 
                        :placeholder="t('home.searchPlaceholder')"
                        size="large"
                        @keyup.enter="startHomeSearch"
                        clearable
                    >
                        <template #prefix>
                            <el-icon><Search /></el-icon>
                        </template>
                    </el-input>
                </div>
                    
                    <div v-if="homeLogs.length > 0" class="logs-container" style="margin-top: 20px; max-height: 200px; max-width: 680px; width: 100%;">
                        <div v-for="(log, index) in homeLogs" :key="index" class="log-line" :class="log.type">
                            > {{ log.message }}
                        </div>
                    </div>
                    
                    <div v-if="homeResults.length > 0" style="margin-top: 24px; max-width: 680px; width: 100%;">
                        <paper-card 
                            v-for="paper in homeResults" 
                            :key="paper.id" 
                            :paper="paper"
                            :collections="collections"
                            :in-cart="isInCart(paper.arxiv_id)"
                            @add-to-collection="addToCollection"
                            @add-to-cart="addToCart"
                            @remove-from-cart="removeFromCartByArxivId"
                        />
                    </div>
                
                <div class="home-stats">
                    <span><el-icon><Document /></el-icon> {{ stats?.papers?.total || 0 }} {{ t('home.totalPapers') }}</span>
                    <span><el-icon><Collection /></el-icon> {{ stats?.collections?.total || 0 }} {{ t('home.totalCollections') }}</span>
                    <span><el-icon><Finished /></el-icon> {{ stats?.papers?.summarized || 0 }} {{ t('home.summarizedPapers') }}</span>
                </div>
                
                <div class="home-hints">
                    {{ t('home.hints') }}
                </div>
                
                <div class="home-footer">
                    <a href="https://github.com/kYangLi/arXiv-Pulse" target="_blank" class="github-link">
                        <svg class="github-icon" viewBox="0 0 24 24" width="18" height="18">
                            <path fill="currentColor" d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                        </svg>
                        GitHub
                    </a>
                </div>
            </div>
            
            <!-- Other Pages with Header -->
            <template v-else>
                <header class="header">
                    <div class="header-inner">
                        <div class="header-brand" style="cursor: pointer;" @click="navigateTo('home')">
                            <h1>arXiv Pulse</h1>
                            <p>{{ t('home.subtitle') }}</p>
                        </div>
                    </div>
                </header>

                <main class="main-content" style="padding-bottom: 100px;">
                    <!-- Recent Papers Page -->
                    <div v-if="currentPage === 'recent'" class="page-content">
                    <div class="search-options" style="margin-bottom: 20px;">
                        <div class="search-options-row">
                            <el-select v-model="recentDays" :placeholder="t('papers.timeRange')" style="width: 120px;">
                                <el-option v-for="item in daysOptions" :key="item.value" :label="item.label" :value="item.value" />
                            </el-select>
                            <el-tooltip 
                                :content="getSelectedFieldsTooltip()" 
                                placement="bottom"
                                :disabled="!hasSelectedFields()"
                            >
                                <el-button @click="openFieldSelector('recent')" plain>
                                    <el-icon><Operation /></el-icon> {{ t('papers.filterFields') }}
                                </el-button>
                            </el-tooltip>
                            <el-checkbox v-model="recentNeedSync">{{ t('papers.syncNewPapers') }}</el-checkbox>
                            <el-button type="primary" @click="updateRecentPapers" :loading="updatingRecent">
                                <el-icon><Refresh /></el-icon> {{ t('papers.update') }}
                            </el-button>
                        </div>
                    </div>

                    <div v-if="recentLogs.length > 0" class="logs-container" style="margin-bottom: 20px;">
                        <div v-for="(log, index) in recentLogs" :key="index" class="log-line">
                            > {{ log }}
                        </div>
                    </div>

                    <div v-if="loadingRecent" class="loading-state">
                        <el-icon class="is-loading" style="font-size: 32px;"><Loading /></el-icon>
                        <p v-if="loadingTotal > 0">{{ t('papers.aiReading') }} ({{ loadingProgress }}/{{ loadingTotal }})</p>
                        <p v-else>{{ t('papers.loading') }}</p>
                        <el-button v-if="loadingTotal > 0" size="small" @click="stopLoading" style="margin-top: 8px;">
                            {{ t('common.stop') }}
                        </el-button>
                    </div>
                    <div v-else-if="recentPapers.length > 0">
                        <paper-card 
                            v-for="paper in recentPapers" 
                            :key="paper.id" 
                            :paper="paper"
                            :collections="collections"
                            :in-cart="isInCart(paper.arxiv_id)"
                            @add-to-collection="addToCollection"
                            @add-to-cart="addToCart"
                            @remove-from-cart="removeFromCartByArxivId"
                        />
                    </div>
                    <div v-else class="empty-state">
                        <div class="icon"><el-icon><Document /></el-icon></div>
                        <h3>{{ t('papers.noPapers') }}</h3>
                        <p>{{ t('papers.noPapersHint') }}</p>
                    </div>
                </div>

            <!-- Sync Page -->
            <div v-else-if="currentPage === 'sync'" class="page-content">
                <div class="sync-status-grid">
                        <div class="sync-status-card">
                            <div class="label">{{ t('sync.status') }}</div>
                            <div class="value" :class="syncStatusClass">{{ syncStatusText }}</div>
                        </div>
                        <div class="sync-status-card">
                            <div class="label">{{ t('sync.lastSync') }}</div>
                            <div class="value" :class="syncTimeClass">{{ formatSyncTime }}</div>
                        </div>
                        <div class="sync-status-card">
                            <div class="label">{{ t('sync.researchFields') }}</div>
                            <div class="value">{{ fieldStats.filter(f => f.is_selected).length }}</div>
                        </div>
                        <div class="sync-status-card">
                            <div class="label">{{ t('sync.totalPapers') }}</div>
                            <div class="value">{{ stats?.papers?.total || 0 }}</div>
                        </div>
                    </div>

                    <div class="sync-options">
                        <h3>{{ t('sync.syncSettings') }}</h3>
                        <el-form label-position="top">
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
                                <el-form-item :label="t('sync.yearsBack')">
                                    <el-select v-model="syncYearsBack" style="width: 120px;">
                                        <el-option v-for="item in syncYearsBackOptions" :key="item.value" :label="item.label" :value="item.value" />
                                    </el-select>
                                </el-form-item>
                                <el-form-item :label="t('sync.forceSync')">
                                    <el-switch v-model="syncForce" />
                                </el-form-item>
                                <el-form-item label=" ">
                                    <el-button type="primary" @click="startSync" :loading="syncing">
                                        <el-icon><Refresh /></el-icon> {{ t('sync.startSync') }}
                                    </el-button>
                                </el-form-item>
                            </div>
                        </el-form>
                        <p style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">
                            {{ currentLang === 'zh' ? '同步年份覆盖默认设置。全局默认在左下角设置中配置。' : 'Sync years override default. Configure global defaults in Settings.' }}
                        </p>
                    </div>

                    <div v-if="syncLogs.length > 0" class="logs-container">
                        <div v-for="(log, index) in syncLogs" :key="index" class="log-line" :class="log.type">
                            > {{ log.message }}
                        </div>
                    </div>

                    <!-- Cache Management Section -->
                    <div class="cache-management">
                        <h3>{{ t('cache.title') }}</h3>
                        <div class="cache-grid">
                            <div class="cache-item">
                                <div class="cache-info">
                                    <span class="cache-label">{{ t('cache.translations') }}</span>
                                    <span class="cache-count">{{ cacheStats.translations }} {{ currentLang === 'zh' ? '条' : 'entries' }}</span>
                                </div>
                                <el-button size="small" @click="clearCache('translations')" :loading="cacheClearing === 'translations'">
                                    {{ t('cache.clear') }}
                                </el-button>
                            </div>
                            <div class="cache-item">
                                <div class="cache-info">
                                    <span class="cache-label">{{ t('cache.summaries') }}</span>
                                    <span class="cache-count">{{ cacheStats.summaries }} {{ currentLang === 'zh' ? '篇' : 'papers' }}</span>
                                </div>
                                <el-button size="small" @click="clearCache('summaries')" :loading="cacheClearing === 'summaries'">
                                    {{ t('cache.clear') }}
                                </el-button>
                            </div>
                            <div class="cache-item">
                                <div class="cache-info">
                                    <span class="cache-label">{{ t('cache.figures') }}</span>
                                    <span class="cache-count">{{ cacheStats.figures }} {{ currentLang === 'zh' ? '条' : 'entries' }}</span>
                                </div>
                                <el-button size="small" @click="clearCache('figures')" :loading="cacheClearing === 'figures'">
                                    {{ t('cache.clear') }}
                                </el-button>
                            </div>
                            <div class="cache-item">
                                <div class="cache-info">
                                    <span class="cache-label">{{ t('cache.contents') }}</span>
                                    <span class="cache-count">{{ cacheStats.contents }} {{ currentLang === 'zh' ? '条' : 'entries' }}</span>
                                </div>
                                <el-button size="small" @click="clearCache('contents')" :loading="cacheClearing === 'contents'">
                                    {{ t('cache.clear') }}
                                </el-button>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <el-button type="danger" plain @click="clearCache('all')" :loading="cacheClearing === 'all'">
                                <el-icon><Delete /></el-icon> {{ t('cache.clearAll') }}
                            </el-button>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-card">
                            <h3>{{ t('sync.yearDistribution') }}</h3>
                            <div id="yearChart" class="chart-container"></div>
                        </div>
                        <div class="chart-card">
                            <h3>热门研究领域</h3>
                            <div id="categoryChart" class="chart-container"></div>
                        </div>
                    </div>
                </div>

            <!-- Collections Page -->
            <div v-else-if="currentPage === 'collections'" class="page-content">
                <div class="collections-page-header">
                    <div class="collections-page-title">
                        <h2>{{ t('collections.title') }}</h2>
                        <div class="collections-stats">
                            <span><el-icon><Folder /></el-icon> {{ collections.length }} {{ t('collections.totalCollections') }}</span>
                            <span><el-icon><Document /></el-icon> {{ collections.reduce((sum, c) => sum + (c.paper_count || 0), 0) }} {{ t('collections.totalPapers') }}</span>
                        </div>
                    </div>
                    <div class="collections-toolbar">
                        <el-input 
                            v-model="collectionSearchQuery" 
                            :placeholder="t('collections.searchPlaceholder')"
                            clearable
                            class="collections-search"
                        >
                            <template #prefix>
                                <el-icon><Search /></el-icon>
                            </template>
                        </el-input>
                        <el-button type="primary" @click="showCreateCollection = true">
                            <el-icon><Plus /></el-icon> {{ t('collections.create') }}
                        </el-button>
                    </div>
                </div>

                <div v-if="filteredCollections.length > 0" class="collections-grid">
                    <div v-for="collection in filteredCollections" :key="collection.id" class="collection-card">
                        <div class="collection-card-main" @click="openCollectionDetail(collection)">
                            <div class="collection-card-header">
                                <div class="collection-card-title">
                                    <div class="collection-card-color" :style="{ background: collection.color || '#409EFF' }"></div>
                                    <h4>{{ collection.name }}</h4>
                                </div>
                                <el-dropdown trigger="click" class="collection-card-menu">
                                    <el-button text size="small" @click.stop>
                                        <el-icon><More /></el-icon>
                                    </el-button>
                                    <template #dropdown>
                                        <el-dropdown-menu>
                                            <el-dropdown-item @click.stop="editCollection(collection)">
                                                <el-icon><Edit /></el-icon> {{ t('common.edit') }}
                                            </el-dropdown-item>
                                            <el-dropdown-item @click.stop="duplicateCollection(collection)">
                                                <el-icon><Document /></el-icon> {{ t('collections.duplicate') }}
                                            </el-dropdown-item>
                                            <el-dropdown-item>
                                                <el-dropdown placement="right-start" trigger="hover" style="width: 100%;">
                                                    <span><el-icon><Promotion /></el-icon> {{ t('collections.mergePapers') }}<el-icon style="float: right;"><ArrowRight /></el-icon></span>
                                                    <template #dropdown>
                                                        <el-dropdown-menu>
                                                            <el-dropdown-item v-for="c in collections.filter(x => x.id !== collection.id)" :key="c.id" @click.stop="showMergeConfirm(collection, c)">
                                                                {{ c.name }}
                                                            </el-dropdown-item>
                                                            <el-dropdown-item v-if="collections.filter(x => x.id !== collection.id).length === 0" disabled>
                                                                {{ t('collections.noCollections') }}
                                                            </el-dropdown-item>
                                                        </el-dropdown-menu>
                                                    </template>
                                                </el-dropdown>
                                            </el-dropdown-item>
                                            <el-dropdown-item divided>
                                                <el-dropdown placement="right-start" trigger="hover" style="width: 100%;">
                                                    <span><el-icon><Download /></el-icon> {{ t('collections.export') }}<el-icon style="float: right;"><ArrowRight /></el-icon></span>
                                                    <template #dropdown>
                                                        <el-dropdown-menu>
                                                            <el-dropdown-item @click.stop="exportCollectionWithId(collection.id, 'markdown')">
                                                                Markdown (.md)
                                                            </el-dropdown-item>
                                                            <el-dropdown-item @click.stop="exportCollectionWithId(collection.id, 'pdf')">
                                                                {{ t('export.pdfDoc') }}
                                                            </el-dropdown-item>
                                                            <el-dropdown-item @click.stop="exportCollectionWithId(collection.id, 'csv')">
                                                                {{ t('export.csvTable') }}
                                                            </el-dropdown-item>
                                                            <el-dropdown-item @click.stop="exportCollectionWithId(collection.id, 'bibtex')">
                                                                BibTeX (.bib)
                                                            </el-dropdown-item>
                                                        </el-dropdown-menu>
                                                    </template>
                                                </el-dropdown>
                                            </el-dropdown-item>
                                            <el-dropdown-item divided @click.stop="confirmDeleteCollection(collection)">
                                                <el-icon><Delete /></el-icon> {{ t('common.delete') }}
                                            </el-dropdown-item>
                                        </el-dropdown-menu>
                                    </template>
                                </el-dropdown>
                            </div>
                            <p>{{ collection.description || t('collections.noDescription') }}</p>
                            <div class="collection-card-meta">
                                <span><el-icon><Document /></el-icon> {{ collection.paper_count || 0 }} {{ t('collections.papers') }}</span>
                            </div>
                            <div class="collection-card-time">
                                {{ t('collections.createdAt') }} {{ formatDate(collection.created_at) }} · 
                                {{ t('collections.updatedAt') }} {{ formatRelativeTime(collection.updated_at) }}
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else class="collection-empty">
                    <div class="collection-empty-icon"><el-icon><FolderOpened /></el-icon></div>
                    <h3>{{ t('collections.noCollections') }}</h3>
                    <p>{{ t('collections.createHint') }}</p>
                    <el-button type="primary" @click="showCreateCollection = true">
                        <el-icon><Plus /></el-icon> {{ t('collections.create') }}
                    </el-button>
                </div>
            </div>
                </main>
            </template>
        </div>
    </transition>
    
    <!-- Settings Drawer -->
            <el-drawer v-model="showSettings" :title="t('settings.title')" size="480px" class="settings-drawer">
                <div style="padding: 24px;">
                    <!-- UI Language -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 12px 16px; background: var(--bg-subtle); border-radius: 10px;">
                        <span>
                            <span :style="{ fontWeight: currentLang === 'zh' ? 600 : 400, opacity: currentLang === 'zh' ? 1 : 0.5 }">界面语言</span>
                            <span style="margin: 0 6px; opacity: 0.3;">/</span>
                            <span :style="{ fontWeight: currentLang === 'en' ? 600 : 400, opacity: currentLang === 'en' ? 1 : 0.5 }">UI Language</span>
                        </span>
                        <el-radio-group v-model="currentLang" size="small" @change="onLanguageChange">
                            <el-radio-button label="zh">中文</el-radio-button>
                            <el-radio-button label="en">EN</el-radio-button>
                        </el-radio-group>
                    </div>
                    
                    <div class="settings-section">
                        <h3>{{ t('settings.aiConfig') }}</h3>
                        <el-form label-position="top">
                            <el-form-item :label="t('settings.apiBaseUrl')">
                                <el-input v-model="settingsConfig.ai_base_url" />
                            </el-form-item>
                            <el-form-item :label="t('settings.apiKey')">
                                <el-input v-model="settingsConfig.ai_api_key" type="password" show-password>
                                    <template #append>
                                        <el-button type="primary" @click="saveApiKey" :loading="savingSettings">{{ t('settings.updateKey') }}</el-button>
                                    </template>
                                </el-input>
                            </el-form-item>
                            <el-form-item :label="t('settings.modelName')">
                                <el-input v-model="settingsConfig.ai_model" />
                            </el-form-item>
                            <el-form-item :label="t('settings.aiLanguage')">
                                <el-select v-model="settingsConfig.translate_language" style="width: 100%;">
                                    <el-option v-for="lang in aiLanguageOptions" :key="lang.value" :label="lang.label" :value="lang.value" />
                                </el-select>
                                <p style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">{{ t('settings.aiLanguageHint') }}</p>
                            </el-form-item>
                            <el-form-item>
                                <el-button @click="testAIConnection" :loading="testingAI">{{ t('settings.testConnection') }}</el-button>
                            </el-form-item>
                        </el-form>
                    </div>

                    <div class="settings-section">
                        <h3>{{ t('settings.researchFields') }}</h3>
                        <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 12px;">
                            {{ t('settings.fieldsHint') }}
                        </p>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-subtle); border-radius: 8px; cursor: pointer;" @click="openFieldSelector('settings')">
                            <span style="font-size: 13px; color: var(--text-primary);">
                                {{ currentLang === 'zh' ? '已选择' : 'Selected' }}: {{ settingsConfig.selected_fields?.length || 0 }} {{ currentLang === 'zh' ? '个领域' : 'fields' }}
                            </span>
                            <el-icon><ArrowRight /></el-icon>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>{{ t('settings.syncSettings') }}</h3>
                        <el-form label-position="top">
                            <el-form-item :label="t('settings.yearsBack')">
                                <el-select v-model="settingsConfig.years_back" style="width: 100%;">
                                    <el-option v-for="item in initYearOptions" :key="item.value" :label="item.label" :value="item.value" />
                                </el-select>
                            </el-form-item>
                            <el-form-item :label="t('settings.maxResultsPerField')">
                                <el-input-number v-model="settingsConfig.arxiv_max_results_per_field" :min="1000" :max="50000" :step="1000" style="width: 100%;" />
                            </el-form-item>
                            <el-form-item :label="t('settings.arxivMaxResults')">
                                <el-input-number v-model="settingsConfig.arxiv_max_results" :min="10000" :max="200000" :step="10000" style="width: 100%;" />
                            </el-form-item>
                            <el-form-item :label="t('settings.recentPapersLimit')">
                                <el-input-number v-model="settingsConfig.recent_papers_limit" :min="20" :max="200" :step="10" style="width: 100%;" />
                            </el-form-item>
                            <el-form-item :label="t('settings.searchLimit')">
                                <el-input-number v-model="settingsConfig.search_limit" :min="5" :max="100" :step="5" style="width: 100%;" />
                            </el-form-item>
                        </el-form>
                    </div>
                </div>
            </el-drawer>

            <!-- Dialogs -->
            <el-dialog v-model="showCreateCollection" :title="editingCollection ? t('collections.edit') : t('collections.create')" width="480px" @closed="cancelCollectionDialog">
                <el-form label-position="top">
                    <el-form-item :label="t('collections.name')">
                        <el-input v-model="newCollection.name" :placeholder="t('collections.name')" />
                    </el-form-item>
                    <el-form-item :label="t('collections.description')">
                        <el-input v-model="newCollection.description" type="textarea" rows="3" :placeholder="t('collections.description')" />
                    </el-form-item>
                    <el-form-item :label="t('collections.color')">
                        <el-color-picker v-model="newCollection.color" />
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="showCreateCollection = false">{{ t('common.cancel') }}</el-button>
                    <el-button type="primary" @click="saveCollection" :loading="savingCollection">{{ t('common.confirm') }}</el-button>
                </template>
            </el-dialog>

            <el-dialog v-model="showAddToCollection" :title="t('collections.addToCollection')" width="400px" @closed="selectedPaper = null">
                <p style="margin-bottom: 12px; color: var(--text-secondary);">
                    {{ t('collections.addPapersTo', { count: selectedPaper ? 1 : paperCart.length }) }}
                </p>
                <div v-if="selectedPaper?.collection_ids?.length > 0" style="margin-bottom: 12px; padding: 8px 12px; background: var(--bg-subtle); border-radius: 8px;">
                    <span style="color: var(--text-muted); font-size: 12px;">{{ t('collections.alreadyIn') }}: </span>
                    <el-tag v-for="cid in selectedPaper.collection_ids" :key="cid" size="small" style="margin: 2px;">
                        {{ collections.find(c => c.id === cid)?.name || '#' + cid }}
                    </el-tag>
                </div>
                <el-select v-model="selectedCollectionId" :placeholder="t('collections.selectPlaceholder')" style="width: 100%;">
                    <el-option v-for="c in collections" :key="c.id" :label="c.name" :value="c.id" />
                </el-select>
                <template #footer>
                    <el-button @click="showAddToCollection = false">{{ t('common.cancel') }}</el-button>
                    <el-button type="primary" @click="confirmAddToCollection" :loading="addingToCollection">{{ t('common.add') }}</el-button>
                </template>
            </el-dialog>

            <el-dialog v-model="showCollectionDetail" width="800px">
                <template #header>
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <div>
                            <span style="font-size: 18px; font-weight: 600;">{{ viewingCollection?.name }}</span>
                            <div v-if="viewingCollection" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                {{ collectionTotalCount }} {{ t('collections.papers') }} · {{ t('collections.lastAdded') }}: {{ formatRelativeTime(viewingCollection.updated_at) }}
                            </div>
                        </div>
                    </div>
                </template>
                <div v-if="loadingCollectionPapers" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading" style="font-size: 32px;"><Loading /></el-icon>
                    <p v-if="aiSearching" style="color: var(--text-secondary); margin-top: 12px;">{{ t('collections.aiSearching') }}</p>
                </div>
                <div v-else>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-light); flex-wrap: wrap; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <el-input 
                                v-model="collectionPaperSearch" 
                                :placeholder="useAiSearch ? t('collections.aiSearchPlaceholder') : t('collections.searchPapers')" 
                                clearable 
                                style="width: 280px;" 
                                @keyup.enter="performSearch" 
                                @clear="performSearch"
                                :disabled="aiSearching"
                            >
                                <template #prefix><el-icon><Search /></el-icon></template>
                            </el-input>
                            <el-checkbox v-model="useAiSearch" :disabled="aiSearching">{{ t('collections.aiSearch') }}</el-checkbox>
                            <el-divider direction="vertical"></el-divider>
                            <el-radio-group v-model="collectionSortBy" size="small" @change="performSearch">
                                <el-radio-button value="published">
                                    <el-icon><Calendar /></el-icon>
                                    <span style="margin-left: 4px;">{{ t('collections.sortPublished') }}</span>
                                </el-radio-button>
                                <el-radio-button value="added_at">
                                    <el-icon><Clock /></el-icon>
                                    <span style="margin-left: 4px;">{{ t('collections.sortAdded') }}</span>
                                </el-radio-button>
                            </el-radio-group>
                            <el-button size="small" @click="toggleSortOrder">
                                <el-icon>
                                    <component :is="collectionSortOrder === 'desc' ? 'SortDown' : 'SortUp'" />
                                </el-icon>
                            </el-button>
                            <el-divider direction="vertical"></el-divider>
                            <el-button-group size="small">
                                <el-button :type="collectionViewMode === 'card' ? 'primary' : ''" @click="collectionViewMode = 'card'">
                                    <el-icon><Grid /></el-icon>
                                </el-button>
                                <el-button :type="collectionViewMode === 'list' ? 'primary' : ''" @click="collectionViewMode = 'list'">
                                    <el-icon><List /></el-icon>
                                </el-button>
                            </el-button-group>
                        </div>
                    </div>
                    <div v-if="collectionPapers.length > 0">
                        <template v-if="collectionViewMode === 'card'">
                            <paper-card 
                                v-for="paper in collectionPapers" 
                                :key="paper.id" 
                                :paper="paper"
                                :collections="collections"
                                :in-collection="true"
                                :in-cart="isInCart(paper.arxiv_id)"
                                @add-to-collection="addToCollection"
                                @remove-from-collection="removePaperFromCollection"
                                @add-to-cart="addToCart"
                                @remove-from-cart="removeFromCartByArxivId"
                            />
                        </template>
                        <template v-else>
                            <div v-for="paper in collectionPapers" :key="paper.id" class="collection-list-item" @click="openPaperUrl(paper.arxiv_url)">
                                <div class="list-item-title">{{ paper.title }}</div>
                                <div class="list-item-meta">
                                    <span>{{ paper.authors?.map(a => a.name).slice(0, 3).join(', ') }}{{ paper.authors?.length > 3 ? '...' : '' }}</span>
                                    <span>·</span>
                                    <span>{{ paper.published?.slice(0, 10) }}</span>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div v-else class="empty-state">
                        <p v-if="useAiSearch">{{ t('collections.aiNoResult') }}</p>
                        <p v-else-if="collectionPaperSearch">{{ t('collections.noSearchResult') }}</p>
                        <p v-else>{{ t('collections.noPapersInCollection') }}</p>
                    </div>
                    <div v-if="collectionTotalPages > 1 && !useAiSearch" style="display: flex; justify-content: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-light);">
                        <el-pagination
                            v-model:current-page="collectionCurrentPage"
                            :page-size="20"
                            :total="collectionTotalCount"
                            layout="prev, pager, next"
                            @current-change="loadCollectionPage"
                        />
                    </div>
                </div>
            </el-dialog>

            <el-dialog v-model="showDeleteConfirm" :title="t('common.confirmDelete')" width="400px">
                <p>{{ t('collections.deleteConfirm', { name: deletingCollection?.name }) }}</p>
                <template #footer>
                    <el-button @click="showDeleteConfirm = false">{{ t('common.cancel') }}</el-button>
                    <el-button type="danger" @click="deleteCollection" :loading="deletingCollectionInProgress">{{ t('common.delete') }}</el-button>
                </template>
            </el-dialog>

            <el-dialog v-model="showMergeConfirmDialog" :title="t('collections.mergePapers')" width="400px">
                <p>{{ t('collections.mergeConfirm', { count: mergingFromCollection?.paper_count || 0, name: mergingToCollection?.name }) }}</p>
                <template #footer>
                    <el-button @click="showMergeConfirmDialog = false">{{ t('common.cancel') }}</el-button>
                    <el-button type="primary" @click="mergePapers" :loading="mergingInProgress">{{ t('common.confirm') }}</el-button>
                </template>
            </el-dialog>
        </div>

        <!-- Field Selector Dialog (Global - accessible from setup and main app) -->
        <el-dialog 
            v-model="showFieldSelector" 
            width="800px" 
            :close-on-click-modal="false"
            append-to-body
        >
            <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                <div style="font-size: 14px; font-weight: 500; color: var(--text-primary);">
                    {{ t('fields.selectFields') }}
                </div>
                <el-tooltip :content="fieldAdvancedMode ? t('fields.switchToVisual') : t('fields.switchToCode')" placement="top">
                    <el-button 
                        :type="fieldAdvancedMode ? 'primary' : 'default'" 
                        size="small" 
                        @click="fieldAdvancedMode = !fieldAdvancedMode"
                        style="display: flex; align-items: center; gap: 4px;"
                    >
                        <el-icon style="font-size: 14px;"><Document /></el-icon>
                        <span style="font-size: 12px;">{{ fieldAdvancedMode ? t('fields.visualMode') : t('fields.codeMode') }}</span>
                    </el-button>
                </el-tooltip>
            </div>
            
            <div class="field-selector">
                <div class="field-selector-left">
                    <template v-if="fieldAdvancedMode">
                        <div style="flex: 1; display: flex; flex-direction: column; background: #1e1e1e; border-radius: 8px 0 0 8px; overflow: hidden;">
                            <el-input
                                v-model="advancedQueriesText"
                                type="textarea"
                                :placeholder="t('fields.advancedPlaceholder')"
                                style="flex: 1; --el-input-bg-color: #1e1e1e; --el-input-text-color: #d4d4d4; --el-input-border-color: #3c3c3c; --el-input-placeholder-color: #6a6a6a;"
                                input-style="font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 13px; line-height: 1.6; background: #1e1e1e; color: #d4d4d4; height: 100%;"
                            />
                            <div style="padding: 8px 12px; background: #252526; font-size: 11px; color: #8a8a8a; display: flex; justify-content: space-between;">
                                <span>{{ advancedQueriesLines.length }} {{ currentLang === 'zh' ? '条查询' : 'queries' }}</span>
                                <span style="color: #6a6a6a;">arXiv API</span>
                            </div>
                        </div>
                    </template>
                    <template v-else>
                        <div class="field-selector-search">
                            <el-input v-model="fieldSearchQuery" :placeholder="t('fields.searchPlaceholder')" clearable>
                                <template #prefix>
                                    <el-icon><Search /></el-icon>
                                </template>
                            </el-input>
                        </div>
                        <div class="field-selector-tree">
                            <template v-for="(group, groupKey) in filteredCategories" :key="groupKey">
                                <div class="field-group">
                                    <div class="field-group-header" :class="{ expanded: fieldSelectorExpanded[groupKey] }" @click="toggleFieldSelectorGroup(groupKey)">
                                        <el-icon><ArrowRight /></el-icon>
                                        <span>{{ currentLang === 'zh' ? group.name : group.name_en }}</span>
                                        <span v-if="group.recommended" class="recommended-badge">{{ t('fields.recommended') }}</span>
                                    </div>
                                    <div v-show="fieldSelectorExpanded[groupKey]" class="field-group-children">
                                        <template v-for="(cat, catKey) in group.children" :key="catKey">
                                            <div v-if="cat.children" class="field-group">
                                                <div class="field-group-header" :class="{ expanded: fieldSelectorExpanded[catKey] }" @click.stop="toggleFieldSelectorGroup(catKey)">
                                                    <el-icon><ArrowRight /></el-icon>
                                                    <span>{{ currentLang === 'zh' ? cat.name : cat.name_en }}</span>
                                                </div>
                                                <div v-show="fieldSelectorExpanded[catKey]" class="field-group-children">
                                                    <div v-for="(subcat, subcatKey) in cat.children" :key="subcatKey"
                                                         class="field-item"
                                                         :class="{ selected: tempSelectedFields.includes(subcat.id) }"
                                                         @click="toggleTempField(subcat.id)">
                                                        <el-checkbox :model-value="tempSelectedFields.includes(subcat.id)" />
                                                        <span v-if="subcat.recommended" class="star">⭐</span>
                                                        <span>{{ currentLang === 'zh' ? subcat.name : subcat.name_en }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-else
                                                 class="field-item"
                                                 :class="{ selected: tempSelectedFields.includes(cat.id) }"
                                                 @click="toggleTempField(cat.id)">
                                                <el-checkbox :model-value="tempSelectedFields.includes(cat.id)" />
                                                <span v-if="cat.recommended" class="star">⭐</span>
                                                <span>{{ currentLang === 'zh' ? cat.name : cat.name_en }}</span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                <div class="field-selector-right">
                    <div class="field-selector-header">
                        <span>{{ currentLang === 'zh' ? '已选择' : 'Selected' }}</span>
                        <span class="toggle-btn" v-if="!fieldAdvancedMode && tempSelectedFields.length > 0" @click="clearTempSelection">{{ currentLang === 'zh' ? '清空' : 'Clear' }}</span>
                    </div>
                    <div class="field-selector-list">
                        <template v-if="!fieldAdvancedMode">
                            <div v-if="tempSelectedFields.length === 0" class="field-selector-empty">
                                {{ currentLang === 'zh' ? '点击左侧领域添加' : 'Click fields to add' }}
                            </div>
                            <div v-for="fieldId in tempSelectedFields" :key="fieldId" class="field-selected-item">
                                <div class="name">
                                    <span v-if="allCategories[fieldId]?.recommended" class="star">⭐</span>
                                    <span>{{ currentLang === 'zh' ? allCategories[fieldId]?.name : allCategories[fieldId]?.name_en }}</span>
                                    <span style="color: var(--text-muted); font-size: 11px; margin-left: 4px;">{{ fieldId }}</span>
                                </div>
                                <div class="remove-btn" @click="removeFromTempSelection(fieldId)">
                                    <el-icon><Close /></el-icon>
                                </div>
                            </div>
                        </template>
                        <template v-else>
                            <div v-if="advancedQueriesLines.length === 0" class="field-selector-empty">
                                {{ currentLang === 'zh' ? '在左侧输入查询语句' : 'Enter queries on the left' }}
                            </div>
                            <template v-else>
                                <div v-if="parsedCodeResult.standardFields.length > 0" style="margin-bottom: 8px;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">{{ currentLang === 'zh' ? '标准分类' : 'Standard' }}</div>
                                    <div v-for="fieldId in parsedCodeResult.standardFields" :key="fieldId" class="field-selected-item" style="background: #e8f4ff;">
                                        <div class="name">
                                            <span v-if="allCategories[fieldId]?.recommended" class="star">⭐</span>
                                            <span style="color: var(--primary);">{{ currentLang === 'zh' ? allCategories[fieldId]?.name : allCategories[fieldId]?.name_en }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="parsedCodeResult.customQueries.length > 0">
                                    <div style="font-size: 11px; color: #e6a23c; margin-bottom: 4px;">{{ currentLang === 'zh' ? '自定义规则' : 'Custom' }}</div>
                                    <div v-for="(query, idx) in parsedCodeResult.customQueries" :key="idx" class="field-selected-item" style="background: #fdf6ec; border-color: #e6a23c;">
                                        <div class="name" style="font-family: 'SF Mono', Monaco, monospace; font-size: 11px; color: #e6a23c;">
                                            {{ query }}
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </div>
                    <div class="field-selector-footer">
                        <span class="count">
                            <template v-if="!fieldAdvancedMode">
                                {{ tempSelectedFields.length }} {{ currentLang === 'zh' ? '个领域' : 'fields' }}
                            </template>
                            <template v-else>
                                {{ advancedQueriesLines.length }} {{ currentLang === 'zh' ? '条查询' : 'queries' }}
                                <span v-if="parsedCodeResult.customQueries.length > 0" style="color: #e6a23c;"> ({{ parsedCodeResult.customQueries.length }} {{ currentLang === 'zh' ? '自定义' : 'custom' }})</span>
                            </template>
                        </span>
                    </div>
                </div>
            </div>
            <template #footer>
                <el-button @click="showFieldSelector = false">{{ t('common.cancel') }}</el-button>
                <el-button type="primary" @click="confirmFieldSelection">{{ t('common.confirm') }}</el-button>
            </template>
        </el-dialog>

        <!-- Bottom Navigation Bar -->
        <div v-if="!showSetup" class="bottom-nav" @mouseenter="(e) => e.currentTarget.style.cursor='default'">
            <div class="nav-items-wrapper">
                <div class="nav-item" :class="{ active: currentPage === 'home' }" @click="navigateTo('home')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                    <span>{{ t('nav.home') }}</span>
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'recent' }" @click="navigateTo('recent')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    <span>{{ t('nav.recent') }}</span>
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'sync' }" @click="navigateTo('sync')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                    </svg>
                    <span>{{ t('nav.data') }}</span>
                </div>
                <div class="nav-item" :class="{ active: currentPage === 'collections' }" @click="navigateTo('collections')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                    </svg>
                    <span>{{ t('nav.collections') }}</span>
                </div>
            </div>
        </div>

        <!-- Paper Basket Panel -->
        <transition name="panel">
            <div v-if="!showSetup && showCart" 
                 class="cart-panel" 
                 ref="cartPanelRef"
                 :style="{ position: 'fixed', left: cartPosition.x + 'px', top: cartPosition.y + 'px', zIndex: cartZIndex }"
                 @mousedown="startDragCart"
                 @click="bringToFront('cart')">
                <div class="cart-header">
                    <h3>
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                        </svg>
                        {{ t('basket.title') }}
                        <span v-if="paperCart.length > 0" style="opacity: 0.7; font-weight: 400;">({{ paperCart.length }})</span>
                    </h3>
                    <div class="collapse-btn" @click.stop="showCart = false" :title="currentLang === 'zh' ? '收起' : 'Collapse'">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/>
                        </svg>
                    </div>
                </div>
                <div class="cart-body">
                    <div v-if="paperCart.length === 0" class="cart-empty">
                        <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor" style="opacity: 0.5;">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                        <p style="margin-top: 12px; color: var(--text-muted);">{{ t('basket.empty') }}</p>
                        <p style="font-size: 12px; color: var(--text-muted);">{{ t('basket.emptyHint') }}</p>
                    </div>
                    <div v-for="(paper, index) in paperCart" :key="paper.arxiv_id" class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-title">{{ paper.title }}</div>
                            <div class="cart-item-meta">{{ paper.arxiv_id }} · {{ formatDate(paper.published) }}</div>
                        </div>
                        <div class="cart-item-actions">
                            <el-button text size="small" @click="removeFromCart(index)" :title="t('common.delete')">
                                <el-icon><Delete /></el-icon>
                            </el-button>
                        </div>
                    </div>
                </div>
                <div v-if="paperCart.length > 0" class="cart-footer">
                    <div class="cart-actions">
                        <el-dropdown @command="exportCart" placement="top">
                            <el-button type="primary" plain>
                                <el-icon><Download /></el-icon> {{ t('basket.export') }}
                            </el-button>
                            <template #dropdown>
                                <el-dropdown-menu>
                                    <el-dropdown-item command="markdown">Markdown</el-dropdown-item>
                                    <el-dropdown-item command="pdf">PDF</el-dropdown-item>
                                    <el-dropdown-item command="pdf_original">PDF (Original)</el-dropdown-item>
                                    <el-dropdown-item command="csv">CSV</el-dropdown-item>
                                    <el-dropdown-item command="bibtex">BibTeX</el-dropdown-item>
                                </el-dropdown-menu>
                            </template>
                        </el-dropdown>
                        <el-button @click="addCartToCollection" plain>
                            <el-icon><Folder /></el-icon> {{ t('basket.addToCollection') }}
                        </el-button>
                        <el-button @click="copyCartLinks" type="info" plain>
                            <el-icon><Tickets /></el-icon> {{ t('basket.copyLinks') }}
                        </el-button>
                        <el-button @click="clearCart" type="danger" plain>
                            <el-icon><Delete /></el-icon> {{ t('basket.clear') }}
                        </el-button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Floating Buttons Left (Language + Settings) -->
        <div v-if="!showSetup" class="floating-buttons-left">
            <el-button circle class="lang-btn" @click="toggleLanguage">
                {{ currentLang === 'zh' ? 'EN' : '中' }}
            </el-button>
            <el-button circle class="settings-btn" @click="showSettings = true">
                <el-icon><Setting /></el-icon>
            </el-button>
        </div>

        <!-- Floating Buttons Right (Cart + Chat) -->
        <div v-if="!showSetup" class="floating-buttons-right">
            <el-badge :value="paperCart.length" :hidden="paperCart.length === 0" :max="9">
                <el-button circle class="cart-fab-btn" @click="showCart = !showCart">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                </el-button>
            </el-badge>
            <el-badge :value="chatUnreadCount" :hidden="chatUnreadCount === 0" :max="9">
                <el-button circle class="chat-fab-btn" @click="toggleChat">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                    </svg>
                </el-button>
            </el-badge>
        </div>

        <!-- AI Chat Window -->
        <transition name="panel">
            <div v-if="!showSetup && chatExpanded" 
                 class="chat-window" 
                 :class="{ fullscreen: chatFullscreen, 'animate-fullscreen': chatAnimating }"
                 ref="chatPanelRef"
                 :style="chatFullscreen ? { zIndex: chatZIndex } : { position: 'fixed', left: chatPosition.x + 'px', top: chatPosition.y + 'px', width: chatSize.width + 'px', height: chatSize.height + 'px', zIndex: chatZIndex }"
                 @mousedown="startDragChat"
                 @click="bringToFront('chat')">
                <div class="chat-header">
                    <span class="chat-title">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                        </svg>
                        {{ t('chat.title') }}
                    </span>
                     <div class="chat-header-actions">
                         <el-button text @click.stop="createNewChat" :title="t('chat.newChat')">
                             <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                 <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                             </svg>
                         </el-button>
                         <el-button text @click.stop="toggleChatFullscreen" :title="chatFullscreen ? (currentLang === 'zh' ? '还原' : 'Restore') : (currentLang === 'zh' ? '全屏' : 'Fullscreen')">
                             <svg v-if="chatFullscreen" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                 <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
                             </svg>
                             <svg v-else viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                 <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                             </svg>
                         </el-button>
                         <div class="collapse-btn" @click.stop="chatExpanded = false" :title="currentLang === 'zh' ? '收起' : 'Collapse'">
                             <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                 <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/>
                             </svg>
                         </div>
                     </div>
                 </div>
                 
                 <div class="chat-body">
                    <transition name="sidebar-slide">
                        <div v-if="showChatSidebar" class="chat-sidebar">
                            <div class="chat-sidebar-header">
                                <span>{{ t('chat.history') }}</span>
                                <div class="sidebar-header-actions">
                                    <el-button 
                                        v-if="chatSessions.length > 0"
                                        text 
                                        size="small" 
                                        @click="clearAllChatSessions"
                                        :title="t('chat.clearAll')"
                                        class="clear-all-btn"
                                    >
                                        <el-icon><Delete /></el-icon>
                                    </el-button>
                                    <el-button text size="small" @click="showChatSidebar = false">
                                        <el-icon><ArrowLeft /></el-icon>
                                    </el-button>
                                </div>
                            </div>
                            <div class="chat-session-list">
                                <div 
                                    v-for="session in chatSessions" 
                                    :key="session.id" 
                                    class="chat-session-item"
                                    :class="{ active: currentChatSession?.id === session.id }"
                                >
                                    <div class="session-info" @click="selectChatSession(session)">
                                        <div class="session-title">{{ session.title }}</div>
                                        <div class="session-time">{{ formatChatTime(session.updated_at) }}</div>
                                    </div>
                                    <el-button 
                                        class="session-delete" 
                                        text 
                                        size="small" 
                                        @click.stop="deleteChatSession(session)"
                                        :title="t('common.delete')"
                                    >
                                        <el-icon><Delete /></el-icon>
                                    </el-button>
                                </div>
                                <div v-if="chatSessions.length === 0" class="no-sessions">
                                    {{ t('chat.noSession') }}
                                </div>
                            </div>
                        </div>
                    </transition>
                    <div v-if="showChatSidebar" class="sidebar-overlay" @click="showChatSidebar = false"></div>
                    
                    <div class="chat-main" @click="showChatSidebar = false">
                        <div class="chat-messages" ref="chatMessagesContainer" @scroll="handleChatScroll">
                            <div v-if="chatMessages.length === 0" class="chat-welcome">
                                <div class="welcome-icon">
                                    <span class="welcome-omega">Ω</span>
                                </div>
                                <h3>{{ t('chat.title') }}</h3>
                                <p>{{ t('chat.welcome') }}</p>
                                <div class="quick-prompts">
                                    <div 
                                        v-for="(prompt, idx) in quickPrompts" 
                                        :key="idx" 
                                        class="quick-prompt-btn"
                                        @click="sendQuickPrompt(prompt.text)"
                                    >
                                        <span class="prompt-icon">{{ prompt.icon }}</span>
                                        <span class="prompt-text">{{ prompt.text }}</span>
                                    </div>
                                </div>
                            </div>
                            <div v-for="(msg, idx) in chatMessages" :key="msg.id" class="chat-message" :class="msg.role">
                                <div v-if="msg.role === 'assistant'" class="message-avatar assistant">
                                    <span class="omega-symbol">Ω</span>
                                </div>
                                <div class="message-content">
                                    <div v-if="msg.paper_ids?.length" class="message-papers">
                                        <el-tag v-for="pid in msg.paper_ids" :key="pid" size="small" type="info">{{ pid }}</el-tag>
                                    </div>
                                    <template v-if="msg.role === 'assistant' && msg.isStreaming">
                                        <div v-if="chatProgress" class="chat-progress">
                                            <div class="progress-header">
                                                <el-icon class="is-loading"><Loading /></el-icon>
                                                <span class="progress-message">{{ chatProgress.message }}</span>
                                            </div>
                                            <div v-if="chatProgress.progress" class="progress-bar-container">
                                                <div class="progress-bar" :style="{ width: chatProgress.progress + '%' }"></div>
                                            </div>
                                            <div v-if="chatProgress.textLength || chatProgress.pageCount" class="progress-details">
                                                <span v-if="chatProgress.textLength">{{ chatProgress.textLength.toLocaleString() }} 字符</span>
                                                <span v-if="chatProgress.pageCount">{{ chatProgress.pageCount }} 页</span>
                                            </div>
                                        </div>
                                        <div v-else class="message-text streaming">
                                            <span v-html="formatChatMessage(msg.content, true)"></span>
                                            <span class="streaming-cursor"></span>
                                        </div>
                                    </template>
                                    <div v-else class="message-text" v-html="formatChatMessage(msg.content)"></div>
                                </div>
                                <div v-if="msg.role === 'user'" class="message-avatar user">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div v-if="selectedChatPapers.length > 0" class="selected-papers-bar">
                            <span>{{ t('chat.selectedPapers', { count: selectedChatPapers.length }) }}</span>
                            <el-tag 
                                v-for="paper in selectedChatPapers" 
                                :key="paper.arxiv_id" 
                                closable 
                                size="small"
                                @close="removeSelectedChatPaper(paper.arxiv_id)"
                            >
                                {{ paper.title?.slice(0, 20) }}...
                            </el-tag>
                        </div>
                        
                        <div class="chat-input-area">
                            <el-button text @click.stop="showChatSidebar = !showChatSidebar" :title="t('chat.history')" class="history-btn">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                                </svg>
                            </el-button>
                            <el-input
                                v-model="chatInput"
                                type="textarea"
                                :autosize="{ minRows: 1, maxRows: 4 }"
                                :placeholder="t('chat.inputPlaceholder')"
                                @keydown.enter.exact.prevent="sendChatMessage"
                                :disabled="chatTyping"
                                resize="none"
                            />
                            <el-button type="primary" @click="sendChatMessage" :loading="chatTyping" :disabled="!chatInput.trim()" class="send-btn">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </el-button>
                        </div>
                    </div>
                    <div v-if="!chatFullscreen" class="chat-resize-handle right" @mousedown.stop="startResizeChat('right', $event)"></div>
                    <div v-if="!chatFullscreen" class="chat-resize-handle bottom" @mousedown.stop="startResizeChat('bottom', $event)"></div>
                    <div v-if="!chatFullscreen" class="chat-resize-handle left" @mousedown.stop="startResizeChat('left', $event)"></div>
                    <div v-if="!chatFullscreen" class="chat-resize-handle top" @mousedown.stop="startResizeChat('top', $event)"></div>
                    <div v-if="!chatFullscreen" class="chat-resize-handle corner top-left" @mousedown.stop="startResizeChat('top-left', $event)"></div>
                    <div v-if="!chatFullscreen" class="chat-resize-handle corner top-right" @mousedown.stop="startResizeChat('top-right', $event)"></div>
                    <div v-if="!chatFullscreen" class="chat-resize-handle corner bottom-left" @mousedown.stop="startResizeChat('bottom-left', $event)"></div>
                    <div v-if="!chatFullscreen" class="chat-resize-handle corner bottom-right" @mousedown.stop="startResizeChat('bottom-right', $event)"></div>
                </div>
            </div>
        </transition>
    </div>

    <script src="libs/vue/vue.global.prod.js"></script>
    <script>
        // Expose Vue reactivity APIs globally for Pinia stores
        var ref = Vue.ref;
        var computed = Vue.computed;
        var reactive = Vue.reactive;
        var watch = Vue.watch;
        var watchEffect = Vue.watchEffect;
        var onMounted = Vue.onMounted;
        var onUnmounted = Vue.onUnmounted;
        var nextTick = Vue.nextTick;
        var toRef = Vue.toRef;
        var toRefs = Vue.toRefs;
        var unref = Vue.unref;
        var isRef = Vue.isRef;
        
        // VueDemi shim for Vue 3 - exposes all Vue reactivity APIs Pinia needs
        var VueDemi = (function() {
            var Vue = window.Vue;
            if (!Vue) {
                console.error('Vue is not loaded');
                throw new Error('Vue is not loaded');
            }
            var exports = {
                ref: Vue.ref,
                computed: Vue.computed,
                watch: Vue.watch,
                watchEffect: Vue.watchEffect,
                watchPostEffect: Vue.watchPostEffect,
                watchSyncEffect: Vue.watchSyncEffect,
                effectScope: Vue.effectScope,
                onScopeDispose: Vue.onScopeDispose,
                getCurrentScope: Vue.getCurrentScope,
                onMounted: Vue.onMounted,
                onUnmounted: Vue.onUnmounted,
                onBeforeUnmount: Vue.onBeforeUnmount,
                provide: Vue.provide,
                inject: Vue.inject,
                reactive: Vue.reactive,
                readonly: Vue.readonly,
                shallowReactive: Vue.shallowReactive,
                shallowReadonly: Vue.shallowReadonly,
                toRaw: Vue.toRaw,
                toRefs: Vue.toRefs,
                toRef: Vue.toRef,
                isRef: Vue.isRef,
                unref: Vue.unref,
                isReactive: Vue.isReactive,
                isReadonly: Vue.isReadonly,
                isShallow: Vue.isShallow,
                markRaw: Vue.markRaw,
                nextTick: Vue.nextTick,
                defineComponent: Vue.defineComponent,
                getCurrentInstance: Vue.getCurrentInstance,
                version: Vue.version || '3',
                set: function(target, key, value) { target[key] = value; },
                del: function(target, key) { delete target[key]; }
            };
            exports.Vue = Vue;
            return exports;
        })();
    </script>
    <script src="libs/pinia/pinia.iife.js"></script>
    <script>
        // Expose Pinia's defineStore globally for stores
        var defineStore = Pinia.defineStore;
    </script>
    <script src="libs/element-plus/index.full.js"></script>
    <script src="libs/element-plus/icons.iife.min.js"></script>
    <script src="libs/echarts/echarts.min.js"></script>
    <script src="libs/marked/marked.min.js"></script>
    <script src="js/i18n/zh.js"></script>
    <script src="js/i18n/en.js"></script>
    <script src="js/services/api.js"></script>
    <script src="js/utils/export.js"></script>
    <script src="js/stores/configStore.js"></script>
    <script src="js/stores/paperStore.js"></script>
    <script src="js/stores/collectionStore.js"></script>
    <script src="js/stores/chatStore.js"></script>
    <script src="js/stores/uiStore.js"></script>
    <script src="js/components/PaperCard.js"></script>
    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        const { createPinia, storeToRefs } = Pinia;
        
        const i18n = { zh: i18nZh, en: i18nEn };

        const app = createApp({
            setup() {
                const configStore = useConfigStore();
                const paperStore = usePaperStore();
                const collectionStore = useCollectionStore();
                const chatStore = useChatStore();
                const uiStore = useUiStore();
                
                // configStore properties
                const {
                    showSetup, setupStep, testingAI, setupConfig,
                    showSettings, savingSettings, settingsConfig,
                    arxivCategories, allCategories, currentLang,
                    showFieldSelector, fieldSelectorSource, tempSelectedFields,
                    fieldSearchQuery, fieldSelectorExpanded, recentCategories,
                    fieldAdvancedMode, advancedQueriesText,
                    filteredCategories, advancedQueriesLines, parsedCodeResult
                } = storeToRefs(configStore);
                
                const initializing = ref(false);
                const initLogs = ref([]);
                const initProgress = ref(0);
                const initCurrentQuery = ref(0);
                const initTotalQueries = ref(0);
                const initComplete = ref(false);
                
                const waitingMessages = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return isZh ? [
                        '正在从 arXiv 获取论文...',
                        '首次同步可能需要几分钟...',
                        '正在处理论文数据...',
                        'arXiv 服务器响应中...',
                        '马上就好了...',
                        '正在建立索引...'
                    ] : [
                        'Fetching papers from arXiv...',
                        'First sync may take a few minutes...',
                        'Processing paper data...',
                        'arXiv server responding...',
                        'Almost done...',
                        'Building index...'
                    ];
                });
                const waitingMessage = ref('');
                let waitingTimer = null;

                // uiStore properties
                const { currentPage, expandedGroups, cacheStats, cacheClearing, syncing, syncLogs, syncYearsBack, syncForce, syncStatus } = storeToRefs(uiStore);
                
                // paperStore properties
                const { 
                    stats, fieldStats, recentPapers, loadingRecent, loadingProgress, loadingTotal, loadingController,
                    updatingRecent, recentLogs, recentDays, recentNeedSync,
                    homeQuery, homeSearching, homeLogs, homeResults, homeSelectedIds,
                    paperCart, showCart, cartExportLoading, cartPosition, cartPanelRef, cartZIndex
                } = storeToRefs(paperStore);
                
                // chatStore properties
                const {
                    chatExpanded, chatSessions, currentChatSession, chatMessages, chatInput,
                    selectedChatPapers, chatTyping, chatProgress, showChatSidebar,
                    chatUnreadCount, chatMessagesContainer, userScrolledUp, chatPosition, chatPanelRef, chatZIndex,
                    chatFullscreen, chatSize, chatAnimating
                } = storeToRefs(chatStore);

                const quickPrompts = computed(() => currentLang.value === 'zh' ? [
                    { icon: '📝', text: '帮我总结这篇论文的核心内容' },
                    { icon: '🔍', text: '解释论文中的方法论' },
                    { icon: '💡', text: '这个领域有哪些最新进展' },
                    { icon: '⚖️', text: '比较这些论文的异同' },
                ] : [
                    { icon: '📝', text: 'Summarize the core content of this paper' },
                    { icon: '🔍', text: 'Explain the methodology in this paper' },
                    { icon: '💡', text: 'What are the latest advances in this field' },
                    { icon: '⚖️', text: 'Compare the similarities and differences' },
                ]);

                function bringToFront(panel) {
                    if (panel === 'cart') {
                        cartZIndex.value = Math.max(cartZIndex.value, chatZIndex.value) + 1;
                    } else if (panel === 'chat') {
                        chatZIndex.value = Math.max(cartZIndex.value, chatZIndex.value) + 1;
                    }
                }

                function handleEscKey(e) {
                    if (e.key === 'Escape') {
                        // Close the panel with higher z-index first
                        if (showCart.value && chatExpanded.value) {
                            if (cartZIndex.value > chatZIndex.value) {
                                showCart.value = false;
                            } else {
                                chatExpanded.value = false;
                            }
                        } else if (showCart.value) {
                            showCart.value = false;
                        } else if (chatExpanded.value) {
                            chatExpanded.value = false;
                        }
                    }
                }

                // Drag functionality
                let isDragging = false;
                let dragTarget = null;
                let dragOffset = { x: 0, y: 0 };

                function startDragCart(e) {
                    if (e.target.closest('.collapse-btn') || e.target.closest('.el-button')) return;
                    isDragging = true;
                    dragTarget = 'cart';
                    dragOffset = { x: e.clientX - cartPosition.value.x, y: e.clientY - cartPosition.value.y };
                    document.addEventListener('mousemove', onDrag);
                    document.addEventListener('mouseup', stopDrag);
                }

                function startDragChat(e) {
                    if (e.target.closest('.collapse-btn') || e.target.closest('.el-button')) return;
                    isDragging = true;
                    dragTarget = 'chat';
                    dragOffset = { x: e.clientX - chatPosition.value.x, y: e.clientY - chatPosition.value.y };
                    document.addEventListener('mousemove', onDrag);
                    document.addEventListener('mouseup', stopDrag);
                }

                function onDrag(e) {
                    if (!isDragging) return;
                    if (dragTarget === 'cart') {
                        cartPosition.value = { 
                            x: Math.max(0, Math.min(window.innerWidth - 400, e.clientX - dragOffset.x)),
                            y: Math.max(0, Math.min(window.innerHeight - 200, e.clientY - dragOffset.y))
                        };
                    } else if (dragTarget === 'chat') {
                        chatPosition.value = { 
                            x: Math.max(0, Math.min(window.innerWidth - 480, e.clientX - dragOffset.x)),
                            y: Math.max(0, Math.min(window.innerHeight - 200, e.clientY - dragOffset.y))
                        };
                    }
                }

                function stopDrag() {
                    isDragging = false;
                    dragTarget = null;
                    document.removeEventListener('mousemove', onDrag);
                    document.removeEventListener('mouseup', stopDrag);
                }

                function toggleChatFullscreen() {
                    chatAnimating.value = true;
                    chatFullscreen.value = !chatFullscreen.value;
                    setTimeout(() => {
                        chatAnimating.value = false;
                    }, 300);
                }

                // Resize functionality
                let isResizing = false;
                let resizeDirection = null;
                let resizeStart = { x: 0, y: 0, width: 0, height: 0, left: 0, top: 0 };

                function startResizeChat(direction, e) {
                    if (chatFullscreen.value) return;
                    isResizing = true;
                    resizeDirection = direction;
                    resizeStart = {
                        x: e.clientX,
                        y: e.clientY,
                        width: chatSize.value.width,
                        height: chatSize.value.height,
                        left: chatPosition.value.x,
                        top: chatPosition.value.y
                    };
                    document.addEventListener('mousemove', onResize);
                    document.addEventListener('mouseup', stopResize);
                }

                function onResize(e) {
                    if (!isResizing) return;
                    const dx = e.clientX - resizeStart.x;
                    const dy = e.clientY - resizeStart.y;
                    const minW = 380, minH = 420;
                    const maxW = window.innerWidth - 40;
                    const maxH = window.innerHeight - 40;

                    let newWidth = resizeStart.width;
                    let newHeight = resizeStart.height;
                    let newLeft = resizeStart.left;
                    let newTop = resizeStart.top;

                    if (resizeDirection.includes('right')) {
                        newWidth = Math.min(maxW, Math.max(minW, resizeStart.width + dx));
                    }
                    if (resizeDirection.includes('left')) {
                        newWidth = Math.min(maxW, Math.max(minW, resizeStart.width - dx));
                        if (newWidth !== resizeStart.width) {
                            newLeft = resizeStart.left + (resizeStart.width - newWidth);
                        }
                    }
                    if (resizeDirection.includes('bottom')) {
                        newHeight = Math.min(maxH, Math.max(minH, resizeStart.height + dy));
                    }
                    if (resizeDirection.includes('top')) {
                        newHeight = Math.min(maxH, Math.max(minH, resizeStart.height - dy));
                        if (newHeight !== resizeStart.height) {
                            newTop = resizeStart.top + (resizeStart.height - newHeight);
                        }
                    }

                    chatSize.value = { width: newWidth, height: newHeight };
                    chatPosition.value = { x: newLeft, y: newTop };
                }

                function stopResize() {
                    isResizing = false;
                    resizeDirection = null;
                    document.removeEventListener('mousemove', onResize);
                    document.removeEventListener('mouseup', stopResize);
                }

                const searchQuery = ref('');
                const searchDays = ref('');
                const searching = ref(false);
                const searchResults = ref([]);
                const searchLogs = ref([]);

                const recentSelectedIds = ref([]);
                const recentSelectAll = ref(false);
                const searchSelectedIds = ref([]);
                const searchSelectAll = ref(false);

                // collectionStore properties
                const {
                    collections, viewingCollection, collectionPapers, collectionCurrentPage,
                    collectionTotalCount, collectionTotalPages, collectionPaperSearch,
                    loadingCollectionPapers, useAiSearch, aiSearching, collectionViewMode,
                    collectionSearchQuery, filteredCollections, showCreateCollection, savingCollection,
                    editingCollection, newCollection, showDeleteConfirm, deletingCollection,
                    deletingCollectionInProgress, showMergeConfirmDialog, mergingFromCollection,
                    mergingToCollection, mergingInProgress, selectedCollectionId
                } = storeToRefs(collectionStore);

                const selectedPaper = ref(null);
                const addingToCollection = ref(false);
                const showCollectionDetail = ref(false);
                const collectionSortBy = ref('published');
                const collectionSortOrder = ref('desc');

                let yearChart = null;
                let categoryChart = null;

                const daysOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: '1', label: isZh ? '1 天' : '1 day' },
                        { value: '3', label: isZh ? '3 天' : '3 days' },
                        { value: '7', label: isZh ? '7 天' : '7 days' },
                        { value: '14', label: isZh ? '14 天' : '14 days' },
                        { value: '30', label: isZh ? '30 天' : '30 days' }
                    ];
                });

                const limitOptions = [
                    { value: '20', label: '20' },
                    { value: '50', label: '50' },
                    { value: '64', label: '64' },
                    { value: '100', label: '100' },
                    { value: '200', label: '200' }
                ];

                const syncYearOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: '1', label: isZh ? '1 年' : '1 year' },
                        { value: '2', label: isZh ? '2 年' : '2 years' },
                        { value: '3', label: isZh ? '3 年' : '3 years' },
                        { value: '5', label: isZh ? '5 年' : '5 years' },
                        { value: '10', label: isZh ? '10 年' : '10 years' }
                    ];
                });

                const initYearOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: 1, label: isZh ? '1 年' : '1 year' },
                        { value: 2, label: isZh ? '2 年' : '2 years' },
                        { value: 3, label: isZh ? '3 年' : '3 years' },
                        { value: 5, label: isZh ? '5 年（推荐）' : '5 years (Recommended)' },
                        { value: 10, label: isZh ? '10 年' : '10 years' }
                    ];
                });

                const syncYearsBackOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: '1', label: isZh ? '1 年' : '1 year' },
                        { value: '2', label: isZh ? '2 年' : '2 years' },
                        { value: '5', label: isZh ? '5 年' : '5 years' },
                        { value: '10', label: isZh ? '10 年' : '10 years' },
                        { value: '20', label: isZh ? '20 年' : '20 years' }
                    ];
                });

                const searchDaysOptions = computed(() => {
                    const isZh = currentLang.value === 'zh';
                    return [
                        { value: '', label: isZh ? '不限' : 'Any' },
                        { value: '30', label: isZh ? '最近 30 天' : 'Last 30 days' },
                        { value: '90', label: isZh ? '最近 90 天' : 'Last 90 days' },
                        { value: '180', label: isZh ? '最近 180 天' : 'Last 180 days' },
                        { value: '365', label: isZh ? '最近 1 年' : 'Last 1 year' }
                    ];
                });

                const aiLanguageOptions = [
                    { value: 'zh', label: '中文' },
                    { value: 'en', label: 'English' },
                    { value: 'ru', label: 'Русский' },
                    { value: 'fr', label: 'Français' },
                    { value: 'de', label: 'Deutsch' },
                    { value: 'es', label: 'Español' },
                    { value: 'ar', label: 'العربية' }
                ];

                const categoryOptions = computed(() => {
                    return fieldStats.value
                        .filter(f => f.paper_count > 0)
                        .map(f => ({ value: f.key, label: f.name }));
                });

                const recentCacheStatus = computed(() => {
                    const info = recentPapers.value._cacheInfo;
                    if (!info) return '无缓存';
                    if (info.cached && info.updated_at) {
                        const date = new Date(info.updated_at);
                        return `缓存于 ${date.toLocaleString('zh-CN')}`;
                    }
                    return t('sync.noCache');
                });

                const syncStatusText = computed(() => {
                    if (!syncStatus.value?.last_sync) return t('sync.neverSynced');
                    return syncStatus.value.last_sync.status === 'completed' ? t('sync.completed') : t('sync.inProgress');
                });

                const syncStatusClass = computed(() => {
                    if (!syncStatus.value?.last_sync) return '';
                    return syncStatus.value.last_sync.status === 'completed' ? 'success' : 'warning';
                });

                const syncTimeClass = computed(() => {
                    if (!syncStatus.value?.last_sync?.time) return '';
                    const hours = (Date.now() - new Date(syncStatus.value.last_sync.time).getTime()) / 3600000;
                    if (hours < 24) return 'success';
                    if (hours < 72) return 'warning';
                    return '';
                });

                const formatSyncTime = computed(() => {
                    if (!syncStatus.value?.last_sync?.time) return '-';
                    const date = new Date(syncStatus.value.last_sync.time);
                    return date.toLocaleDateString('zh-CN');
                });

                async function checkInitStatus() {
                    await configStore.checkInitStatus();
                    const defaultExpanded = ['physics', 'cond-mat', 'cs'];
                    defaultExpanded.forEach(key => {
                        expandedGroups.value[key] = true;
                    });
                }

                async function testSetupAI() {
                    await configStore.testSetupAI();
                }

                function toggleCategoryGroup(key) {
                    expandedGroups.value[key] = !expandedGroups.value[key];
                }

                function toggleSetupField(key) {
                    const idx = setupConfig.value.selected_fields.indexOf(key);
                    if (idx >= 0) {
                        setupConfig.value.selected_fields.splice(idx, 1);
                    } else {
                        setupConfig.value.selected_fields.push(key);
                    }
                }

                async function startInitialSync() {
                    setupStep.value = 4;
                    initializing.value = true;
                    initLogs.value = [];
                    initProgress.value = 0;
                    initCurrentQuery.value = 0;
                    initTotalQueries.value = 0;
                    initComplete.value = false;

                    let msgIndex = 0;
                    waitingMessage.value = waitingMessages.value[0];
                    waitingTimer = setInterval(() => {
                        msgIndex = (msgIndex + 1) % waitingMessages.value.length;
                        waitingMessage.value = waitingMessages.value[msgIndex];
                    }, 4000);

                    try {
                        await API.config.init(setupConfig.value);

                        const response = await API.config.initSync();
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'total') {
                                            initTotalQueries.value = data.total;
                                        } else if (data.type === 'progress') {
                                            initCurrentQuery.value = data.current;
                                            initTotalQueries.value = data.total;
                                            initProgress.value = Math.round((data.current / data.total) * 100);
                                        } else if (data.type === 'done') {
                                            if (waitingTimer) clearInterval(waitingTimer);
                                            initProgress.value = 100;
                                            initComplete.value = true;
                                            setTimeout(() => {
                                                showSetup.value = false;
                                                fetchConfig();
                                                fetchStats();
                                                fetchFieldStats();
                                                fetchRecentCache();
                                            }, 2000);
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        initLogs.value.push({ type: 'error', message: `初始化失败: ${e.message}` });
                    } finally {
                        initializing.value = false;
                        if (waitingTimer) clearInterval(waitingTimer);
                    }
                }

                async function fetchConfig() {
                    await configStore.fetchConfig();
                    nextTick(() => { settingsInitialized = true; });
                }

                async function saveApiKey() {
                    await configStore.saveApiKey();
                }

                async function testAIConnection() {
                    await configStore.testAIConnection();
                }

                function toggleSettingsField(key) {
                    if (!settingsConfig.value.selected_fields) {
                        settingsConfig.value.selected_fields = [];
                    }
                    const idx = settingsConfig.value.selected_fields.indexOf(key);
                    if (idx >= 0) {
                        settingsConfig.value.selected_fields.splice(idx, 1);
                    } else {
                        settingsConfig.value.selected_fields.push(key);
                    }
                }

                function openFieldSelector(source) {
                    configStore.openFieldSelector(source);
                    syncingFromCode = true;
                    nextTick(() => { syncingFromCode = false; });
                }

                function toggleFieldSelectorGroup(key) {
                    configStore.toggleFieldSelectorGroup(key);
                }

                function toggleTempField(fieldId) {
                    configStore.toggleTempField(fieldId);
                    syncFieldsToCode();
                }

                function removeFromTempSelection(fieldId) {
                    configStore.removeFromTempSelection(fieldId);
                    syncFieldsToCode();
                }

                function clearTempSelection() {
                    configStore.clearTempSelection();
                }

                let syncingFromCode = false;

                function syncFieldsToCode() {
                    const queries = tempSelectedFields.value.map(f => `cat:${f}`);
                    advancedQueriesText.value = queries.join('\n');
                }

                function parseCodeToFields() {
                    const lines = advancedQueriesLines.value;
                    const standardFields = [];
                    const customQueries = [];
                    
                    for (const line of lines) {
                        const catMatch = line.match(/^cat:(.+)$/);
                        if (catMatch) {
                            const fieldId = catMatch[1].trim();
                            if (allCategories.value[fieldId]) {
                                standardFields.push(fieldId);
                            } else {
                                customQueries.push(line);
                            }
                        } else {
                            customQueries.push(line);
                        }
                    }
                    
                    return { standardFields, customQueries };
                }

                // 源码变化时同步 fields（仅在源码模式）
                watch(advancedQueriesText, () => {
                    if (fieldAdvancedMode.value && !syncingFromCode) {
                        syncingFromCode = true;
                        const { standardFields } = parseCodeToFields();
                        tempSelectedFields.value = standardFields;
                        nextTick(() => { syncingFromCode = false; });
                    }
                });

                // fields 变化时同步源码（仅在可视化模式）
                watch(tempSelectedFields, () => {
                    if (!fieldAdvancedMode.value && !syncingFromCode) {
                        syncingFromCode = true;
                        syncFieldsToCode();
                        nextTick(() => { syncingFromCode = false; });
                    }
                }, { deep: true });

                function confirmFieldSelection() {
                    const { standardFields, customQueries } = parseCodeToFields();
                    
                    if (fieldSelectorSource.value === 'settings') {
                        // 合并标准分类和自定义查询
                        settingsConfig.value.selected_fields = [...tempSelectedFields.value];
                        settingsConfig.value.search_queries = [...advancedQueriesLines.value];
                    } else if (fieldSelectorSource.value === 'init') {
                        setupConfig.value.selected_fields = [...tempSelectedFields.value];
                        setupConfig.value.search_queries = [...advancedQueriesLines.value];
                    } else if (fieldSelectorSource.value === 'recent') {
                        recentCategories.value = [...tempSelectedFields.value];
                    }
                    showFieldSelector.value = false;
                }

                let saveTimeout = null;
                async function saveSettings() {
                    await configStore.saveSettings();
                    fetchFieldStats();
                }

                function debouncedSave() {
                    if (saveTimeout) clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => saveSettings(), 500);
                }

                let settingsInitialized = false;
                watch(
                    () => ({
                        ai_base_url: settingsConfig.value.ai_base_url,
                        ai_model: settingsConfig.value.ai_model,
                        translate_language: settingsConfig.value.translate_language,
                        years_back: settingsConfig.value.years_back,
                        arxiv_max_results: settingsConfig.value.arxiv_max_results,
                        arxiv_max_results_per_field: settingsConfig.value.arxiv_max_results_per_field,
                        recent_papers_limit: settingsConfig.value.recent_papers_limit,
                        search_limit: settingsConfig.value.search_limit,
                        ui_language: settingsConfig.value.ui_language,
                    }),
                    (newVal, oldVal) => {
                        if (!settingsInitialized) return;
                        for (const key of Object.keys(newVal)) {
                            if (newVal[key] !== oldVal?.[key]) {
                                debouncedSave();
                                break;
                            }
                        }
                    },
                    { deep: true }
                );

                function onLanguageChange(lang) {
                    setLanguage(lang);
                    if (settingsConfig.value) {
                        settingsConfig.value.ui_language = lang;
                    }
                }

                async function toggleLanguage() {
                    const newLang = currentLang.value === 'zh' ? 'en' : 'zh';
                    configStore.setLanguage(newLang);
                    if (settingsConfig.value) {
                        settingsConfig.value.ui_language = newLang;
                        try {
                            await API.config.update(settingsConfig.value);
                        } catch (e) {
                            console.error('Failed to save language setting:', e);
                        }
                    }
                }

                async function fetchStats() {
                    try {
                        const res = await API.stats.get();
                        stats.value = await res.json();
                        await nextTick();
                        if (currentPage.value === 'sync') {
                            initChartsWithRetry();
                        }
                    } catch (e) {
                        console.error('Failed to fetch stats:', e);
                    }
                }

                function getSelectedFieldsTooltip() {
                    const keys = recentCategories.value.length > 0 
                        ? recentCategories.value 
                        : (settingsConfig.value.selected_fields || []);
                    
                    if (keys.length === 0) {
                        return currentLang.value === 'zh' ? '未选择领域' : 'No fields selected';
                    }
                    
                    const names = keys.map(key => {
                        const field = fieldStats.value.find(f => f.key === key);
                        if (field) {
                            return currentLang.value === 'zh' ? field.name : field.name_en;
                        }
                        return key;
                    });
                    
                    return names.join(', ');
                }

                function hasSelectedFields() {
                    const keys = recentCategories.value.length > 0 
                        ? recentCategories.value 
                        : (settingsConfig.value.selected_fields || []);
                    return keys.length > 0;
                }

                async function fetchFieldStats() {
                    try {
                        const res = await API.stats.fields();
                        const data = await res.json();
                        fieldStats.value = data.fields || [];
                    } catch (e) {
                        console.error('Failed to fetch field stats:', e);
                    }
                }

                async function fetchRecentCache() {
                    loadingRecent.value = true;
                    loadingProgress.value = 0;
                    loadingTotal.value = 0;
                    recentPapers.value = [];
                    
                    const controller = new AbortController();
                    loadingController.value = controller;
                    
                    try {
                        const response = await API.papers.recentCacheStream('');
                        response.body.cancel = () => controller.abort();
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'start') {
                                            loadingTotal.value = data.total;
                                            recentPapers.value._cacheInfo = {
                                                cached: data.cached,
                                                updated_at: data.updated_at,
                                                days_back: data.days_back
                                            };
                                        } else if (data.type === 'result') {
                                            recentPapers.value.push(data.paper);
                                            loadingProgress.value = data.index;
                                        } else if (data.type === 'progress') {
                                            loadingProgress.value = data.index;
                                        } else if (data.type === 'done') {
                                            loadingTotal.value = data.total;
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        if (e.name !== 'AbortError') {
                            console.error('Failed to fetch recent cache:', e);
                        }
                    } finally {
                        loadingRecent.value = false;
                        loadingController.value = null;
                    }
                }
                
                function stopLoading() {
                    if (loadingController.value) {
                        loadingController.value.abort();
                        loadingRecent.value = false;
                        loadingController.value = null;
                    }
                }

                async function updateRecentPapers() {
                    updatingRecent.value = true;
                    recentLogs.value = [];
                    recentPapers.value = [];
                    try {
                        const params = new URLSearchParams({
                            days: recentDays.value,
                            need_sync: recentNeedSync.value
                        });
                        const cats = recentCategories.value.length > 0 
                            ? recentCategories.value 
                            : (settingsConfig.value.selected_fields || []);
                        if (cats.length > 0) {
                            params.append('categories', cats.join(','));
                        }

                        const response = await API.papers.recentUpdate(params.toString());
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            recentLogs.value.push(data.message);
                                        } else if (data.type === 'result') {
                                            recentPapers.value.push(data.paper);
                                        } else if (data.type === 'done') {
                                            recentLogs.value.push(`更新完成，共 ${data.total} 篇论文`);
                                            recentPapers.value._cacheInfo = { cached: true, updated_at: new Date().toISOString() };
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Failed to update recent papers:', e);
                    } finally {
                        updatingRecent.value = false;
                    }
                }

                async function startSearch() {
                    if (!searchQuery.value.trim()) {
                        ElementPlus.ElMessage.warning('请输入搜索关键词');
                        return;
                    }
                    searching.value = true;
                    searchResults.value = [];
                    searchLogs.value = [];

                    try {
                        const params = new URLSearchParams({ q: searchQuery.value });
                        if (searchDays.value) params.append('days', searchDays.value);

                        const response = await API.papers.searchStream(params.toString());
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            searchLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'result') {
                                            searchResults.value.push(data.paper);
                                        } else if (data.type === 'done') {
                                            searchLogs.value.push({ type: 'success', message: `搜索完成，共 ${data.total} 篇论文` });
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Search failed:', e);
                    } finally {
                        searching.value = false;
                    }
                }

                async function fetchCollections() {
                    try {
                        const res = await API.collections.list();
                        collections.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch collections:', e);
                    }
                }

                async function fetchSyncStatus() {
                    try {
                        const res = await API.tasks.status();
                        syncStatus.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch sync status:', e);
                    }
                }

                async function startSync() {
                    syncing.value = true;
                    syncLogs.value = [];
                    try {
                        const params = new URLSearchParams({
                            years_back: syncYearsBack.value,
                            force: syncForce.value
                        });

                        const response = await API.tasks.sync(params.toString());
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            syncLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'done') {
                                            syncLogs.value.push({ type: 'success', message: '同步完成' });
                                            fetchStats();
                                            fetchRecentCache();
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Sync failed:', e);
                    } finally {
                        syncing.value = false;
                    }
                }

                async function fetchCacheStats() {
                    try {
                        const res = await API.cache.stats();
                        cacheStats.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch cache stats:', e);
                    }
                }

                async function clearCache(type) {
                    const typeNames = {
                        translations: currentLang.value === 'zh' ? '翻译缓存' : 'translation cache',
                        summaries: currentLang.value === 'zh' ? 'AI 总结' : 'AI summaries',
                        figures: currentLang.value === 'zh' ? '图片缓存' : 'figure cache',
                        contents: currentLang.value === 'zh' ? '内容缓存' : 'content cache',
                        all: currentLang.value === 'zh' ? '所有缓存' : 'all cache'
                    };
                    
                    const confirmMsg = type === 'all' 
                        ? t('cache.confirmAll')
                        : t('cache.confirmClear').replace('{type}', typeNames[type]);
                    
                    try {
                        await ElementPlus.ElMessageBox.confirm(confirmMsg, t('common.confirm'), {
                            confirmButtonText: t('common.confirm'),
                            cancelButtonText: t('common.cancel'),
                            type: 'warning'
                        });
                    } catch {
                        return;
                    }

                    cacheClearing.value = type;
                    try {
                        const res = await API.cache.clear([type]);
                        const data = await res.json();
                        if (data.success) {
                            const total = Object.values(data.cleared).reduce((a, b) => a + b, 0);
                            ElementPlus.ElMessage.success(t('cache.cleared').replace('{count}', total));
                            fetchCacheStats();
                            fetchStats();
                        } else {
                            ElementPlus.ElMessage.error(t('cache.clearFailed'));
                        }
                    } catch (e) {
                        console.error('Failed to clear cache:', e);
                        ElementPlus.ElMessage.error(t('cache.clearFailed'));
                    } finally {
                        cacheClearing.value = null;
                    }
                }

                async function saveCollection() {
                    if (!newCollection.value.name.trim()) {
                        ElementPlus.ElMessage.warning('请输入论文集名称');
                        return;
                    }
                    savingCollection.value = true;
                    try {
                        if (editingCollection.value) {
                            const res = await API.collections.update(editingCollection.value.id, newCollection.value);
                            if (res.ok) {
                                ElementPlus.ElMessage.success(currentLang.value === 'zh' ? '更新成功' : 'Updated');
                                showCreateCollection.value = false;
                                editingCollection.value = null;
                                newCollection.value = { name: '', description: '', color: '#1e3a5f' };
                                fetchCollections();
                            } else {
                                ElementPlus.ElMessage.error(currentLang.value === 'zh' ? '更新失败' : 'Failed to update');
                            }
                        } else {
                            const res = await API.collections.create(newCollection.value);
                            if (res.ok) {
                                ElementPlus.ElMessage.success(currentLang.value === 'zh' ? '创建成功' : 'Created');
                                showCreateCollection.value = false;
                                newCollection.value = { name: '', description: '', color: '#1e3a5f' };
                                fetchCollections();
                            } else {
                                ElementPlus.ElMessage.error(currentLang.value === 'zh' ? '创建失败' : 'Failed to create');
                            }
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error(currentLang.value === 'zh' ? '操作失败' : 'Operation failed');
                    } finally {
                        savingCollection.value = false;
                    }
                }

                function cancelCollectionDialog() {
                    showCreateCollection.value = false;
                    editingCollection.value = null;
                    newCollection.value = { name: '', description: '', color: '#1e3a5f' };
                }

                function openEditCollection(collection) {
                    editingCollection.value = { ...collection };
                    newCollection.value = { 
                        name: collection.name, 
                        description: collection.description || '', 
                        color: collection.color || '#1e3a5f' 
                    };
                    showCreateCollection.value = true;
                }

                async function deleteCollection() {
                    deletingCollectionInProgress.value = true;
                    try {
                        const res = await API.collections.delete(deletingCollection.value.id);
                        if (res.ok) {
                            ElementPlus.ElMessage.success('删除成功');
                            showDeleteConfirm.value = false;
                            fetchCollections();
                        } else {
                            ElementPlus.ElMessage.error('删除失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('删除失败');
                    } finally {
                        deletingCollectionInProgress.value = false;
                    }
                }

                function showMergeConfirm(fromCollection, toCollection) {
                    mergingFromCollection.value = fromCollection;
                    mergingToCollection.value = toCollection;
                    showMergeConfirmDialog.value = true;
                }

                async function mergePapers() {
                    if (!mergingFromCollection.value || !mergingToCollection.value) return;
                    mergingInProgress.value = true;
                    try {
                        const res = await API.collections.merge(mergingFromCollection.value.id, mergingToCollection.value.id);
                        if (res.ok) {
                            const data = await res.json();
                            ElementPlus.ElMessage.success(t('collections.mergeSuccess', { count: data.merged_count, name: mergingToCollection.value.name }));
                            showMergeConfirmDialog.value = false;
                            fetchCollections();
                        } else {
                            const err = await res.json();
                            ElementPlus.ElMessage.error(err.detail || '迁移失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('迁移失败');
                    } finally {
                        mergingInProgress.value = false;
                    }
                }

                async function openCollectionDetail(collection) {
                    viewingCollection.value = collection;
                    collectionCurrentPage.value = 1;
                    collectionPaperSearch.value = '';
                    collectionSortBy.value = 'published';
                    collectionSortOrder.value = 'desc';
                    useAiSearch.value = false;
                    loadingCollectionPapers.value = true;
                    showCollectionDetail.value = true;
                    await loadCollectionPage();
                }

                async function performSearch() {
                    if (!viewingCollection.value) return;
                    collectionCurrentPage.value = 1;
                    
                    if (useAiSearch.value && collectionPaperSearch.value.trim()) {
                        aiSearching.value = true;
                        loadingCollectionPapers.value = true;
                        try {
                            const res = await API.collections.aiSearch(viewingCollection.value.id, collectionPaperSearch.value.trim());
                            const data = await res.json();
                            if (data.papers && data.papers.length > 0) {
                                collectionPapers.value = data.papers;
                                collectionTotalCount.value = data.papers.length;
                                collectionTotalPages.value = 1;
                                ElementPlus.ElMessage.success(t('collections.aiResult', { count: data.papers.length }));
                            } else {
                                collectionPapers.value = [];
                                collectionTotalCount.value = 0;
                                collectionTotalPages.value = 0;
                                ElementPlus.ElMessage.info(t('collections.aiNoResult'));
                            }
                        } catch (e) {
                            console.error('AI search failed:', e);
                            ElementPlus.ElMessage.error(currentLang.value === 'zh' ? 'AI 检索失败' : 'AI search failed');
                        } finally {
                            aiSearching.value = false;
                            loadingCollectionPapers.value = false;
                        }
                    } else {
                        loadCollectionPage();
                    }
                }

                function toggleSortOrder() {
                    collectionSortOrder.value = collectionSortOrder.value === 'desc' ? 'asc' : 'desc';
                    performSearch();
                }

                function openPaperUrl(url) {
                    if (url) window.open(url, '_blank');
                }

                async function loadCollectionPage() {
                    if (!viewingCollection.value) return;
                    loadingCollectionPapers.value = true;
                    try {
                        const params = new URLSearchParams({
                            page: collectionCurrentPage.value,
                            page_size: 20
                        });
                        if (collectionPaperSearch.value && !useAiSearch.value) {
                            params.append('search', collectionPaperSearch.value);
                        }
                        if (collectionSortBy.value) {
                            params.append('sort_by', collectionSortBy.value);
                        }
                        if (collectionSortOrder.value) {
                            params.append('sort_order', collectionSortOrder.value);
                        }
                        const res = await API.collections.papers(viewingCollection.value.id, params.toString());
                        const data = await res.json();
                        collectionPapers.value = data.papers || [];
                        collectionTotalCount.value = data.total_count || 0;
                        collectionTotalPages.value = data.total_pages || 0;
                    } catch (e) {
                        console.error('Failed to fetch collection papers:', e);
                    } finally {
                        loadingCollectionPapers.value = false;
                    }
                }

                async function removePaperFromCollection(paperId) {
                    try {
                        const res = await API.collections.removePaper(viewingCollection.value.id, paperId);
                        if (res.ok) {
                            ElementPlus.ElMessage.success('已移除');
                            loadCollectionPage();
                            fetchCollections();
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('移除失败');
                    }
                }

                function editCollection(collection) {
                    editingCollection.value = { ...collection };
                    newCollection.value = { 
                        name: collection.name, 
                        description: collection.description || '', 
                        color: collection.color || '#1e3a5f' 
                    };
                    showCreateCollection.value = true;
                }

                async function duplicateCollection(collection) {
                    savingCollection.value = true;
                    try {
                        const res = await API.collections.create({
                            name: `${collection.name} (copy)`,
                            description: collection.description,
                            color: collection.color
                        });
                        if (res.ok) {
                            const newCol = await res.json();
                            fetchCollections();
                            ElementPlus.ElMessage.success(currentLang.value === 'zh' ? '已复制' : 'Duplicated');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error(currentLang.value === 'zh' ? '复制失败' : 'Failed to duplicate');
                    } finally {
                        savingCollection.value = false;
                    }
                }

                function confirmDeleteCollection(collection) {
                    deletingCollection.value = collection;
                    showDeleteConfirm.value = true;
                }

                function addToCollection(paper) {
                    selectedPaper.value = paper;
                    selectedCollectionId.value = null;
                    showAddToCollection.value = true;
                }

                async function confirmAddToCollection() {
                    if (!selectedCollectionId.value) {
                        ElementPlus.ElMessage.warning('请选择论文集');
                        return;
                    }
                    addingToCollection.value = true;
                    try {
                        const papersToAdd = selectedPaper.value ? [selectedPaper.value] : paperCart.value;
                        if (papersToAdd.length === 0) {
                            ElementPlus.ElMessage.warning('没有选中的论文');
                            return;
                        }
                        
                        const paperIds = papersToAdd.map(p => p.id);
                        const res = await API.collections.addPapersBatch(selectedCollectionId.value, paperIds);
                        
                        if (res.ok) {
                            const data = await res.json();
                            const messages = [];
                            if (data.added_count > 0) {
                                messages.push(`成功添加 ${data.added_count} 篇论文`);
                            }
                            if (data.skipped_count > 0) {
                                messages.push(`${data.skipped_count} 篇已在论文集中`);
                            }
                            if (messages.length > 0) {
                                ElementPlus.ElMessage.success(messages.join('，'));
                            }
                            showAddToCollection.value = false;
                            fetchCollections();
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('添加失败');
                    } finally {
                        addingToCollection.value = false;
                        selectedPaper.value = null;
                    }
                }

                function toggleRecentSelect(paperId) {
                    const idx = recentSelectedIds.value.indexOf(paperId);
                    if (idx >= 0) {
                        recentSelectedIds.value.splice(idx, 1);
                    } else {
                        recentSelectedIds.value.push(paperId);
                    }
                    recentSelectAll.value = recentSelectedIds.value.length === recentPapers.value.length;
                }

                function toggleRecentSelectAll(val) {
                    if (val) {
                        recentSelectedIds.value = recentPapers.value.map(p => p.id);
                    } else {
                        recentSelectedIds.value = [];
                    }
                }

                function toggleSearchSelect(paperId) {
                    const idx = searchSelectedIds.value.indexOf(paperId);
                    if (idx >= 0) {
                        searchSelectedIds.value.splice(idx, 1);
                    } else {
                        searchSelectedIds.value.push(paperId);
                    }
                    searchSelectAll.value = searchSelectedIds.value.length === searchResults.value.length;
                }

                function toggleSearchSelectAll(val) {
                    if (val) {
                        searchSelectedIds.value = searchResults.value.map(p => p.id);
                    } else {
                        searchSelectedIds.value = [];
                    }
                }

                async function exportRecent(format) {
                    if (recentSelectedIds.value.length === 0) return;
                    try {
                        const res = await API.export.papers({
                            paper_ids: recentSelectedIds.value,
                            format: format,
                            include_summary: true
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `recent_papers.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success(`已导出 ${recentSelectedIds.value.length} 篇论文`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                async function exportSearch(format) {
                    if (searchSelectedIds.value.length === 0) return;
                    try {
                        const res = await API.export.papers({
                            paper_ids: searchSelectedIds.value,
                            format: format,
                            include_summary: true
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `search_results.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success(`已导出 ${searchSelectedIds.value.length} 篇论文`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                async function exportCollection(format) {
                    if (!viewingCollection.value) return;
                    try {
                        const res = await API.export.collection({
                            collection_id: viewingCollection.value.id,
                            format: format,
                            include_summary: true
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `collection_${viewingCollection.value.name.replace(/\s+/g, '_')}.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success('导出成功');
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                async function exportCollectionWithId(collectionId, format) {
                    const collection = collections.value.find(c => c.id === collectionId);
                    if (!collection) return;
                    try {
                        const res = await API.export.collection({
                            collection_id: collectionId,
                            format: format,
                            include_summary: true
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `collection_${collection.name.replace(/\s+/g, '_')}.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success('导出成功');
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                function navigateTo(page) {
                    currentPage.value = page;
                    if (page === 'sync') {
                        fetchCacheStats();
                    }
                }

                function navigateToHome() {
                    const app = document.querySelector('#app');
                    if (app) {
                        app.classList.add('page-circle-exit');
                        setTimeout(() => {
                            currentPage.value = 'home';
                            app.classList.remove('page-circle-exit');
                        }, 350);
                    } else {
                        currentPage.value = 'home';
                    }
                }

                function onTabChange(tab) {
                    currentPage.value = tab;
                }

                function toggleHomeSelect(paperId) {
                    const idx = homeSelectedIds.value.indexOf(paperId);
                    if (idx >= 0) {
                        homeSelectedIds.value.splice(idx, 1);
                    } else {
                        homeSelectedIds.value.push(paperId);
                    }
                }

                async function startHomeSearch() {
                    if (!homeQuery.value.trim()) return;
                    
                    homeSearching.value = true;
                    homeLogs.value = [];
                    homeResults.value = [];
                    homeSelectedIds.value = [];
                    
                    try {
                        const params = new URLSearchParams({ q: homeQuery.value });
                        const response = await API.papers.quick(params.toString());
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'log') {
                                            homeLogs.value.push({ type: 'info', message: data.message });
                                        } else if (data.type === 'result') {
                                            homeResults.value.push(data.paper);
                                        } else if (data.type === 'done') {
                                            if (data.total === 0) {
                                                homeLogs.value.push({ type: 'info', message: '未找到匹配的论文' });
                                            }
                                        } else if (data.type === 'error') {
                                            homeLogs.value.push({ type: 'error', message: data.message });
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } catch (e) {
                        homeLogs.value.push({ type: 'error', message: `搜索失败: ${e.message}` });
                    } finally {
                        homeSearching.value = false;
                    }
                }

                async function exportHome(format) {
                    if (homeSelectedIds.value.length === 0) return;
                    try {
                        const res = await API.export.papers({
                            paper_ids: homeSelectedIds.value,
                            format: format,
                            include_summary: true
                        });
                        if (!res.ok) throw new Error('Export failed');
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const ext = format === 'markdown' ? 'md' : format === 'bibtex' ? 'bib' : format;
                        a.download = `search_results.${ext}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        ElementPlus.ElMessage.success(`已导出 ${homeSelectedIds.value.length} 篇论文`);
                    } catch (e) {
                        ElementPlus.ElMessage.error('导出失败');
                    }
                }

                function initCharts() {
                    const yearEl = document.getElementById('yearChart');
                    const categoryEl = document.getElementById('categoryChart');
                    if (yearEl && categoryEl) {
                        if (yearChart) yearChart.dispose();
                        if (categoryChart) categoryChart.dispose();
                        yearChart = echarts.init(yearEl);
                        categoryChart = echarts.init(categoryEl);
                        return true;
                    }
                    return false;
                }

                function initChartsWithRetry(retries = 30) {
                    let attempts = 0;
                    const tryInit = () => {
                        attempts++;
                        const yearEl = document.getElementById('yearChart');
                        const categoryEl = document.getElementById('categoryChart');
                        
                        if (yearEl && categoryEl && yearEl.offsetWidth > 0) {
                            if (yearChart) yearChart.dispose();
                            if (categoryChart) categoryChart.dispose();
                            yearChart = echarts.init(yearEl);
                            categoryChart = echarts.init(categoryEl);
                            renderYearChart(stats.value?.years);
                            renderCategoryChart(stats.value?.categories?.top);
                        } else if (attempts < retries) {
                            setTimeout(tryInit, 100);
                        }
                    };
                    setTimeout(tryInit, 100);
                }

                function renderYearChart(data) {
                    if (!yearChart) return;
                    const years = data ? Object.keys(data) : [];
                    const counts = data ? Object.values(data) : [];
                    
                    if (years.length === 0) {
                        yearChart.setOption({
                            title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#909399', fontSize: 14 } },
                            xAxis: { show: false },
                            yAxis: { show: false },
                            series: []
                        });
                        return;
                    }
                    
                    yearChart.setOption({
                        tooltip: { trigger: 'axis' },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: years, axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d' } },
                        yAxis: { type: 'value', axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d' }, splitLine: { lineStyle: { color: '#e8e6e1' } } },
                        series: [{ data: counts, type: 'bar', itemStyle: { color: '#1e3a5f', borderRadius: [4, 4, 0, 0] } }]
                    });
                }

                function renderCategoryChart(data) {
                    if (!categoryChart) return;
                    const categories = data || [];
                    
                    if (categories.length === 0) {
                        categoryChart.setOption({
                            title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#909399', fontSize: 14 } },
                            xAxis: { show: false },
                            yAxis: { show: false },
                            series: []
                        });
                        return;
                    }
                    
                    categoryChart.setOption({
                        tooltip: { trigger: 'item' },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: categories.map(d => d.name), axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d', rotate: 30 } },
                        yAxis: { type: 'value', axisLine: { lineStyle: { color: '#d4d0c8' } }, axisLabel: { color: '#5a6c7d' }, splitLine: { lineStyle: { color: '#e8e6e1' } } },
                        series: [{ data: categories.map(d => d.count), type: 'bar', itemStyle: { color: '#c9a227', borderRadius: [4, 4, 0, 0] } }]
                    });
                }

                watch(showSetup, (val) => {
                    if (!val && currentPage.value === 'sync') {
                        initChartsWithRetry();
                    }
                });
                
                watch(currentPage, (newPage) => {
                    if (newPage === 'sync') {
                        initChartsWithRetry();
                    } else if (newPage === 'home') {
                        fetchStats();
                    } else if (newPage === 'collections') {
                        fetchCollections();
                    }
                });

                function toggleChat() {
                    chatExpanded.value = !chatExpanded.value;
                    if (chatExpanded.value && chatSessions.value.length === 0) {
                        fetchChatSessions();
                    }
                }

                async function fetchChatSessions() {
                    try {
                        const res = await API.chat.sessions.list();
                        chatSessions.value = await res.json();
                    } catch (e) {
                        console.error('Failed to fetch chat sessions:', e);
                    }
                }

                async function createNewChat() {
                    try {
                        const res = await API.chat.sessions.create();
                        const session = await res.json();
                        chatSessions.value.unshift(session);
                        currentChatSession.value = session;
                        chatMessages.value = [];
                        showChatSidebar.value = false;
                    } catch (e) {
                        ElementPlus.ElMessage.error('创建对话失败');
                    }
                }

                async function selectChatSession(session) {
                    currentChatSession.value = session;
                    showChatSidebar.value = false;
                    chatMessages.value = [];
                    try {
                        const res = await API.chat.sessions.get(session.id);
                        const data = await res.json();
                        chatMessages.value = data.messages || [];
                        await nextTick();
                        scrollToBottom();
                    } catch (e) {
                        console.error('Failed to fetch messages:', e);
                    }
                }

                async function deleteChatSession(session) {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除对话 "${session.title}" 吗？`,
                            '删除对话',
                            { confirmButtonText: '删除', cancelButtonText: '取消', type: 'warning' }
                        );
                        
                        const res = await API.chat.sessions.delete(session.id);
                        if (res.ok) {
                            const idx = chatSessions.value.findIndex(s => s.id === session.id);
                            if (idx >= 0) chatSessions.value.splice(idx, 1);
                            
                            if (currentChatSession.value?.id === session.id) {
                                currentChatSession.value = null;
                                chatMessages.value = [];
                            }
                            ElementPlus.ElMessage.success('已删除');
                        }
                    } catch (e) {
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error('删除失败');
                        }
                    }
                }

                async function clearAllChatSessions() {
                    try {
                        const confirmMsg = currentLang.value === 'zh' 
                            ? '确定要清空所有对话记录吗？此操作不可恢复。' 
                            : 'Clear all chat history? This cannot be undone.';
                        const titleMsg = currentLang.value === 'zh' ? '清空所有记录' : 'Clear All';
                        await ElementPlus.ElMessageBox.confirm(confirmMsg, titleMsg, { 
                            confirmButtonText: currentLang.value === 'zh' ? '清空' : 'Clear', 
                            cancelButtonText: currentLang.value === 'zh' ? '取消' : 'Cancel', 
                            type: 'warning' 
                        });
                        
                        for (const session of chatSessions.value) {
                            await API.chat.sessions.delete(session.id);
                        }
                        chatSessions.value = [];
                        currentChatSession.value = null;
                        chatMessages.value = [];
                        showChatSidebar.value = false;
                        ElementPlus.ElMessage.success(currentLang.value === 'zh' ? '已清空所有记录' : 'All sessions cleared');
                    } catch (e) {
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error(currentLang.value === 'zh' ? '清空失败' : 'Failed to clear');
                        }
                    }
                }

                function scrollToBottom() {
                    if (chatMessagesContainer.value) {
                        chatMessagesContainer.value.scrollTop = chatMessagesContainer.value.scrollHeight;
                    }
                }

                function handleChatScroll() {
                    if (chatMessagesContainer.value) {
                        const { scrollTop, scrollHeight, clientHeight } = chatMessagesContainer.value;
                        const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;
                        userScrolledUp.value = !isNearBottom;
                    }
                }

                async function sendQuickPrompt(promptText) {
                    if (chatTyping.value) return;
                    chatInput.value = promptText;
                    await sendChatMessage();
                }

                async function sendChatMessage() {
                    if (!chatInput.value.trim() || chatTyping.value) return;
                    
                    if (!currentChatSession.value) {
                        await createNewChat();
                        if (!currentChatSession.value) return;
                    }

                    const userMessage = {
                        id: Date.now(),
                        role: 'user',
                        content: chatInput.value,
                        paper_ids: selectedChatPapers.value.map(p => p.arxiv_id),
                        created_at: new Date().toISOString()
                    };
                    chatMessages.value.push(userMessage);
                    
                    const messageContent = chatInput.value;
                    const paperIds = selectedChatPapers.value.map(p => p.arxiv_id);
                    chatInput.value = '';
                    selectedChatPapers.value = [];
                    chatTyping.value = true;
                    chatProgress.value = null;
                    userScrolledUp.value = false;

                    await nextTick();
                    scrollToBottom();

                    const assistantMessage = {
                        id: Date.now() + 1,
                        role: 'assistant',
                        content: '',
                        isStreaming: true,
                        created_at: new Date().toISOString()
                    };
                    chatMessages.value.push(assistantMessage);
                    const assistantIdx = chatMessages.value.length - 1;

                    try {
                        const response = await API.chat.sessions.send(currentChatSession.value.id, {
                            content: messageContent,
                            paper_ids: paperIds,
                            language: currentLang.value
                        });

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        if (data.type === 'progress') {
                                            chatProgress.value = {
                                                stage: data.stage,
                                                message: data.message,
                                                arxivId: data.arxiv_id,
                                                paperIndex: data.paper_index,
                                                totalPapers: data.total_papers,
                                                progress: data.progress,
                                                textLength: data.text_length,
                                                pageCount: data.page_count,
                                            };
                                            await nextTick();
                                            scrollToBottom();
                                        } else if (data.type === 'chunk') {
                                            chatProgress.value = null;
                                            chatMessages.value[assistantIdx].content += data.content;
                                            await nextTick();
                                            if (!userScrolledUp.value) {
                                                scrollToBottom();
                                            }
                                        } else if (data.type === 'error') {
                                            chatProgress.value = null;
                                            chatMessages.value[assistantIdx].content = `**错误**: ${data.message}`;
                                        } else if (data.type === 'done') {
                                            chatProgress.value = null;
                                            chatMessages.value[assistantIdx].isStreaming = false;
                                        }
                                    } catch (e) {}
                                }
                            }
                        }


                        fetchChatSessions();
                    } catch (e) {
                        ElementPlus.ElMessage.error('发送消息失败');
                        if (chatMessages.value[assistantIdx]) {
                            chatMessages.value[assistantIdx].content = '发送消息失败，请重试。';
                        }
                    } finally {
                        chatTyping.value = false;
                        chatProgress.value = null;
                        userScrolledUp.value = false;
                        if (chatMessages.value[assistantIdx]) {
                            chatMessages.value[assistantIdx].isStreaming = false;
                        }
                    }
                }

                function formatChatMessage(content, isStreaming = false) {
                    if (!content) return '';
                    
                    let processedContent = content;
                    
                    if (isStreaming) {
                        const codeBlockCount = (content.match(/```/g) || []).length;
                        if (codeBlockCount % 2 !== 0) {
                            processedContent += '\n```';
                        }
                    }
                    
                    if (typeof marked !== 'undefined') {
                        try {
                            return marked.parse(processedContent, {
                                breaks: true,
                                gfm: true,
                            });
                        } catch (e) {
                            return content
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/\n/g, '<br>');
                        }
                    }
                    return content
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/`(.*?)`/g, '<code style="background:#f5f5f5;padding:2px 6px;border-radius:4px;">$1</code>');
                }

                function formatDate(dateStr) {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString('zh-CN');
                }

                function formatChatTime(timeStr) {
                    if (!timeStr) return '';
                    const dateStr = timeStr.endsWith('Z') ? timeStr : timeStr + 'Z';
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diff = now - date;
                    if (diff < 60000) return currentLang.value === 'zh' ? '刚刚' : 'Just now';
                    if (diff < 3600000) return currentLang.value === 'zh' 
                        ? `${Math.floor(diff / 60000)} 分钟前` 
                        : `${Math.floor(diff / 60000)} min ago`;
                    if (diff < 86400000) return currentLang.value === 'zh' 
                        ? `${Math.floor(diff / 3600000)} 小时前` 
                        : `${Math.floor(diff / 3600000)} hr ago`;
                    return date.toLocaleDateString(currentLang.value === 'zh' ? 'zh-CN' : 'en-US');
                }

                function togglePaperSelection(paper) {
                    const idx = selectedChatPapers.value.findIndex(p => p.arxiv_id === paper.arxiv_id);
                    if (idx >= 0) {
                        selectedChatPapers.value.splice(idx, 1);
                    } else {
                        selectedChatPapers.value.push(paper);
                    }
                }

                function removeSelectedChatPaper(arxivId) {
                    const idx = selectedChatPapers.value.findIndex(p => p.arxiv_id === arxivId);
                    if (idx >= 0) {
                        selectedChatPapers.value.splice(idx, 1);
                    }
                }

                function addToCart(paper) {
                    if (!paperCart.value.some(p => p.arxiv_id === paper.arxiv_id)) {
                        paperCart.value.push(paper);
                        ElementPlus.ElMessage.success(t('basket.added'));
                    } else {
                        ElementPlus.ElMessage.info(t('basket.alreadyInCart'));
                    }
                }

                function removeFromCart(index) {
                    paperCart.value.splice(index, 1);
                }

                function removeFromCartByArxivId(arxivId) {
                    const idx = paperCart.value.findIndex(p => p.arxiv_id === arxivId);
                    if (idx >= 0) {
                        paperCart.value.splice(idx, 1);
                        ElementPlus.ElMessage.success(t('basket.removed'));
                    }
                }

                function clearCart() {
                    paperCart.value = [];
                    ElementPlus.ElMessage.success(t('basket.cleared'));
                }

                function isInCart(arxivId) {
                    return paperCart.value.some(p => p.arxiv_id === arxivId);
                }

                async function exportCart(format) {
                    if (paperCart.value.length === 0) return;
                    
                    const papersWithId = paperCart.value.filter(p => p.id);
                    const filename = `papers_export_${Date.now()}`;
                    
                    if (format === 'pdf') {
                        if (papersWithId.length === 0) {
                            ElementPlus.ElMessage.warning('PDF 导出需要论文已保存到数据库，请先同步论文');
                            return;
                        }
                        try {
                            const res = await API.export.papers({ 
                                paper_ids: papersWithId.map(p => p.id), 
                                format: 'pdf',
                                include_summary: true 
                            });
                            if (res.ok) {
                                const blob = await res.blob();
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `${filename}.pdf`;
                                a.click();
                                URL.revokeObjectURL(url);
                            } else {
                                ElementPlus.ElMessage.error('导出失败');
                            }
                        } catch (e) {
                            ElementPlus.ElMessage.error('导出失败');
                        }
                        return;
                    }
                    
                    if (format === 'pdf_original') {
                        ElementPlus.ElMessage.info(`开始下载 ${paperCart.value.length} 个 PDF 原文...`);
                        let successCount = 0;
                        for (const paper of paperCart.value) {
                            try {
                                const res = await API.papers.pdf(paper.arxiv_id);
                                if (res.ok) {
                                    const blob = await res.blob();
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    const safeId = paper.arxiv_id.replace(/[\/\\]/g, '_');
                                    a.download = `${safeId}.pdf`;
                                    a.click();
                                    URL.revokeObjectURL(url);
                                    successCount++;
                                    await new Promise(r => setTimeout(r, 300));
                                } else {
                                    console.error(`Failed to download ${paper.arxiv_id}: HTTP ${res.status}`);
                                }
                            } catch (e) {
                                console.error(`Failed to download ${paper.arxiv_id}:`, e);
                            }
                        }
                        if (successCount > 0) {
                            ElementPlus.ElMessage.success(`已下载 ${successCount} 个 PDF 原文`);
                        } else {
                            ElementPlus.ElMessage.error('下载失败');
                        }
                        return;
                    }
                    
                    let content = '';
                    
                    if (format === 'markdown') {
                        content = paperCart.value.map(p => {
                            return `## ${p.title}\n\n**arXiv:** ${p.arxiv_id}\n**作者:** ${p.authors?.map(a => a.name).join(', ') || 'N/A'}\n**日期:** ${p.published || 'N/A'}\n\n**摘要:**\n${p.abstract || ''}\n\n${p.summary_text ? '**AI 总结:**\n' + p.summary_text : ''}\n\n---\n`;
                        }).join('\n');
                        downloadFile(content, `${filename}.md`, 'text/markdown');
                    } else if (format === 'csv') {
                        const header = 'arxiv_id,title,authors,published,abstract\n';
                        const rows = paperCart.value.map(p => {
                            const title = (p.title || '').replace(/"/g, '""');
                            const authors = (p.authors?.map(a => a.name).join('; ') || '').replace(/"/g, '""');
                            const abstract = (p.abstract || '').replace(/"/g, '""').replace(/\n/g, ' ');
                            return `"${p.arxiv_id}","${title}","${authors}","${p.published || ''}","${abstract}"`;
                        }).join('\n');
                        downloadFile(header + rows, `${filename}.csv`, 'text/csv');
                    } else if (format === 'bibtex') {
                        content = paperCart.value.map(p => {
                            const year = p.published ? new Date(p.published).getFullYear() : new Date().getFullYear();
                            const firstAuthor = p.authors?.[0]?.name?.split(' ').pop() || 'Unknown';
                            const key = `${firstAuthor}${year}${p.arxiv_id.replace('.', '')}`;
                            return `@article{${key},\n  title={${p.title || 'Untitled'}},\n  author={${p.authors?.map(a => a.name).join(' and ') || 'Unknown'}},\n  journal={arXiv preprint arXiv:${p.arxiv_id}},\n  year={${year}},\n  eprint={${p.arxiv_id}}\n}`;
                        }).join('\n\n');
                        downloadFile(content, `${filename}.bib`, 'application/x-bibtex');
                    }
                }

                function addCartToCollection() {
                    if (paperCart.value.length === 0) return;
                    selectedPaper.value = null;
                    selectedCollectionId.value = null;
                    showAddToCollection.value = true;
                }

                function copyCartLinks() {
                    if (paperCart.value.length === 0) return;
                    const links = paperCart.value.map(p => `https://arxiv.org/abs/${p.arxiv_id}`).join('\n');
                    
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(links).then(() => {
                            ElementPlus.ElMessage.success(`已复制 ${paperCart.value.length} 个链接`);
                        }).catch(() => {
                            fallbackCopy(links);
                        });
                    } else {
                        fallbackCopy(links);
                    }
                    
                    function fallbackCopy(text) {
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed';
                        textarea.style.left = '-9999px';
                        document.body.appendChild(textarea);
                        textarea.select();
                        try {
                            document.execCommand('copy');
                            ElementPlus.ElMessage.success(`已复制 ${paperCart.value.length} 个链接`);
                        } catch (e) {
                            ElementPlus.ElMessage.error('复制失败，请手动复制');
                        }
                        document.body.removeChild(textarea);
                    }
                }

                function downloadFile(content, filename, mimeType) {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                onMounted(() => {
                    checkInitStatus();
                    fetchStats();
                    fetchFieldStats();
                    fetchCollections();
                    fetchSyncStatus();
                    fetchConfig();
                    
                    // Delay loading recent papers to let other content load first
                    setTimeout(() => {
                        fetchRecentCache();
                    }, 100);
                    
                    window.addEventListener('analyze-paper', (e) => {
                        const paper = e.detail;
                        if (!selectedChatPapers.value.some(p => p.arxiv_id === paper.arxiv_id)) {
                            selectedChatPapers.value.push(paper);
                        }
                        chatExpanded.value = true;
                        if (chatSessions.value.length === 0) {
                            fetchChatSessions();
                        }
                    });
                    
                    // Handle window resize - reset panel positions
                    window.addEventListener('resize', () => {
                        cartPosition.value = { 
                            x: Math.min(cartPosition.value.x, window.innerWidth - 420), 
                            y: Math.min(cartPosition.value.y, window.innerHeight - 200)
                        };
                        chatPosition.value = { 
                            x: Math.min(chatPosition.value.x, window.innerWidth - 500), 
                            y: Math.min(chatPosition.value.y, window.innerHeight - 200)
                        };
                    });
                    
                    // Handle ESC key to close panels
                    window.addEventListener('keydown', handleEscKey);
                });

                return {
                    configStore, paperStore, collectionStore, chatStore, uiStore,
                    showSetup, setupStep, setupConfig, initializing, testingAI, initLogs, initProgress,
                    initCurrentQuery, initTotalQueries, waitingMessage, initComplete,
                    showSettings, settingsConfig, savingSettings,
                    currentPage, stats, fieldStats, expandedGroups, recentPapers, searchResults, collections,
                    loadingRecent, updatingRecent, recentLogs, loadingProgress, loadingTotal, stopLoading,
                    recentDays, recentNeedSync, recentCategories,
                    categoryOptions, daysOptions, limitOptions, syncYearOptions, initYearOptions, syncYearsBackOptions, searchDaysOptions, aiLanguageOptions,
                    searching, searchQuery, searchDays, searchLogs,
                    syncStatus, syncing, syncLogs, syncYearsBack, syncForce,
                    syncStatusText, syncStatusClass, syncTimeClass, formatSyncTime,
                    cacheStats, cacheClearing, fetchCacheStats, clearCache,
                    recentCacheStatus, arxivCategories, allCategories,
                    showCreateCollection, showAddToCollection, showDeleteConfirm,
                    newCollection, editingCollection, deletingCollection,
                    savingCollection, deletingCollectionInProgress,
                    showMergeConfirmDialog, mergingFromCollection, mergingToCollection, mergingInProgress,
                    showMergeConfirm, mergePapers,
                    selectedCollectionId, selectedPaper, addingToCollection,
                    viewingCollection, showCollectionDetail, collectionPapers, loadingCollectionPapers,
                    collectionCurrentPage, collectionTotalCount, collectionTotalPages,
                    collectionPaperSearch, collectionSortBy, collectionSortOrder,
                    collectionSearchQuery, filteredCollections,
                    useAiSearch, aiSearching, performSearch, toggleSortOrder, collectionViewMode, openPaperUrl,
                    recentSelectedIds, recentSelectAll, searchSelectedIds, searchSelectAll,
                    homeQuery, homeSearching, homeLogs, homeResults, homeSelectedIds,
                    checkInitStatus, fetchCategories, testSetupAI, toggleSetupField, toggleCategoryGroup, startInitialSync,
                    testAIConnection, saveSettings, saveApiKey, toggleSettingsField, onLanguageChange,
                    fetchStats, fetchFieldStats, fetchRecentCache, updateRecentPapers, startSearch, fetchCollections,
                    getSelectedFieldsTooltip, hasSelectedFields,
                    fetchSyncStatus, startSync,
                    saveCollection, cancelCollectionDialog, openEditCollection,
                    confirmDeleteCollection, deleteCollection,
                    openCollectionDetail, loadCollectionPage, removePaperFromCollection,
                    addToCollection, confirmAddToCollection,
                    editCollection, duplicateCollection,
                    toggleRecentSelect, toggleRecentSelectAll, toggleSearchSelect, toggleSearchSelectAll,
                    exportRecent, exportSearch, exportCollection, exportCollectionWithId,
                    navigateTo, navigateToHome, onTabChange, startHomeSearch, toggleHomeSelect, exportHome,
                    chatExpanded, chatSessions, currentChatSession, chatMessages, chatInput, chatPosition, chatPanelRef, chatZIndex,
                    chatFullscreen, chatSize, chatAnimating,
                    selectedChatPapers, chatTyping, chatProgress, showChatSidebar,
                    chatUnreadCount, chatMessagesContainer,
                    toggleChat, fetchChatSessions, createNewChat, selectChatSession,
                    sendChatMessage, sendQuickPrompt, quickPrompts, formatChatMessage, formatChatTime, formatDate,
                    togglePaperSelection, removeSelectedChatPaper, deleteChatSession, clearAllChatSessions, userScrolledUp,
                    toggleChatFullscreen, startResizeChat,
                    paperCart, showCart, cartExportLoading, cartPosition, cartPanelRef, cartZIndex,
                    startDragCart, startDragChat,
                    addToCart, removeFromCart, removeFromCartByArxivId, clearCart, isInCart, exportCart,
                    addCartToCollection, copyCartLinks,
                    scrollToBottom, handleChatScroll,
                    bringToFront, handleEscKey,
                    t: configStore.t, currentLang, toggleLanguage, i18n, getFieldTranslation: configStore.getFieldTranslation,
                    // Field Selector
                    showFieldSelector, fieldSelectorSource, tempSelectedFields, fieldSearchQuery,
                    fieldSelectorExpanded, openFieldSelector, toggleFieldSelectorGroup, toggleTempField,
                    removeFromTempSelection, clearTempSelection, confirmFieldSelection, filteredCategories,
                    fieldAdvancedMode, advancedQueriesText, advancedQueriesLines, parsedCodeResult
                };
            }
        });

        app.component('paper-card', {
            props: ['paper', 'collections', 'inCollection', 'inCart'],
            emits: ['add-to-collection', 'remove-from-collection', 'download-card', 'analyze-paper', 'add-to-cart', 'remove-from-cart'],
            template: PaperCardTemplate,
            setup: PaperCardSetup
        });

        const pinia = createPinia();
        app.use(pinia);
        app.use(ElementPlus);
        if (window.ElementPlusIconsVue) {
            for (const [key, component] of Object.entries(window.ElementPlusIconsVue)) {
                app.component(key, component);
            }
        }
        app.mount('#app');
    </script>
</body>
</html>
